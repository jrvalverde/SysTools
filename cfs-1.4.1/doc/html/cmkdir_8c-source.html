<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>CFS: cmkdir.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.4 -->
<div class="qindex">  <form class="search" action="search.php" method="get">
<a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a>  | <span class="search"><u>S</u>earch&nbsp;for&nbsp;<input class="search" type="text" name="query" value="" size="20" accesskey="s"/></span></form></div>
<h1>cmkdir.c</h1><a href="cmkdir_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment"> * The author of this software is Matt Blaze.</span>
00003 <span class="comment"> *              Copyright (c) 1992, 1993, 1994, 1995, 1997 by AT&amp;T.</span>
00004 <span class="comment"> * Permission to use, copy, and modify this software without fee</span>
00005 <span class="comment"> * is hereby granted, provided that this entire notice is included in</span>
00006 <span class="comment"> * all copies of any software which is or includes a copy or</span>
00007 <span class="comment"> * modification of this software and in all copies of the supporting</span>
00008 <span class="comment"> * documentation for such software.</span>
00009 <span class="comment"> *</span>
00010 <span class="comment"> * This software is subject to United States export controls.</span>
00011 <span class="comment"> *</span>
00012 <span class="comment"> * THIS SOFTWARE IS BEING PROVIDED "AS IS", WITHOUT ANY EXPRESS OR IMPLIED</span>
00013 <span class="comment"> * WARRANTY.  IN PARTICULAR, NEITHER THE AUTHORS NOR AT&amp;T MAKE ANY</span>
00014 <span class="comment"> * REPRESENTATION OR WARRANTY OF ANY KIND CONCERNING THE MERCHANTABILITY</span>
00015 <span class="comment"> * OF THIS SOFTWARE OR ITS FITNESS FOR ANY PARTICULAR PURPOSE.</span>
00016 <span class="comment"> */</span>
00017 
00018 <span class="comment">/*</span>
00019 <span class="comment"> * client cfs mkdir - 1.4.0</span>
00020 <span class="comment"> */</span>
00021 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00022 <span class="preprocessor">#include &lt;rpc/rpc.h&gt;</span>
00023 <span class="preprocessor">#include &lt;sys/time.h&gt;</span>
00024 <span class="preprocessor">#include "nfsproto.h"</span>
00025 <span class="preprocessor">#include "admproto.h"</span>
00026 <span class="preprocessor">#include "<a class="code" href="cfs_8h.html">cfs.h</a>"</span>
00027 <span class="preprocessor">#include "<a class="code" href="shs_8h.html">shs.h</a>"</span>
00028 
00029 <a class="code" href="esm__gen_8c.html#a0">main</a>(argc,argv)
00030      <span class="keywordtype">int</span> argc;
<a name="l00031"></a><a class="code" href="cmkdir_8c.html#a0">00031</a>      <span class="keywordtype">char</span> **<a class="code" href="cattach_8c.html#a3">argv</a>;
00032 {
00033         <span class="keywordtype">char</span> *pw;
00034         <span class="keywordtype">char</span> pword[256];
00035         <span class="keywordtype">char</span> *<a class="code" href="getpass_8c.html#a2">getpassword</a>();
00036         <span class="keywordtype">int</span> <a class="code" href="shs_8c.html#a29">n</a>;
00037         cfs_admkey <a class="code" href="getpass_8c.html#a3">k</a>;
00038         <a class="code" href="structcfskey.html">cfskey</a> kt;
00039         <span class="keywordtype">char</span> path[1024];
00040         <span class="keywordtype">char</span> str[8];
00041         FILE *fp;
00042         <span class="keywordtype">char</span> *flg;
00043         <span class="keyword">struct </span>timeval tv;
00044         u_long r;
00045         <span class="keywordtype">int</span> i;
00046         <span class="keywordtype">int</span> ciph=CFS_THREE_DES;
00047         <span class="keywordtype">int</span> cfmt=1;
00048         <span class="keywordtype">int</span> smsize=<a class="code" href="cfs_8h.html#a17">LARGESMSIZE</a>;
00049         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> ekey[128];
00050         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> ek1[128];
00051         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="cfs__fh_8c.html#a14">l</a>;
00052         <span class="keywordtype">int</span> keycheck=1;
00053         
00054         <span class="keywordflow">while</span> (--argc &amp;&amp; (**++<a class="code" href="cattach_8c.html#a3">argv</a> == <span class="charliteral">'-'</span>)) {
00055                 <span class="keywordflow">for</span> (flg= ++*<a class="code" href="cattach_8c.html#a3">argv</a>; *flg; ++flg)
00056                         <span class="keywordflow">switch</span> (*flg) {
00057                             <span class="keywordflow">case</span> <span class="charliteral">'1'</span>:
00058                             <span class="keywordflow">case</span> <span class="charliteral">'d'</span>:
00059                                 ciph=CFS_STD_DES;
00060                                 <span class="keywordflow">break</span>;
00061                             <span class="keywordflow">case</span> <span class="charliteral">'2'</span>:
00062                                 ciph=CFS_THREE_DES;
00063                                 <span class="keywordflow">break</span>;
00064                             <span class="keywordflow">case</span> <span class="charliteral">'3'</span>:
00065                                 ciph=CFS_TRUE_THREE_DES;
00066                                 <span class="keywordflow">break</span>;
00067                             <span class="keywordflow">case</span> <span class="charliteral">'b'</span>:
00068                                 ciph=CFS_BLOWFISH;
00069                                 fprintf(stderr,
00070                                       <span class="stringliteral">"Warning: Blowfish is a new cipher.\n"</span>);
00071                                 <span class="keywordflow">break</span>;
00072                             <span class="keywordflow">case</span> <span class="charliteral">'m'</span>:
00073                                 ciph=CFS_MACGUFFIN;
00074                                 fprintf(stderr,
00075                                       <span class="stringliteral">"Warning: MacGuffin is a weak cipher\n"</span>);
00076                                 <span class="keywordflow">break</span>;
00077                             <span class="keywordflow">case</span> <span class="charliteral">'s'</span>:
00078                                 ciph=CFS_SAFER_SK128;
00079                                 fprintf(stderr,
00080                                       <span class="stringliteral">"Warning: SAFER is a new cipher.\n"</span>);
00081                                 <span class="keywordflow">break</span>;
00082                             <span class="keywordflow">case</span> <span class="charliteral">'o'</span>:
00083                                 cfmt=0;
00084                                 <span class="keywordflow">break</span>;
00085                             <span class="keywordflow">case</span> <span class="charliteral">'p'</span>:   <span class="comment">/* puny memory option */</span>
00086                                 smsize=<a class="code" href="cfs_8h.html#a18">SMALLSMSIZE</a>;
00087                                 <span class="keywordflow">break</span>;
00088                             <span class="keywordflow">case</span> <span class="charliteral">'-'</span>:
00089                                 keycheck=0;
00090                                 <span class="keywordflow">break</span>;
00091                             <span class="keywordflow">default</span>:
00092                                 fprintf(stderr,<span class="stringliteral">"usage: cmkdir [-123bdmosp-] dir\n"</span>);
00093                                 exit(1);
00094                         }
00095         }
00096         <span class="keywordflow">if</span> (argc!=1) {
00097                 fprintf(stderr,<span class="stringliteral">"Usage: cmkdir [-123bdmosp-] dir\n"</span>);
00098                 exit(1);
00099         }
00100         <span class="keywordflow">if</span> (keycheck) {
00101                 <span class="keywordflow">if</span> ((pw=<a class="code" href="getpass_8c.html#a2">getpassword</a>(<span class="stringliteral">"Key:"</span>))==NULL) {
00102                         fprintf(stderr,<span class="stringliteral">"Can't get key\n"</span>);
00103                         exit(1);
00104                 }
00105                 strcpy(pword,pw);
00106                 <span class="keywordflow">if</span> (strlen(pw)&lt;16) {
00107                         fprintf(stderr,<span class="stringliteral">"Key must be at least 16 chars.\n"</span>);
00108                         exit(1);
00109                 }
00110                 <span class="keywordflow">if</span> ((pw=<a class="code" href="getpass_8c.html#a2">getpassword</a>(<span class="stringliteral">"Again:"</span>))==NULL) {
00111                         fprintf(stderr,<span class="stringliteral">"Can't get key\n"</span>);
00112                         exit(1);
00113                 }
00114                 <span class="keywordflow">if</span> (strcmp(pword,pw)!=0) {
00115                      fprintf(stderr,
00116                         <span class="stringliteral">"Keys don't match; drink some coffee and try again\n"</span>);
00117                      exit(1);
00118                 }
00119         }
00120         <span class="keywordflow">else</span> { <span class="comment">/* just accept key from stdio */</span>
00121                 <span class="keywordflow">if</span> (fgets(pword,256,stdin) == NULL) {
00122                         perror(<span class="stringliteral">"cmkdir"</span>);
00123                         exit(1);
00124                 }
00125                 pw=pword;
00126                 pw[255]=<span class="charliteral">'\0'</span>;
00127                 <a class="code" href="shs_8c.html#a29">n</a>=strlen(pw);
00128                 <span class="keywordflow">if</span> ((<a class="code" href="shs_8c.html#a29">n</a>&gt;0) &amp;&amp; (pw[<a class="code" href="shs_8c.html#a29">n</a>-1] == <span class="charliteral">'\n'</span>))
00129                         pw[<a class="code" href="shs_8c.html#a29">n</a>-1] = <span class="charliteral">'\0'</span>;
00130         }
00131         <span class="keywordflow">if</span> (smsize != <a class="code" href="cfs_8h.html#a17">LARGESMSIZE</a>)
00132                 sprintf(pw,<span class="stringliteral">"%s%d"</span>,pword,smsize);
00133         <a class="code" href="getpass_8c.html#a3">k</a>.cipher=ciph;
00134         <span class="keywordflow">if</span> (cfmt==0) { 
00135                 <span class="keywordflow">if</span> (old_pwcrunch(pw,&amp;<a class="code" href="getpass_8c.html#a3">k</a>)!=0) {
00136                         fprintf(stderr,<span class="stringliteral">"Invalid key\n"</span>);
00137                         exit(1);
00138                 }
00139         } <span class="keywordflow">else</span> {
00140                 <span class="comment">/* this is very ugly and will be replaced but it works */</span>
00141                 <span class="keywordflow">if</span> (new_pwcrunch(pw,&amp;<a class="code" href="getpass_8c.html#a3">k</a>)!=0) {
00142                         fprintf(stderr,<span class="stringliteral">"Invalid key\n"</span>);
00143                         exit(1);
00144                 }
00145                 <span class="comment">/* now we xor in some truerand bytes for good measure */</span>
00146                 bcopy(&amp;<a class="code" href="getpass_8c.html#a3">k</a>,ekey,32);  <span class="comment">/* assumes key material &lt; 32 bytes */</span>
00147                 <span class="keywordflow">for</span> (i=0; i&lt;32; i++) {
00148                         ekey[i] ^= randbyte(); 
00149                 }
00150                 encrypt_key(&amp;<a class="code" href="getpass_8c.html#a3">k</a>,ekey);
00151                 bcopy(ekey,ek1,32);
00152                 decrypt_key(&amp;<a class="code" href="getpass_8c.html#a3">k</a>,ek1);
00153                 <span class="comment">/* new &amp;k is our real key */</span>
00154         }
00155         <span class="keywordflow">if</span> (mkdir(<a class="code" href="cattach_8c.html#a3">argv</a>[0],0777)&lt;0) {
00156                 perror(<span class="stringliteral">"cmkdir"</span>);
00157                 exit(1);
00158         }
00159         sprintf(path,<span class="stringliteral">"%s/..."</span>,<a class="code" href="cattach_8c.html#a3">argv</a>[0]);
00160         strcpy(str,<span class="stringliteral">"qua!"</span>);
00161         <span class="comment">/* now randomize the end of str.. */</span>
00162         r = trand32();
00163         <span class="keywordflow">for</span> (i=0; i&lt;4; i++)
00164                 str[i+4]=(r&lt;&lt;(i*8))&amp;0377;
00165         copykey(&amp;<a class="code" href="getpass_8c.html#a3">k</a>,&amp;kt);
00166         <a class="code" href="cfs__cipher_8c.html#a3">cipher</a>(&amp;kt,str,0);
00167         mask_cipher(&amp;kt,str,1);
00168         <a class="code" href="cfs__cipher_8c.html#a3">cipher</a>(&amp;kt,str,0);
00169         <span class="keywordflow">if</span> ((fp=fopen(path,<span class="stringliteral">"w"</span>)) == NULL) {
00170                 perror(<span class="stringliteral">"cmkdir"</span>);
00171                 exit(1);
00172         }
00173         fwrite(str,8,1,fp);
00174         fclose(fp);
00175         sprintf(path,<span class="stringliteral">"%s/..c"</span>,<a class="code" href="cattach_8c.html#a3">argv</a>[0]);
00176         <span class="keywordflow">if</span> ((fp=fopen(path,<span class="stringliteral">"w"</span>)) == NULL) {
00177                 perror(<span class="stringliteral">"cmkdir"</span>);
00178                 exit(1);
00179         }
00180         fprintf(fp,<span class="stringliteral">"%d"</span>,<a class="code" href="getpass_8c.html#a3">k</a>.cipher);
00181         fclose(fp);
00182         sprintf(path,<span class="stringliteral">"%s/..s"</span>,<a class="code" href="cattach_8c.html#a3">argv</a>[0]);
00183         <span class="keywordflow">if</span> ((fp=fopen(path,<span class="stringliteral">"w"</span>)) == NULL) {
00184                 perror(<span class="stringliteral">"cmkdir"</span>);
00185                 exit(1);
00186         }
00187         fprintf(fp,<span class="stringliteral">"%d\n"</span>,smsize);
00188         fclose(fp);
00189         <span class="keywordflow">if</span> (cfmt) {
00190                 sprintf(path,<span class="stringliteral">"%s/..k"</span>,<a class="code" href="cattach_8c.html#a3">argv</a>[0]);
00191                 <span class="keywordflow">if</span> ((fp=fopen(path,<span class="stringliteral">"w"</span>)) == NULL) {
00192                         perror(<span class="stringliteral">"cmkdir"</span>);
00193                         exit(1);
00194                 }
00195                 fwrite(ekey,32,1,fp);
00196                 fclose(fp);
00197         }
00198         exit(0);
00199 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Tue Jun 15 09:59:03 2004 for CFS by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.4 </small></address>
</body>
</html>
