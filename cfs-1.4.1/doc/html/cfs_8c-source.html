<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>CFS: cfs.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.4 -->
<div class="qindex">  <form class="search" action="search.php" method="get">
<a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a>  | <span class="search"><u>S</u>earch&nbsp;for&nbsp;<input class="search" type="text" name="query" value="" size="20" accesskey="s"/></span></form></div>
<h1>cfs.c</h1><a href="cfs_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment"> * The author of this software is Matt Blaze.</span>
00003 <span class="comment"> *              Copyright (c) 1992, 1993, 1994, 1997 by AT&amp;T.</span>
00004 <span class="comment"> * Permission to use, copy, and modify this software without fee</span>
00005 <span class="comment"> * is hereby granted, provided that this entire notice is included in</span>
00006 <span class="comment"> * all copies of any software which is or includes a copy or</span>
00007 <span class="comment"> * modification of this software and in all copies of the supporting</span>
00008 <span class="comment"> * documentation for such software.</span>
00009 <span class="comment"> *</span>
00010 <span class="comment"> * This software is subject to United States export controls.</span>
00011 <span class="comment"> *</span>
00012 <span class="comment"> * THIS SOFTWARE IS BEING PROVIDED "AS IS", WITHOUT ANY EXPRESS OR IMPLIED</span>
00013 <span class="comment"> * WARRANTY.  IN PARTICULAR, NEITHER THE AUTHORS NOR AT&amp;T MAKE ANY</span>
00014 <span class="comment"> * REPRESENTATION OR WARRANTY OF ANY KIND CONCERNING THE MERCHANTABILITY</span>
00015 <span class="comment"> * OF THIS SOFTWARE OR ITS FITNESS FOR ANY PARTICULAR PURPOSE.</span>
00016 <span class="comment"> */</span>
00017 
00018 <span class="comment">/*</span>
00019 <span class="comment"> * Crypto file system</span>
00020 <span class="comment"> *  main 1.4</span>
00021 <span class="comment"> * mab - 11/30/92</span>
00022 <span class="comment"> * mab - 01/11/94</span>
00023 <span class="comment"> * mab - 11/10/94</span>
00024 <span class="comment"> * mab - 11/97</span>
00025 <span class="comment"> */</span>
00026 
00027 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00028 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
00029 <span class="preprocessor">#include &lt;sys/file.h&gt;</span>
00030 <span class="preprocessor">#include &lt;sys/socket.h&gt;</span>
00031 <span class="comment">/* #include &lt;netinet/in.h&gt; */</span>
00032 <span class="comment">/* #include &lt;arpa/inet.h&gt; */</span>
00033 <span class="preprocessor">#include &lt;netdb.h&gt;</span>
00034 <span class="preprocessor">#include &lt;rpc/rpc.h&gt;</span>
00035 <span class="preprocessor">#include &lt;sys/time.h&gt;</span>
00036 <span class="preprocessor">#ifndef NORLIMITS</span>
00037 <span class="preprocessor"></span><span class="preprocessor">#include &lt;sys/resource.h&gt;</span>
00038 <span class="preprocessor">#endif</span>
00039 <span class="preprocessor"></span><span class="preprocessor">#include &lt;signal.h&gt;</span>
00040 <span class="preprocessor">#include "nfsproto.h"</span>
00041 <span class="preprocessor">#include "admproto.h"</span>
00042 <span class="preprocessor">#include "<a class="code" href="cfs_8h.html">cfs.h</a>"</span>
00043 
<a name="l00044"></a><a class="code" href="cfs_8c.html#a0">00044</a> <span class="keyword">struct </span>in_addr <a class="code" href="ccat_8c.html#a0">validhost</a>;
00045 
00046 <span class="preprocessor">#if defined(SOLARIS2X) || defined(__NetBSD__)</span>
00047 <span class="preprocessor"></span><span class="keywordtype">void</span> <a class="code" href="cfs_8c.html#a4">nfs_program_2</a>();
00048 <span class="keywordtype">void</span> <a class="code" href="cfs_8c.html#a5">adm_program_2</a>();
00049 <span class="preprocessor">#include &lt;string.h&gt;</span>
00050 <span class="preprocessor">#else</span>
00051 <span class="preprocessor"></span><span class="keywordtype">int</span> <a class="code" href="cfs_8c.html#a4">nfs_program_2</a>();
00052 <span class="keywordtype">int</span> <a class="code" href="cfs_8c.html#a5">adm_program_2</a>();
00053 <span class="preprocessor">#endif</span>
00054 <span class="preprocessor"></span><span class="preprocessor">#ifdef __NetBSD__</span>
00055 <span class="preprocessor"></span><span class="keywordtype">int</span> _rpcsvcdirty;
00056 <span class="preprocessor">#endif</span>
00057 <span class="preprocessor"></span>
00058 <span class="preprocessor">#ifdef  DEBUG</span>
00059 <span class="preprocessor"></span><span class="keywordtype">int</span> _rpcpmstart = 0;
00060 <span class="preprocessor">#endif</span>
00061 <span class="preprocessor"></span>
00062 <span class="keywordtype">void</span> <a class="code" href="cfs_8c.html#a6">grimreap</a>();
00063 
<a name="l00064"></a><a class="code" href="cfs_8c.html#a1">00064</a> <span class="keywordtype">char</span> <a class="code" href="ccat_8c.html#a1">zerovect</a>[]={0,0,0,0,0,0,0,0,0};
<a name="l00065"></a><a class="code" href="cfs_8c.html#a2">00065</a> <span class="keywordtype">int</span> <a class="code" href="ccat_8c.html#a2">cursecs</a>;
00066 
00067 <a class="code" href="esm__gen_8c.html#a0">main</a>(argc,argv)
00068      <span class="keywordtype">int</span> argc;
<a name="l00069"></a><a class="code" href="cfs_8c.html#a3">00069</a>      <span class="keywordtype">char</span> **<a class="code" href="cattach_8c.html#a3">argv</a>;
00070 {
00071         <span class="keywordtype">int</span> port=<a class="code" href="cfs_8h.html#a4">CFS_PORT</a>;
00072 
00073         <span class="keyword">struct </span>timeval tv;
00074         <span class="keyword">struct </span>hostent *hp;
00075         <span class="keyword">struct </span>sockaddr_in sin;
00076         <span class="keywordtype">int</span> svrsock;
00077         SVCXPRT *tp;
00078         <span class="keywordtype">int</span> pid;
00079 <span class="preprocessor">#ifdef SOLARIS2X</span>
00080 <span class="preprocessor"></span>        <span class="keyword">struct </span>netconfig *nc;
00081         <span class="keyword">struct </span>t_bind tbind, *tres;
00082         <span class="keyword">struct </span>t_info tinfo;
00083 <span class="preprocessor">#endif</span>
00084 <span class="preprocessor"></span>
00085         <span class="comment">/* create the right kind of socket */</span>
00086         <span class="keywordflow">if</span> (argc &gt; 2) {
00087                 fprintf(stderr,<span class="stringliteral">"Usage: cfsd [port]\n"</span>);
00088                 exit(1);
00089         }
00090         <span class="keywordflow">if</span> (argc==2) {
00091                 <span class="keywordflow">if</span> ((port=atoi(<a class="code" href="cattach_8c.html#a3">argv</a>[1]))&lt;=0) {
00092                         fprintf(stderr,<span class="stringliteral">"Usage: cfsd [port]\n"</span>);
00093                         exit(1);
00094                 }
00095         }
00096         <span class="keywordflow">if</span> ((hp=gethostbyname(<span class="stringliteral">"localhost"</span>))==NULL) {
00097                 fprintf(stderr,<span class="stringliteral">"Can't deal with localhost\n"</span>);
00098                 exit(1);
00099         }
00100         bzero((<span class="keywordtype">char</span> *)&amp;sin,<span class="keyword">sizeof</span>(sin));
00101         sin.sin_family=AF_INET;
00102         bcopy((<span class="keywordtype">char</span> *)hp-&gt;h_addr,(<span class="keywordtype">char</span> *)&amp;sin.sin_addr,hp-&gt;h_length);
00103         <span class="comment">/* sin.sin_addr = inet_makeaddr(INADDR_ANY,np);*/</span>
00104         <a class="code" href="ccat_8c.html#a0">validhost</a>.s_addr=sin.sin_addr.s_addr;
00105         sin.sin_port = htons(port);
00106 
00107 <span class="preprocessor">#ifdef SOLARIS2X</span>
00108 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ((nc = getnetconfigent(<span class="stringliteral">"udp"</span>)) == NULL) {
00109                 nc_perror(<span class="stringliteral">"udp"</span>);
00110                 exit(1);
00111         }
00112 
00113         <span class="keywordflow">if</span> ((svrsock = t_open(nc-&gt;nc_device, O_RDWR, &amp;tinfo)) &lt; 0) {
00114                 t_error(<span class="stringliteral">"Can't t_open UDP device"</span>);
00115                 exit(1);
00116         }
00117 
00118         <span class="keywordflow">if</span> ((tres = (<span class="keyword">struct </span>t_bind *)t_alloc(svrsock, T_BIND, T_ADDR)) == NULL){
00119                 t_error(<span class="stringliteral">"Can't t_alloc buffer"</span>);
00120                 exit(1);
00121         }
00122 
00123         tbind.qlen = 0;
00124         tbind.addr.buf = (<span class="keywordtype">char</span> *)&amp;sin;
00125         tbind.addr.len = tbind.addr.maxlen = tinfo.addr;
00126 
00127         <span class="keywordflow">if</span> (t_bind(svrsock, &amp;tbind, tres) != 0) {
00128                 t_error(<span class="stringliteral">"t_bind"</span>);
00129                 exit(1);
00130         }
00131 
00132         <span class="keywordflow">if</span> (tbind.addr.len != tres-&gt;addr.len ||
00133             memcmp(tbind.addr.buf, tres-&gt;addr.buf, tres-&gt;addr.len) != 0) {
00134                 <span class="comment">/* bound address does not match requested one */</span>
00135                 fprintf(stderr,
00136 <span class="stringliteral">"t_bind did not bind to requested address (is another cfsd running?)\n"</span>);
00137                 exit(1);
00138         }
00139 
00140         <span class="keywordflow">if</span> ((tp = svc_dg_create(svrsock, 0, 0)) == NULL) {
00141                 fprintf(stderr,<span class="stringliteral">"Can't create UDP RPC Service\n"</span>);
00142                 exit(1);
00143         }
00144 
00145         <span class="comment">/* Assign the local bind address and type of service */</span>
00146         tp-&gt;xp_ltaddr = tres-&gt;addr;
00147         tp-&gt;xp_type = tinfo.servtype;
00148         tp-&gt;xp_rtaddr.len = 0;
00149         tp-&gt;xp_rtaddr.maxlen = tres-&gt;addr.maxlen;
00150         tp-&gt;xp_netid = strdup(nc-&gt;nc_netid);
00151         tp-&gt;xp_tp = strdup(nc-&gt;nc_device);
00152 
00153         <span class="keywordflow">if</span> ((tp-&gt;xp_rtaddr.buf = malloc(tp-&gt;xp_rtaddr.maxlen)) == NULL) {
00154                 fprintf(stderr, <span class="stringliteral">"Can't malloc buffer space\n"</span>);
00155                 exit(1);
00156         }
00157 
00158         <span class="comment">/* now register w/ the local dispatcher */</span>
00159         <span class="comment">/*  don't register nfs w/ portmaper, tho */</span>
00160         <span class="keywordflow">if</span> (!svc_reg(tp, NFS_PROGRAM, NFS_VERSION, <a class="code" href="cfs_8c.html#a4">nfs_program_2</a>,
00161                         (port==2049? nc : NULL))) {
00162                 fprintf(stderr,<span class="stringliteral">"Can't register CFS NFS\n"</span>);
00163                 exit(1);
00164         }
00165         <span class="keywordflow">if</span> (!rpcb_unset(ADM_PROGRAM, ADM_VERSION, nc)) {
00166                 fprintf(stderr, <span class="stringliteral">"Can't init CFS ADM rpcbind mapping\n"</span>);
00167                 exit(1);
00168         }
00169         <span class="keywordflow">if</span> (!svc_reg(tp, ADM_PROGRAM, ADM_VERSION, <a class="code" href="cfs_8c.html#a5">adm_program_2</a>, nc)) {
00170                 fprintf(stderr,<span class="stringliteral">"Can't register CFS ADM\n"</span>);
00171                 exit(1);
00172         }
00173 <span class="preprocessor">#else</span>
00174 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ((svrsock=socket(AF_INET,SOCK_DGRAM,0)) &lt; 0) {
00175                 perror(<span class="stringliteral">"socket"</span>);
00176                 exit(1);
00177         }
00178 
00179         <span class="keywordflow">if</span> (bind(svrsock,(<span class="keyword">struct</span> sockaddr *)&amp;sin,<span class="keyword">sizeof</span>(sin)) != 0) {
00180                 perror(<span class="stringliteral">"bind"</span>);
00181                 exit(1);
00182         }
00183 
00184         <span class="keywordflow">if</span> ((tp = svcudp_create(svrsock)) == NULL) {
00185                 fprintf(stderr,<span class="stringliteral">"Can't create UDP RPC Service\n"</span>);
00186                 exit(1);
00187         }
00188         
00189         <span class="comment">/* now register w/ the local dispatcher */</span>
00190         <span class="comment">/* don't register nfs w/ portmaper, tho, in case */</span>
00191         <span class="comment">/* a real nfsd is already running */</span>
00192         <span class="keywordflow">if</span> (!svc_register(tp,NFS_PROGRAM,NFS_VERSION,<a class="code" href="cfs_8c.html#a4">nfs_program_2</a>,
00193                         (port==2049?IPPROTO_UDP:0))) {
00194                 fprintf(stderr,<span class="stringliteral">"Can't register CFS NFS\n"</span>);
00195                 exit(1);
00196         }
00197         pmap_unset(ADM_PROGRAM,ADM_VERSION);
00198         <span class="keywordflow">if</span> (!svc_register(tp,ADM_PROGRAM,ADM_VERSION,<a class="code" href="cfs_8c.html#a5">adm_program_2</a>,
00199                           IPPROTO_UDP)) {
00200                 fprintf(stderr,<span class="stringliteral">"Can't register CFS ADM\n"</span>);
00201                 exit(1);
00202         }
00203 <span class="preprocessor">#endif</span>
00204 <span class="preprocessor"></span>
00205 <span class="preprocessor">#ifndef DEBUG</span>
00206 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ((pid=fork())!=0) {
00207                 <span class="keywordflow">if</span> (pid&lt;0) {
00208                         perror(<span class="stringliteral">"cfsd: fork\n"</span>);
00209                         exit(1);
00210                 }
00211                 fprintf(stderr,<span class="stringliteral">"cfs ready\n"</span>,pid);
00212                 printf(<span class="stringliteral">"%d\n"</span>,pid);
00213                 exit(0);
00214         }
00215 <span class="preprocessor">#else</span>
00216 <span class="preprocessor"></span>        printf(<span class="stringliteral">"cfs running DEBUG (%d)\n"</span>, getpid());
00217 <span class="preprocessor">#endif</span>
00218 <span class="preprocessor"></span>        initstuff();
00219         <span class="comment">/* and lauch the timeout handler (which we have to do in child) */</span>
00220         gettimeofday(&amp;tv,NULL);
00221         <a class="code" href="ccat_8c.html#a2">cursecs</a>=tv.tv_sec;
00222         signal(SIGALRM,<a class="code" href="cfs_8c.html#a6">grimreap</a>);
00223         alarm(60); <span class="comment">/* every 60 secs */</span>
00224 
00225         svc_run(); <span class="comment">/* do it */</span>
00226         fprintf(stderr,<span class="stringliteral">"Huh??  Where the hell am I?\n"</span>);
00227         exit(1);
00228 }
00229 
00230 initstuff()
00231 {
00232         <span class="keywordtype">int</span> i;
00233         <span class="keyword">static</span> <a class="code" href="structinstance.html">instance</a> ina,inb;
00234 <span class="preprocessor">#ifndef NORLIMITS</span>
00235 <span class="preprocessor"></span>        <span class="keyword">struct </span>rlimit rl;
00236 <span class="preprocessor">#endif</span>
00237 <span class="preprocessor"></span>        
00238         <span class="comment">/* first set uid to 0, if we can */</span>
00239         <span class="comment">/* now we can go back and forth easily */</span>
00240         setuid(0);
00241         umask(0);
00242 
00243 <span class="preprocessor">#if defined(__NetBSD__) || defined(__bsdi__)</span>
00244 <span class="preprocessor"></span><span class="preprocessor">#ifndef DEBUG</span>
00245 <span class="preprocessor"></span>        <span class="comment">/* detach from terminal */</span>
00246         daemon(0,0);
00247 <span class="preprocessor">#endif </span><span class="comment">/* DEBUG */</span>
00248 <span class="preprocessor">#endif </span><span class="comment">/* __NetBSD__ */</span>
00249 
00250 <span class="preprocessor">#ifndef NORLIMITS</span>
00251 <span class="preprocessor"></span>        <span class="comment">/* try to make sure we don't spill a corefile */</span>
00252         rl.rlim_cur=0;
00253         rl.rlim_max=0;
00254         setrlimit(RLIMIT_CORE,&amp;rl);
00255 <span class="preprocessor">#else   </span>
00256 <span class="preprocessor"></span>        <span class="comment">/* set signal handlers */</span>
00257         <span class="comment">/* for things that can dump core */</span>
00258         signal(SIGQUIT,SIG_IGN);
00259         signal(SIGILL,SIG_IGN);
00260         signal(SIGTRAP,SIG_IGN);
00261         signal(SIGABRT,SIG_IGN);
00262         signal(SIGEMT,SIG_IGN);
00263         signal(SIGFPE,SIG_IGN);
00264         signal(SIGBUS,SIG_IGN);
00265         signal(SIGSEGV,SIG_IGN);
00266         signal(SIGSYS,SIG_IGN);
00267 <span class="preprocessor">#ifdef SIGLOST</span>
00268 <span class="preprocessor"></span>        signal(SIGLOST,SIG_IGN);
00269 <span class="preprocessor">#endif</span>
00270 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00271 <span class="preprocessor"></span>        <span class="comment">/* clear out the instances table */</span>
00272         <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="cfs_8h.html#a5">NINSTANCES</a>; i++)
00273                 <a class="code" href="cfs_8h.html#a35">instances</a>[i]=NULL;
00274 }
00275 
00276 <span class="comment">/* look for instances to kill */</span>
00277 <span class="keywordtype">void</span> <a class="code" href="cfs_8c.html#a6">grimreap</a>()
00278 {
00279         <span class="keyword">struct </span>timeval tv;
00280         <span class="keywordtype">int</span> i;
00281 
00282         gettimeofday(&amp;tv,NULL);
00283         <a class="code" href="ccat_8c.html#a2">cursecs</a>=tv.tv_sec;
00284 <span class="preprocessor">#ifdef DEBUG</span>
00285 <span class="preprocessor"></span>        fprintf(stderr,<span class="stringliteral">"grimly reaping\n"</span>);
00286 <span class="preprocessor">#endif</span>
00287 <span class="preprocessor"></span>        <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="cfs_8h.html#a5">NINSTANCES</a>; i++)
00288                 <span class="keywordflow">if</span> (<a class="code" href="cfs_8h.html#a35">instances</a>[i] != NULL) {
00289                         <span class="keywordflow">if</span> (<a class="code" href="cfs_8h.html#a35">instances</a>[i]-&gt;<a class="code" href="structinstance.html#o12">dead</a> &gt; 4)
00290                                 freeinstance(i);
00291                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((<a class="code" href="cfs_8h.html#a35">instances</a>[i]-&gt;<a class="code" href="structinstance.html#o9">timeout</a>)
00292                             &amp;&amp; (<a class="code" href="cfs_8h.html#a35">instances</a>[i]-&gt;<a class="code" href="structinstance.html#o9">timeout</a> &lt; <a class="code" href="ccat_8c.html#a2">cursecs</a>))
00293                                         <a class="code" href="cfs_8h.html#a35">instances</a>[i]-&gt;<a class="code" href="structinstance.html#o12">dead</a>++;
00294                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> ((<a class="code" href="cfs_8h.html#a35">instances</a>[i]-&gt;<a class="code" href="structinstance.html#o10">idle</a>)
00295                             &amp;&amp; ((<a class="code" href="cfs_8h.html#a35">instances</a>[i]-&gt;<a class="code" href="structinstance.html#o11">access</a> + <a class="code" href="cfs_8h.html#a35">instances</a>[i]-&gt;<a class="code" href="structinstance.html#o10">idle</a>)
00296                                 &lt; <a class="code" href="ccat_8c.html#a2">cursecs</a>))
00297                                         <a class="code" href="cfs_8h.html#a35">instances</a>[i]-&gt;<a class="code" href="structinstance.html#o12">dead</a>++;
00298                 }
00299         signal(SIGALRM,grimreap);
00300         alarm(60);
00301 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Tue Jun 15 09:59:03 2004 for CFS by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.4 </small></address>
</body>
</html>
