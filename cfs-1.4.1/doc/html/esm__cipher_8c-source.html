<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>CFS: esm_cipher.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.4 -->
<div class="qindex">  <form class="search" action="search.php" method="get">
<a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a>  | <span class="search"><u>S</u>earch&nbsp;for&nbsp;<input class="search" type="text" name="query" value="" size="20" accesskey="s"/></span></form></div>
<h1>esm_cipher.c</h1><a href="esm__cipher_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment"> * ESM crypto interface</span>
00003 <span class="comment"> * v0.6</span>
00004 <span class="comment"> */</span>
00005 
00006 <span class="comment">/*</span>
00007 <span class="comment"> * The author of this software is Matt Blaze.</span>
00008 <span class="comment"> *              Copyright (c) 1995 by AT&amp;T.</span>
00009 <span class="comment"> * Permission to use, copy, and modify this software without fee</span>
00010 <span class="comment"> * is hereby granted, provided that this entire notice is included in</span>
00011 <span class="comment"> * all copies of any software which is or includes a copy or</span>
00012 <span class="comment"> * modification of this software and in all copies of the supporting</span>
00013 <span class="comment"> * documentation for such software.</span>
00014 <span class="comment"> *</span>
00015 <span class="comment"> * This software is subject to United States export controls.</span>
00016 <span class="comment"> *</span>
00017 <span class="comment"> * THIS SOFTWARE IS BEING PROVIDED "AS IS", WITHOUT ANY EXPRESS OR IMPLIED</span>
00018 <span class="comment"> * WARRANTY.  IN PARTICULAR, NEITHER THE AUTHORS NOR AT&amp;T MAKE ANY</span>
00019 <span class="comment"> * REPRESENTATION OR WARRANTY OF ANY KIND CONCERNING THE MERCHANTABILITY</span>
00020 <span class="comment"> * OF THIS SOFTWARE OR ITS FITNESS FOR ANY PARTICULAR PURPOSE.</span>
00021 <span class="comment"> */</span>
00022 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00023 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
00024 <span class="preprocessor">#include &lt;sys/time.h&gt;</span>
00025 <span class="preprocessor">#include &lt;signal.h&gt;</span>
00026 <span class="preprocessor">#include "global.h"</span>
00027 <span class="preprocessor">#include "rsaref.h"</span>
00028 <span class="preprocessor">#include "<a class="code" href="esm_8h.html">esm.h</a>"</span>
00029 
<a name="l00030"></a><a class="code" href="esm__cipher_8c.html#a8">00030</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="cfs__fh_8c.html#a33">check</a>[8];
00031 
<a name="l00032"></a><a class="code" href="esm__cipher_8c.html#a9">00032</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="esm__cipher_8c.html#a9">skey1</a>[8];
<a name="l00033"></a><a class="code" href="esm__cipher_8c.html#a10">00033</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="esm__cipher_8c.html#a10">skey2</a>[8];
<a name="l00034"></a><a class="code" href="esm__cipher_8c.html#a11">00034</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="esm__cipher_8c.html#a11">skey3</a>[8];
<a name="l00035"></a><a class="code" href="esm__cipher_8c.html#a12">00035</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="esm__cipher_8c.html#a12">mkey1</a>[8];
<a name="l00036"></a><a class="code" href="esm__cipher_8c.html#a13">00036</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="esm__cipher_8c.html#a13">mkey2</a>[8];
<a name="l00037"></a><a class="code" href="esm__cipher_8c.html#a14">00037</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="esm__cipher_8c.html#a14">mkey3</a>[8];
<a name="l00038"></a><a class="code" href="esm__cipher_8c.html#a15">00038</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="esm_8h.html#a8">ivin</a>[8];
<a name="l00039"></a><a class="code" href="esm__cipher_8c.html#a16">00039</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="esm_8h.html#a9">ivout</a>[8];
00040 
<a name="l00041"></a><a class="code" href="esm__cipher_8c.html#a17">00041</a> R_RANDOM_STRUCT <a class="code" href="esm_8h.html#a6">rs</a>;
00042 
<a name="l00043"></a><a class="code" href="esm__cipher_8c.html#a18">00043</a> R_DH_PARAMS <a class="code" href="dhparams_8c.html#a6">dhparams</a>[3];
00044 
<a name="l00045"></a><a class="code" href="esm__cipher_8c.html#a19">00045</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="esm_8h.html#a10">otherpub</a>[<a class="code" href="esm_8h.html#a3">MAXPUBKEY</a>+2];
<a name="l00046"></a><a class="code" href="esm__cipher_8c.html#a20">00046</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="esm_8h.html#a11">ourpub</a>[<a class="code" href="esm_8h.html#a3">MAXPUBKEY</a>+2];
<a name="l00047"></a><a class="code" href="esm__cipher_8c.html#a21">00047</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="esm_8h.html#a12">ourpriv</a>[<a class="code" href="esm_8h.html#a3">MAXPUBKEY</a>];
<a name="l00048"></a><a class="code" href="esm__cipher_8c.html#a22">00048</a> <span class="keywordtype">int</span> <a class="code" href="esm_8h.html#a13">ourprivlen</a>;
<a name="l00049"></a><a class="code" href="esm__cipher_8c.html#a23">00049</a> <span class="keywordtype">int</span> <a class="code" href="esm_8h.html#a14">pklen</a>;
00050 
<a name="l00051"></a><a class="code" href="esm__cipher_8c.html#a25">00051</a> <a class="code" href="structkeystr.html">keystr</a> <a class="code" href="esm__cipher_8c.html#a24">inks</a>, <a class="code" href="esm__cipher_8c.html#a25">outks</a>;
00052 
00053 <a class="code" href="esm__cipher_8c.html#a32">cipherinit</a>(master)
00054      <span class="keywordtype">int</span> <a class="code" href="esm_8c.html#a24">master</a>;
00055 {
00056         <span class="keywordflow">if</span> (<a class="code" href="esm_8c.html#a24">master</a>) {
00057                 <a class="code" href="cfs__des_8c.html#a63">des_key_setup</a>(<a class="code" href="esm__cipher_8c.html#a9">skey1</a>,<a class="code" href="esm__cipher_8c.html#a24">inks</a>.<a class="code" href="structkeystr.html#o0">ek1</a>);
00058                 <a class="code" href="cfs__des_8c.html#a63">des_key_setup</a>(<a class="code" href="esm__cipher_8c.html#a10">skey2</a>,<a class="code" href="esm__cipher_8c.html#a24">inks</a>.<a class="code" href="structkeystr.html#o1">ek2</a>);
00059                 <a class="code" href="cfs__des_8c.html#a63">des_key_setup</a>(<a class="code" href="esm__cipher_8c.html#a11">skey3</a>,<a class="code" href="esm__cipher_8c.html#a24">inks</a>.<a class="code" href="structkeystr.html#o2">ek3</a>);
00060                 <a class="code" href="cfs__des_8c.html#a63">des_key_setup</a>(<a class="code" href="esm__cipher_8c.html#a12">mkey1</a>,<a class="code" href="esm__cipher_8c.html#a25">outks</a>.<a class="code" href="structkeystr.html#o0">ek1</a>);
00061                 <a class="code" href="cfs__des_8c.html#a63">des_key_setup</a>(<a class="code" href="esm__cipher_8c.html#a13">mkey2</a>,<a class="code" href="esm__cipher_8c.html#a25">outks</a>.<a class="code" href="structkeystr.html#o1">ek2</a>);
00062                 <a class="code" href="cfs__des_8c.html#a63">des_key_setup</a>(<a class="code" href="esm__cipher_8c.html#a14">mkey3</a>,<a class="code" href="esm__cipher_8c.html#a25">outks</a>.<a class="code" href="structkeystr.html#o2">ek3</a>);
00063         } <span class="keywordflow">else</span> {
00064                 <a class="code" href="cfs__des_8c.html#a63">des_key_setup</a>(<a class="code" href="esm__cipher_8c.html#a9">skey1</a>,<a class="code" href="esm__cipher_8c.html#a25">outks</a>.<a class="code" href="structkeystr.html#o0">ek1</a>);
00065                 <a class="code" href="cfs__des_8c.html#a63">des_key_setup</a>(<a class="code" href="esm__cipher_8c.html#a10">skey2</a>,<a class="code" href="esm__cipher_8c.html#a25">outks</a>.<a class="code" href="structkeystr.html#o1">ek2</a>);
00066                 <a class="code" href="cfs__des_8c.html#a63">des_key_setup</a>(<a class="code" href="esm__cipher_8c.html#a11">skey3</a>,<a class="code" href="esm__cipher_8c.html#a25">outks</a>.<a class="code" href="structkeystr.html#o2">ek3</a>);
00067                 <a class="code" href="cfs__des_8c.html#a63">des_key_setup</a>(<a class="code" href="esm__cipher_8c.html#a12">mkey1</a>,<a class="code" href="esm__cipher_8c.html#a24">inks</a>.<a class="code" href="structkeystr.html#o0">ek1</a>);
00068                 <a class="code" href="cfs__des_8c.html#a63">des_key_setup</a>(<a class="code" href="esm__cipher_8c.html#a13">mkey2</a>,<a class="code" href="esm__cipher_8c.html#a24">inks</a>.<a class="code" href="structkeystr.html#o1">ek2</a>);
00069                 <a class="code" href="cfs__des_8c.html#a63">des_key_setup</a>(<a class="code" href="esm__cipher_8c.html#a14">mkey3</a>,<a class="code" href="esm__cipher_8c.html#a24">inks</a>.<a class="code" href="structkeystr.html#o2">ek3</a>);
00070         }
00071 }
00072 
00073 <span class="comment">/* 8 bit cfb encrypt */</span>
00074 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="esm_8h.html#a15">cfb8_encrypt</a>(c)
00075      <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="esm_8c.html#a47">c</a>;
00076      
00077 {
00078         <span class="keywordtype">int</span> i;
00079         <span class="keywordtype">char</span> blk[8];
00080 
00081         <span class="keywordflow">for</span> (i=0; i&lt;8; i++)
00082                 blk[i]=<a class="code" href="esm_8h.html#a9">ivout</a>[i];
00083         des_block_cipher(<a class="code" href="esm__cipher_8c.html#a25">outks</a>.<a class="code" href="structkeystr.html#o0">ek1</a>,blk,0);
00084         des_block_cipher(<a class="code" href="esm__cipher_8c.html#a25">outks</a>.<a class="code" href="structkeystr.html#o1">ek2</a>,blk,1);
00085         des_block_cipher(<a class="code" href="esm__cipher_8c.html#a25">outks</a>.<a class="code" href="structkeystr.html#o2">ek3</a>,blk,0);
00086         <span class="keywordflow">for</span> (i=0; i&lt;7; i++)
00087                 <a class="code" href="esm_8h.html#a9">ivout</a>[i]=<a class="code" href="esm_8h.html#a9">ivout</a>[i+1];
00088         <a class="code" href="esm_8h.html#a9">ivout</a>[7] = blk[0] ^ <a class="code" href="esm_8c.html#a47">c</a>;
00089         <span class="keywordflow">return</span> (<a class="code" href="esm_8h.html#a9">ivout</a>[7]);
00090 }
00091 
00092 <span class="comment">/*</span>
00093 <span class="comment"> * 8 bit cfb decrypt</span>
00094 <span class="comment"> */</span>
00095 <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="esm_8h.html#a16">cfb8_decrypt</a>(c)
00096      <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="esm_8c.html#a47">c</a>;
00097 {
00098         <span class="keywordtype">int</span> i;
00099         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> blk[8];
00100 
00101         <span class="keywordflow">for</span> (i=0; i&lt;8; i++)
00102                 blk[i]=<a class="code" href="esm_8h.html#a8">ivin</a>[i];
00103         des_block_cipher(<a class="code" href="esm__cipher_8c.html#a24">inks</a>.<a class="code" href="structkeystr.html#o0">ek1</a>,blk,0);
00104         des_block_cipher(<a class="code" href="esm__cipher_8c.html#a24">inks</a>.<a class="code" href="structkeystr.html#o1">ek2</a>,blk,1);
00105         des_block_cipher(<a class="code" href="esm__cipher_8c.html#a24">inks</a>.<a class="code" href="structkeystr.html#o2">ek3</a>,blk,0);
00106         <span class="keywordflow">for</span> (i=0; i&lt;7; i++)
00107                 <a class="code" href="esm_8h.html#a8">ivin</a>[i]=<a class="code" href="esm_8h.html#a8">ivin</a>[i+1];
00108         <a class="code" href="esm_8h.html#a8">ivin</a>[7] = <a class="code" href="esm_8c.html#a47">c</a>;
00109         <span class="keywordflow">return</span> (blk[0] ^ <a class="code" href="esm_8c.html#a47">c</a>);
00110 }
00111 
00112 <span class="comment">/*</span>
00113 <span class="comment"> * alpha -&gt; hex; used for encoding</span>
00114 <span class="comment"> *  (ascii only - bfd)</span>
00115 <span class="comment"> */</span>
00116 <span class="keywordtype">int</span> atoh(ch)
00117      <span class="keywordtype">int</span> ch;
00118 {
00119         <span class="keywordflow">if</span> (isdigit(ch))
00120                 <span class="keywordflow">return</span> ch-<span class="charliteral">'0'</span>;
00121         <span class="keywordflow">if</span> (islower(ch))
00122                 <span class="keywordflow">return</span> 10+ch-<span class="charliteral">'a'</span>;
00123         <span class="keywordflow">if</span> (isupper(ch))
00124                 <span class="keywordflow">return</span> 10+ch-<span class="charliteral">'A'</span>;
00125         <span class="keywordflow">else</span>
00126                 <span class="keywordflow">return</span> -1; <span class="comment">/*???*/</span>
00127 }
00128 
00129      
00130 <span class="keywordtype">int</span> count=0;
<a name="l00131"></a><a class="code" href="esm__cipher_8c.html#a26">00131</a> <span class="keywordtype">int</span> <a class="code" href="esm__cipher_8c.html#a26">secs</a>;
<a name="l00132"></a><a class="code" href="esm__cipher_8c.html#a27">00132</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="esm__cipher_8c.html#a27">bits</a>;
<a name="l00133"></a><a class="code" href="esm__cipher_8c.html#a33">00133</a> <span class="keywordtype">void</span> <a class="code" href="esm__cipher_8c.html#a33">procbit</a>()
00134 {
00135         <a class="code" href="esm__cipher_8c.html#a26">secs</a>--;
00136         <a class="code" href="esm__cipher_8c.html#a27">bits</a> |= ((count ^ (count&gt;&gt;4)) &amp; 0xf)&lt;&lt;(<a class="code" href="esm__cipher_8c.html#a26">secs</a>*4);
00137         <span class="keywordflow">if</span> (<a class="code" href="esm__cipher_8c.html#a26">secs</a>) {
00138                 alarm(1);
00139                 signal(SIGALRM,<a class="code" href="esm__cipher_8c.html#a33">procbit</a>);
00140                 getuid();       <span class="comment">/* do a syscall to slow things a bit */</span>
00141         }
00142 }
00143 
<a name="l00144"></a><a class="code" href="esm__cipher_8c.html#a28">00144</a> <span class="keywordtype">int</span> <a class="code" href="esm__cipher_8c.html#a28">verbose</a>=1;
00145 <span class="comment">/*</span>
00146 <span class="comment"> * init the random number generator - seed with</span>
00147 <span class="comment"> * truerandbits.</span>
00148 <span class="comment"> * Use a combination of OS load and processor clock skew to get</span>
00149 <span class="comment"> * enough entropy to generate the secret parameter (we only need a</span>
00150 <span class="comment"> * total of 128 or so bits, so we just get more than we need to</span>
00151 <span class="comment"> * compensate for any non-randomness).</span>
00152 <span class="comment"> * WARNING: use oldrand() (below) on new platforms</span>
00153 <span class="comment"> * if you aren't sure about truerand().</span>
00154 <span class="comment"> */</span>
<a name="l00155"></a><a class="code" href="esm__cipher_8c.html#a34">00155</a> <a class="code" href="esm__cipher_8c.html#a34">randinit</a>()
00156 {
00157         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="shs_8c.html#a29">n</a>;
00158         <span class="keywordtype">int</span> i;
00159         <span class="keyword">struct </span>timeval tv;
00160         <span class="keywordtype">unsigned</span> <span class="keywordtype">long</span> truerand();
00161         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> b[20];
00162         
00163         R_RandomInit(&amp;<a class="code" href="esm_8h.html#a6">rs</a>);
00164         <span class="keywordflow">if</span> (<a class="code" href="esm__cipher_8c.html#a28">verbose</a>) {
00165                 fprintf(stderr,<span class="stringliteral">"randomizing..."</span>);
00166                 fflush(stderr);
00167         }
00168         <span class="comment">/* we just grab 160 truerand bits and keep feeding them</span>
00169 <span class="comment">           over and over to R_RandomUpdate until it's happy */</span>
00170         <span class="keywordflow">for</span> (i=0; i&lt;20; i++) {
00171                 b[i]=randbyte();
00172                 fprintf(stderr,<span class="stringliteral">"."</span>);
00173         }
00174         <span class="keywordflow">while</span> (R_GetRandomBytesNeeded(&amp;<a class="code" href="shs_8c.html#a29">n</a>,&amp;<a class="code" href="esm_8h.html#a6">rs</a>), (<a class="code" href="shs_8c.html#a29">n</a>&gt;0)) {
00175                 R_RandomUpdate(&amp;<a class="code" href="esm_8h.html#a6">rs</a>,b,<span class="keyword">sizeof</span>(b));
00176         }
00177         <span class="keywordflow">if</span> (<a class="code" href="esm__cipher_8c.html#a28">verbose</a>) {
00178                 fprintf(stderr,<span class="stringliteral">"done\n"</span>);
00179                 fflush(stderr);
00180         }
00181 }
00182 
00183 <span class="comment">/*</span>
00184 <span class="comment"> * OLD CODE HERE.  NOT CALLED.</span>
00185 <span class="comment"> * generate 8 random clock skew bits</span>
00186 <span class="comment"> * we don't use this anymore.. instead we generate more</span>
00187 <span class="comment"> * bits using the mitchell code.</span>
00188 <span class="comment"> * modify the code to use this instead if you don't trust</span>
00189 <span class="comment"> * the higher-bandwidth mitchell numbers.</span>
00190 <span class="comment"> */</span>
<a name="l00191"></a><a class="code" href="esm__cipher_8c.html#a35">00191</a> <span class="keywordtype">int</span> <a class="code" href="esm__cipher_8c.html#a35">rnd8</a>()
00192 {
00193         <a class="code" href="esm__cipher_8c.html#a26">secs</a>=2;
00194         <a class="code" href="esm__cipher_8c.html#a27">bits</a>=0;
00195         signal(SIGALRM,<a class="code" href="esm__cipher_8c.html#a33">procbit</a>);
00196         alarm(1);
00197         getpid();
00198         <span class="keywordflow">while</span> (<a class="code" href="esm__cipher_8c.html#a26">secs</a>)
00199                 count++;
00200         <span class="keywordflow">return</span> <a class="code" href="esm__cipher_8c.html#a27">bits</a>;
00201         
00202 }
00203 
00204 <span class="comment">/*</span>
00205 <span class="comment"> * OLD CODE HERE.  NOT CALLED.</span>
00206 <span class="comment"> * this is the old, slow but simple truerand routine</span>
00207 <span class="comment"> * you should change the code use this on new platforms instead of </span>
00208 <span class="comment"> * the "randinit" above.</span>
00209 <span class="comment"> */</span>
<a name="l00210"></a><a class="code" href="esm__cipher_8c.html#a36">00210</a> <a class="code" href="esm__cipher_8c.html#a36">oldrandinit</a>()
00211 {
00212         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="shs_8c.html#a29">n</a>;
00213         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> b[18];
00214         <span class="keyword">struct </span>timeval tv;
00215         
00216         R_RandomInit(&amp;<a class="code" href="esm_8h.html#a6">rs</a>);
00217         R_GetRandomBytesNeeded(&amp;<a class="code" href="shs_8c.html#a29">n</a>,&amp;<a class="code" href="esm_8h.html#a6">rs</a>); <span class="comment">/* but we ignore */</span>
00218         <span class="comment">/* RSAREF wants 256 bytes, which is an awful lot at 4bps.  we</span>
00219 <span class="comment">           really only need enough to do justice to the entropy of</span>
00220 <span class="comment">           the block cipher (3des), so we just generate 18. */</span>
00221            
00222         <span class="keywordflow">if</span> (<a class="code" href="esm__cipher_8c.html#a28">verbose</a>)
00223                 fprintf(stderr,<span class="stringliteral">"Randomizing (takes about 45 secs)..."</span>);
00224         fflush(stderr);
00225         <span class="keywordflow">for</span> (<a class="code" href="shs_8c.html#a29">n</a>=0; <a class="code" href="shs_8c.html#a29">n</a>&lt;18; <a class="code" href="shs_8c.html#a29">n</a>++) {
00226                 b[<a class="code" href="shs_8c.html#a29">n</a>]=<a class="code" href="esm__cipher_8c.html#a35">rnd8</a>();
00227                 <span class="keywordflow">if</span> (<a class="code" href="esm__cipher_8c.html#a28">verbose</a> &amp;&amp; (<a class="code" href="shs_8c.html#a29">n</a>%4==3)) {
00228                         fprintf(stderr,<span class="stringliteral">"."</span>);
00229                         fflush(stderr);
00230                 }
00231         }
00232         <span class="keywordflow">while</span> (R_GetRandomBytesNeeded(&amp;<a class="code" href="shs_8c.html#a29">n</a>,&amp;<a class="code" href="esm_8h.html#a6">rs</a>), (<a class="code" href="shs_8c.html#a29">n</a>&gt;0)) {
00233                 R_RandomUpdate(&amp;<a class="code" href="esm_8h.html#a6">rs</a>,b,18);
00234                 <span class="keywordflow">if</span> (<a class="code" href="esm__cipher_8c.html#a28">verbose</a>)
00235                         fprintf(stderr,<span class="stringliteral">"."</span>);
00236         }
00237         <span class="comment">/* Just for good measure, we throw in a couple other things */</span>
00238         <a class="code" href="shs_8c.html#a29">n</a>=getpid();
00239         R_RandomUpdate(&amp;<a class="code" href="esm_8h.html#a6">rs</a>,(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)&amp;<a class="code" href="shs_8c.html#a29">n</a>,<span class="keyword">sizeof</span>(<a class="code" href="shs_8c.html#a29">n</a>));
00240         gettimeofday(&amp;tv,NULL);
00241         R_RandomUpdate(&amp;<a class="code" href="esm_8h.html#a6">rs</a>,(<span class="keywordtype">unsigned</span> <span class="keywordtype">char</span>*)&amp;tv,<span class="keyword">sizeof</span>(tv));
00242         <span class="keywordflow">if</span> (<a class="code" href="esm__cipher_8c.html#a28">verbose</a>)
00243                 fprintf(stderr,<span class="stringliteral">"done\n"</span>);
00244 }
00245 
<a name="l00246"></a><a class="code" href="esm__cipher_8c.html#a0">00246</a> <span class="preprocessor">#define BLANKLINE 0</span>
<a name="l00247"></a><a class="code" href="esm__cipher_8c.html#a1">00247</a> <span class="preprocessor"></span><span class="preprocessor">#define TERM 1</span>
<a name="l00248"></a><a class="code" href="esm__cipher_8c.html#a2">00248</a> <span class="preprocessor"></span><span class="preprocessor">#define NONE 2</span>
<a name="l00249"></a><a class="code" href="esm__cipher_8c.html#a3">00249</a> <span class="preprocessor"></span><span class="preprocessor">#define SHORTKEY 3</span>
<a name="l00250"></a><a class="code" href="esm__cipher_8c.html#a4">00250</a> <span class="preprocessor"></span><span class="preprocessor">#define MEDKEY 4</span>
<a name="l00251"></a><a class="code" href="esm__cipher_8c.html#a5">00251</a> <span class="preprocessor"></span><span class="preprocessor">#define LONGKEY 5</span>
<a name="l00252"></a><a class="code" href="esm__cipher_8c.html#a6">00252</a> <span class="preprocessor"></span><span class="preprocessor">#define HEX 6</span>
<a name="l00253"></a><a class="code" href="esm__cipher_8c.html#a7">00253</a> <span class="preprocessor"></span><span class="preprocessor">#define FILENAME 7</span>
00254 <span class="preprocessor"></span>
<a name="l00255"></a><a class="code" href="esm__cipher_8c.html#a29">00255</a> <span class="keywordtype">int</span> <a class="code" href="cfs__des_8c.html#a59">size</a>[3];
00256 
<a name="l00257"></a><a class="code" href="esm__cipher_8c.html#a30">00257</a> <span class="keywordtype">int</span> <a class="code" href="esm__cipher_8c.html#a30">keysize</a>=0;
00258         
<a name="l00259"></a><a class="code" href="esm__cipher_8c.html#a37">00259</a> <a class="code" href="esm__cipher_8c.html#a37">getpubkey</a>()
00260 {
00261         fprintf(stderr,<span class="stringliteral">"Calculator not implemented, sorry\n"</span>);
00262         <span class="keywordflow">return</span>;
00263 }
00264 
00265 <a class="code" href="esm__cipher_8c.html#a38">createdh</a>(param)
00266      <span class="keywordtype">int</span> param;
00267 {
00268         <span class="keywordtype">int</span> e;
00269         
00270         <span class="keywordflow">if</span> ((param&lt;0) || (param&gt;2))
00271                 <span class="keywordflow">return</span> -1;
00272         <a class="code" href="esm_8h.html#a13">ourprivlen</a>=(<a class="code" href="dhparams_8c.html#a6">dhparams</a>[param].generatorLen)/2; <span class="comment">/* from gen'd params */</span>
00273         <span class="keywordflow">if</span> ((e=R_SetupDHAgreement(ourpub, ourpriv, ourprivlen,
00274                                   &amp;dhparams[param], &amp;rs))!=0) {
00275                 <span class="keywordflow">return</span> -1;
00276         }
00277         <span class="keywordflow">return</span> 0;
00278 }
00279 
00280 dhagree(param,master)
00281      <span class="keywordtype">int</span> param;
<a name="l00282"></a><a class="code" href="esm__cipher_8c.html#a31">00282</a>      <span class="keywordtype">int</span> <a class="code" href="esm_8c.html#a24">master</a>;
00283 {
00284         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="cfs__fh_8c.html#a34">buf</a>[<a class="code" href="esm_8h.html#a3">MAXPUBKEY</a>];
00285         <span class="keywordtype">int</span> i;
00286         
00287         <span class="keywordflow">if</span> ((param&lt;0) || (param&gt;2))
00288                 <span class="keywordflow">return</span> -1;
00289         <span class="keywordflow">if</span> (R_ComputeDHAgreedKey(<a class="code" href="cfs__fh_8c.html#a34">buf</a>,<a class="code" href="esm_8h.html#a10">otherpub</a>,<a class="code" href="esm_8h.html#a12">ourpriv</a>,<a class="code" href="esm_8h.html#a13">ourprivlen</a>,
00290                                  &amp;<a class="code" href="dhparams_8c.html#a6">dhparams</a>[param]) != 0)
00291                 <span class="keywordflow">return</span> -1;
00292         <span class="keywordflow">for</span> (i=0; i&lt;8; i++) {   <span class="comment">/* always have enough agreed bits */</span>
00293                 <a class="code" href="esm__cipher_8c.html#a12">mkey1</a>[i] = <a class="code" href="cfs__fh_8c.html#a34">buf</a>[i];
00294                 <a class="code" href="esm__cipher_8c.html#a13">mkey2</a>[i] = <a class="code" href="cfs__fh_8c.html#a34">buf</a>[i+8];
00295                 <a class="code" href="esm__cipher_8c.html#a14">mkey3</a>[i] = <a class="code" href="cfs__fh_8c.html#a34">buf</a>[i+16];
00296                 <a class="code" href="esm__cipher_8c.html#a9">skey1</a>[i] = <a class="code" href="cfs__fh_8c.html#a34">buf</a>[24+i];
00297                 <a class="code" href="esm__cipher_8c.html#a10">skey2</a>[i] = <a class="code" href="cfs__fh_8c.html#a34">buf</a>[24+i+8];
00298                 <a class="code" href="esm__cipher_8c.html#a11">skey3</a>[i] = <a class="code" href="cfs__fh_8c.html#a34">buf</a>[24+i+16];
00299                 <a class="code" href="cfs__fh_8c.html#a33">check</a>[i] = <a class="code" href="cfs__fh_8c.html#a34">buf</a>[32+i];
00300         }
00301         <a class="code" href="esm__cipher_8c.html#a32">cipherinit</a>(<a class="code" href="esm_8c.html#a24">master</a>);
00302         <span class="keywordflow">return</span> 0;
00303 }
00304             
00305      
00306 delkey()
00307 {
00308 }
00309 
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Tue Jun 15 09:59:03 2004 for CFS by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.4 </small></address>
</body>
</html>
