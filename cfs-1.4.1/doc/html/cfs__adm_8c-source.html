<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>CFS: cfs_adm.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.4 -->
<div class="qindex">  <form class="search" action="search.php" method="get">
<a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a>  | <span class="search"><u>S</u>earch&nbsp;for&nbsp;<input class="search" type="text" name="query" value="" size="20" accesskey="s"/></span></form></div>
<h1>cfs_adm.c</h1><a href="cfs__adm_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment"> * The author of this software is Matt Blaze.</span>
00003 <span class="comment"> *              Copyright (c) 1992, 1993, 1994 by AT&amp;T.</span>
00004 <span class="comment"> * Permission to use, copy, and modify this software without fee</span>
00005 <span class="comment"> * is hereby granted, provided that this entire notice is included in</span>
00006 <span class="comment"> * all copies of any software which is or includes a copy or</span>
00007 <span class="comment"> * modification of this software and in all copies of the supporting</span>
00008 <span class="comment"> * documentation for such software.</span>
00009 <span class="comment"> *</span>
00010 <span class="comment"> * This software is subject to United States export controls.</span>
00011 <span class="comment"> *</span>
00012 <span class="comment"> * THIS SOFTWARE IS BEING PROVIDED "AS IS", WITHOUT ANY EXPRESS OR IMPLIED</span>
00013 <span class="comment"> * WARRANTY.  IN PARTICULAR, NEITHER THE AUTHORS NOR AT&amp;T MAKE ANY</span>
00014 <span class="comment"> * REPRESENTATION OR WARRANTY OF ANY KIND CONCERNING THE MERCHANTABILITY</span>
00015 <span class="comment"> * OF THIS SOFTWARE OR ITS FITNESS FOR ANY PARTICULAR PURPOSE.</span>
00016 <span class="comment"> */</span>
00017 
00018 <span class="comment">/*</span>
00019 <span class="comment"> * server adm rpc handlers - ver 1.3.2</span>
00020 <span class="comment"> */</span>
00021 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
00022 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00023 <span class="preprocessor">#include &lt;rpc/rpc.h&gt;</span>
00024 <span class="preprocessor">#include &lt;sys/time.h&gt;</span>
00025 <span class="preprocessor">#include &lt;string.h&gt;</span>
00026 <span class="preprocessor">#include "admproto.h"</span>
00027 <span class="preprocessor">#include "nfsproto.h"</span>
00028 <span class="preprocessor">#include "<a class="code" href="cfs_8h.html">cfs.h</a>"</span>
00029 
<a name="l00030"></a><a class="code" href="cfs__adm_8c.html#a0">00030</a> <span class="keyword">typedef</span> <span class="keyword">struct </span>svc_req *<a class="code" href="cfs__adm_8c.html#a0">SR</a>;
00031 
<a name="l00032"></a><a class="code" href="cfs__adm_8c.html#a1">00032</a> <span class="keywordtype">int</span> <a class="code" href="cfs__adm_8c.html#a1">topinstance</a> = 0;
00033 
<a name="l00034"></a><a class="code" href="cfs__adm_8c.html#a4">00034</a> <a class="code" href="cfs__adm_8c.html#a4">cfs_adm</a>()
00035 {
00036 }
00037 
00038 <span class="keywordtype">void</span> *
<a name="l00039"></a><a class="code" href="cfs__adm_8c.html#a5">00039</a> <a class="code" href="cfs__adm_8c.html#a5">admproc_null_2</a>()
00040 {
00041 }
00042 
00043 cfsstat *
00044 <a class="code" href="cfs__adm_8c.html#a6">admproc_attach_2</a>(ap,rp)
00045      cfs_attachargs *ap;
00046      <a class="code" href="cfs__adm_8c.html#a0">SR</a> *<a class="code" href="cfs__nfs_8c.html#a2">rp</a>;
00047 {
00048         <span class="keyword">static</span> cfsstat ret;
00049         <span class="keywordtype">int</span> i;
00050         <a class="code" href="structcfskey.html">cfskey</a> tk;
00051         <a class="code" href="structinstance.html">instance</a> *<a class="code" href="cfs__fh_8c.html#a19">ins</a>;
00052 
00053 <span class="preprocessor">#ifdef DEBUG</span>
00054 <span class="preprocessor"></span>        printf(<span class="stringliteral">"attach: %s %s %d\n"</span>,ap-&gt;dirname, ap-&gt;name, ap-&gt;anon);
00055 <span class="preprocessor">#endif</span>
00056 <span class="preprocessor"></span>        <span class="keywordflow">if</span> (*ap-&gt;dirname != <span class="charliteral">'/'</span>) {
00057                 ret = CFSERR_BADNAME;
00058                 <span class="keywordflow">return</span> &amp;ret;
00059         }
00060         <span class="keywordflow">if</span> (index(ap-&gt;name,<span class="charliteral">'/'</span>) != NULL) {
00061                 ret = CFSERR_BADNAME;
00062                 <span class="keywordflow">return</span> &amp;ret;
00063         }
00064         <span class="keywordflow">if</span> (already(ap-&gt;name)) {
00065                 ret=CFSERR_EXIST;
00066                 <span class="keywordflow">return</span> &amp;ret;
00067         }
00068         <a class="code" href="cfs_8h.html#a21">become</a>(rp);
00069         copykey(&amp;ap-&gt;key,&amp;tk);
00070         <span class="keywordflow">if</span> ((ret=verify(ap-&gt;dirname,&amp;tk)) != CFS_OK) {
00071                 <a class="code" href="cfs_8h.html#a21">become</a>(NULL);
00072                 <span class="keywordflow">return</span> &amp;ret;
00073         }
00074         <a class="code" href="cfs_8h.html#a21">become</a>(NULL);
00075         <span class="keywordflow">for</span> (i=<a class="code" href="cfs__adm_8c.html#a1">topinstance</a>+1; i&lt;<a class="code" href="cfs_8h.html#a5">NINSTANCES</a>; i++)
00076                 <span class="keywordflow">if</span> (<a class="code" href="cfs_8h.html#a35">instances</a>[i] == NULL)
00077                         <span class="keywordflow">break</span>;
00078         <span class="keywordflow">if</span> (i==<a class="code" href="cfs_8h.html#a5">NINSTANCES</a>) <span class="keywordflow">for</span> (i=1; i&lt;<a class="code" href="cfs__adm_8c.html#a1">topinstance</a>; i++)
00079                 <span class="keywordflow">if</span> (<a class="code" href="cfs_8h.html#a35">instances</a>[i] == NULL)
00080                         <span class="keywordflow">break</span>;
00081         <span class="keywordflow">if</span> (i==<a class="code" href="cfs__adm_8c.html#a1">topinstance</a>) {
00082                 ret=CFSERR_IFULL;
00083                 <span class="keywordflow">return</span> &amp;ret;
00084         }
00085         <span class="keywordflow">if</span> ((<a class="code" href="cfs__fh_8c.html#a19">ins</a>=(<a class="code" href="structinstance.html">instance</a>*)malloc(<span class="keyword">sizeof</span>(<a class="code" href="structinstance.html">instance</a>)))==NULL) {
00086                 ret=CFSERR_IFULL;
00087                 <span class="keywordflow">return</span> &amp;ret;
00088         }
00089         <a class="code" href="cfs__adm_8c.html#a1">topinstance</a>=i;
00090         <a class="code" href="cfs_8h.html#a35">instances</a>[i]=<a class="code" href="cfs__fh_8c.html#a19">ins</a>;
00091         <a class="code" href="cfs__fh_8c.html#a19">ins</a>-&gt;id=i;
00092         <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="cfs_8h.html#a15">HSIZE</a>; i++)
00093                 <a class="code" href="cfs__fh_8c.html#a19">ins</a>-&gt;file[i]=NULL;
00094         <a class="code" href="cfs__fh_8c.html#a19">ins</a>-&gt;key.smsize = ap-&gt;smsize;
00095         <span class="keywordflow">if</span> ((<a class="code" href="cfs__fh_8c.html#a19">ins</a>-&gt;key.primask=(<span class="keywordtype">char</span>*) malloc(<a class="code" href="cfs__fh_8c.html#a19">ins</a>-&gt;key.smsize)) == NULL) {
00096                 free(ins);
00097                 ret = CFSERR_IFULL;
00098                 <span class="keywordflow">return</span> &amp;ret;
00099         }
00100         <span class="keywordflow">if</span> ((<a class="code" href="cfs__fh_8c.html#a19">ins</a>-&gt;key.secmask=(<span class="keywordtype">char</span>*) malloc(<a class="code" href="cfs__fh_8c.html#a19">ins</a>-&gt;key.smsize)) == NULL) {
00101                 free(<a class="code" href="cfs__fh_8c.html#a19">ins</a>-&gt;key.primask);
00102                 free(ins);
00103                 ret = CFSERR_IFULL;
00104                 <span class="keywordflow">return</span> &amp;ret;
00105         }
00106         <a class="code" href="cfs__fh_8c.html#a19">ins</a>-&gt;anon=ap-&gt;anon;
00107         sprintf(<a class="code" href="cfs__fh_8c.html#a19">ins</a>-&gt;path,<span class="stringliteral">"%s/."</span>,ap-&gt;dirname);
00108         strcpy(<a class="code" href="cfs__fh_8c.html#a19">ins</a>-&gt;name,ap-&gt;name);
00109         copykey(&amp;ap-&gt;key,&amp;<a class="code" href="cfs__fh_8c.html#a19">ins</a>-&gt;key);
00110         genmasks(&amp;<a class="code" href="cfs__fh_8c.html#a19">ins</a>-&gt;key);
00111         <a class="code" href="cfs__fh_8c.html#a19">ins</a>-&gt;uid=ap-&gt;uid;
00112         <a class="code" href="cfs__fh_8c.html#a19">ins</a>-&gt;highsec=ap-&gt;highsec;
00113         gettimeofday((<span class="keyword">struct</span> timeval *)&amp;roottime,NULL);
00114         <span class="keywordflow">if</span> (ap-&gt;expire !=0)
00115                 <a class="code" href="cfs__fh_8c.html#a19">ins</a>-&gt;timeout = <a class="code" href="cfs_8h.html#a36">roottime</a>.seconds + (ap-&gt;expire*60);
00116         <span class="keywordflow">else</span>
00117                 <a class="code" href="cfs__fh_8c.html#a19">ins</a>-&gt;timeout = 0;
00118         <a class="code" href="cfs__fh_8c.html#a19">ins</a>-&gt;access=<a class="code" href="cfs_8h.html#a36">roottime</a>.seconds;
00119         <a class="code" href="cfs__fh_8c.html#a19">ins</a>-&gt;idle=ap-&gt;idle * 60;
00120         <a class="code" href="cfs__fh_8c.html#a19">ins</a>-&gt;dead=0;
00121         bzero((<span class="keywordtype">char</span> *)<a class="code" href="cfs__fh_8c.html#a19">ins</a>-&gt;check,8);
00122         bcopy((<span class="keywordtype">char</span> *)&amp;roottime,(<span class="keywordtype">char</span> *)<a class="code" href="cfs__fh_8c.html#a19">ins</a>-&gt;check,<span class="keyword">sizeof</span>(roottime));
00123         <a class="code" href="cfs__cipher_8c.html#a3">cipher</a>(&amp;<a class="code" href="cfs__fh_8c.html#a19">ins</a>-&gt;key,<a class="code" href="cfs__fh_8c.html#a19">ins</a>-&gt;check,0);
00124         ret=CFS_OK;
00125         <span class="keywordflow">return</span> &amp;ret;
00126 }
00127 
00128 already(s)
00129      <span class="keywordtype">char</span> *<a class="code" href="cfs__fh_8c.html#a0">s</a>;
00130 {
00131         <span class="keywordtype">int</span> i;
00132 
00133         <span class="keywordflow">for</span> (i=1; i&lt;<a class="code" href="cfs_8h.html#a5">NINSTANCES</a>; i++)
00134                 <span class="keywordflow">if</span> ((<a class="code" href="cfs_8h.html#a35">instances</a>[i]!=NULL) &amp;&amp; !strcmp(instances[i]-&gt;name,s))
00135                         <span class="keywordflow">return</span> 1;
00136         <span class="keywordflow">return</span> 0;
00137 }
00138 
00139 genmasks(k)
00140      <a class="code" href="structcfskey.html">cfskey</a> *<a class="code" href="getpass_8c.html#a3">k</a>;
00141 {
00142         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i;
00143         <span class="keywordtype">char</span> start[9];
00144         FILE *fp;
00145 
00146         <span class="keywordflow">for</span> (i=0; i &lt; <a class="code" href="getpass_8c.html#a3">k</a>-&gt;smsize; i+=<a class="code" href="cfs_8h.html#a6">CFSBLOCK</a>) {
00147                 sprintf(start,<span class="stringliteral">"0%07x"</span>,i/CFSBLOCK);
00148                 bcopy(start,&amp;<a class="code" href="getpass_8c.html#a3">k</a>-&gt;primask[i],CFSBLOCK);
00149                 mask_cipher(k,&amp;<a class="code" href="getpass_8c.html#a3">k</a>-&gt;primask[i],0);
00150                 sprintf(start,<span class="stringliteral">"1%07x"</span>,i/CFSBLOCK);
00151                 bcopy(start,&amp;<a class="code" href="getpass_8c.html#a3">k</a>-&gt;secmask[i],CFSBLOCK);
00152                 mask_cipher(k,&amp;<a class="code" href="getpass_8c.html#a3">k</a>-&gt;secmask[i],0);
00153         }
00154 }
00155 
00156 cfsstat *
00157 admproc_detach_2(ap,rp)
00158      cfs_detachargs *ap;
00159      <a class="code" href="cfs__adm_8c.html#a0">SR</a> *<a class="code" href="cfs__nfs_8c.html#a2">rp</a>;
00160 {
00161         <span class="keyword">static</span> cfsstat ret;
00162         <span class="keywordtype">int</span> i;
00163 
00164         <span class="keywordflow">if</span> (strncmp(ap-&gt;name,<span class="stringliteral">".ANON_"</span>,6) == 0) {
00165                 i = atoi(&amp;ap-&gt;name[6]);
00166                 <span class="keywordflow">if</span> ((i&gt;0) &amp;&amp; (i&lt;<a class="code" href="cfs_8h.html#a5">NINSTANCES</a>) &amp;&amp; (<a class="code" href="cfs_8h.html#a35">instances</a>[i]!=NULL))
00167                         <span class="keywordflow">goto</span> found;
00168         }
00169         <span class="keywordflow">for</span> (i=1; i&lt;<a class="code" href="cfs_8h.html#a5">NINSTANCES</a>; i++)
00170                 <span class="keywordflow">if</span> ((<a class="code" href="cfs_8h.html#a35">instances</a>[i]!=NULL)&amp;&amp;!strcmp(instances[i]-&gt;name,ap-&gt;name))
00171                         <span class="keywordflow">break</span>;
00172         <span class="keywordflow">if</span> (i==<a class="code" href="cfs_8h.html#a5">NINSTANCES</a>) {
00173                 ret=CFSERR_NOINS;
00174                 <span class="keywordflow">return</span> &amp;ret;
00175         }
00176 found:
00177         freeinstance(i);
00178         ret=CFS_OK;
00179         <span class="keywordflow">return</span> &amp;ret;
00180 }
00181 
00182 <span class="comment">/* freeinstance is also called by geth if expired */</span>
00183 freeinstance(i)
00184     <span class="keywordtype">int</span> i;
00185 {
00186         <span class="keywordtype">int</span> j;
00187 
00188         <span class="keywordflow">for</span> (j=0; j&lt;<a class="code" href="cfs_8h.html#a15">HSIZE</a>; j++) {
00189                 freelist(instances[i]-&gt;file[j]);
00190                 <a class="code" href="cfs_8h.html#a35">instances</a>[i]-&gt;<a class="code" href="structinstance.html#o0">file</a>[j]=NULL;
00191         }
00192         bzero((<span class="keywordtype">char</span> *)instances[i]-&gt;<a class="code" href="mcg_8c.html#a0">key</a>.primask,instances[i]-&gt;key.smsize);
00193         free(instances[i]-&gt;<a class="code" href="mcg_8c.html#a0">key</a>.primask);
00194         bzero((<span class="keywordtype">char</span> *)instances[i]-&gt;<a class="code" href="mcg_8c.html#a0">key</a>.secmask,instances[i]-&gt;key.smsize);
00195         free(instances[i]-&gt;<a class="code" href="mcg_8c.html#a0">key</a>.secmask);
00196         bzero((<span class="keywordtype">char</span> *)instances[i],<span class="keyword">sizeof</span>(<a class="code" href="structinstance.html">instance</a>));
00197         free(instances[i]);
00198         <a class="code" href="cfs_8h.html#a35">instances</a>[i]=NULL;
00199         gettimeofday((<span class="keyword">struct</span> timeval *)&amp;roottime,NULL);
00200         closeall();
00201 }
00202 
00203 freelist(f)
00204     <a class="code" href="structcfs__fileid.html">cfs_fileid</a> *f;
00205 {
00206         <span class="keywordflow">if</span> (f==NULL)
00207                 <span class="keywordflow">return</span>;
00208         freelist(f-&gt;<a class="code" href="structcfs__fileid.html#o7">next</a>);
00209         free(f-&gt;<a class="code" href="structcfs__fileid.html#o4">name</a>);
00210         free(f);
00211 }
00212 
00213 verify(path,k)
00214      <span class="keywordtype">char</span> *path;
00215      cfs_admkey *<a class="code" href="getpass_8c.html#a3">k</a>;
00216 {
00217         FILE *fp;
00218         <span class="keywordtype">char</span> <a class="code" href="cfs__fh_8c.html#a36">fn</a>[1024];
00219         <span class="keywordtype">char</span> <a class="code" href="cfs__fh_8c.html#a34">buf</a>[9];
00220 
00221         sprintf(fn,<span class="stringliteral">"%s/..."</span>,path);
00222         <span class="keywordflow">if</span> ((fp=fopen(fn,<span class="stringliteral">"r"</span>))==NULL)
00223                 <span class="keywordflow">return</span> CFSERR_NODIR;
00224         <span class="keywordflow">if</span> (fread(buf,8,1,fp)!=1) {
00225                 fclose (fp);
00226                 <span class="keywordflow">return</span> CFSERR_NODIR;
00227         }
00228         fclose (fp);
00229         <a class="code" href="cfs__cipher_8c.html#a3">cipher</a>(k,buf,1);        <span class="comment">/* note order here */</span>
00230         mask_cipher(k,buf,0);
00231         <a class="code" href="cfs__cipher_8c.html#a3">cipher</a>(k,buf,1);        <span class="comment">/* note order here */</span>
00232         <span class="keywordflow">if</span> (bcmp(buf,<span class="stringliteral">"qua!"</span>,4)!=0)
00233                 <span class="keywordflow">return</span> CFSERR_BADKEY;
00234         <span class="keywordflow">return</span> CFS_OK;
00235 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Tue Jun 15 09:59:03 2004 for CFS by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.4 </small></address>
</body>
</html>
