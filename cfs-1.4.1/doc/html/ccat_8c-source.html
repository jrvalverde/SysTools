<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>CFS: ccat.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.4 -->
<div class="qindex">  <form class="search" action="search.php" method="get">
<a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a>  | <span class="search"><u>S</u>earch&nbsp;for&nbsp;<input class="search" type="text" name="query" value="" size="20" accesskey="s"/></span></form></div>
<h1>ccat.c</h1><a href="ccat_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment"> * The author of this software is Matt Blaze.</span>
00003 <span class="comment"> *              Copyright (c) 1992, 1994 by AT&amp;T.</span>
00004 <span class="comment"> * Permission to use, copy, and modify this software without fee</span>
00005 <span class="comment"> * is hereby granted, provided that this entire notice is included in</span>
00006 <span class="comment"> * all copies of any software which is or includes a copy or</span>
00007 <span class="comment"> * modification of this software and in all copies of the supporting</span>
00008 <span class="comment"> * documentation for such software.</span>
00009 <span class="comment"> *</span>
00010 <span class="comment"> * This software is subject to United States export controls.</span>
00011 <span class="comment"> *</span>
00012 <span class="comment"> * THIS SOFTWARE IS BEING PROVIDED "AS IS", WITHOUT ANY EXPRESS OR IMPLIED</span>
00013 <span class="comment"> * WARRANTY.  IN PARTICULAR, NEITHER THE AUTHORS NOR AT&amp;T MAKE ANY</span>
00014 <span class="comment"> * REPRESENTATION OR WARRANTY OF ANY KIND CONCERNING THE MERCHANTABILITY</span>
00015 <span class="comment"> * OF THIS SOFTWARE OR ITS FITNESS FOR ANY PARTICULAR PURPOSE.</span>
00016 <span class="comment"> */</span>
00017 
00018 <span class="comment">/*</span>
00019 <span class="comment"> * cfs ccat - 1.3</span>
00020 <span class="comment"> */</span>
00021 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00022 <span class="preprocessor">#include &lt;rpc/rpc.h&gt;</span>
00023 <span class="preprocessor">#include &lt;sys/time.h&gt;</span>
00024 <span class="preprocessor">#include &lt;sys/file.h&gt;</span>
00025 <span class="preprocessor">#include &lt;sys/stat.h&gt;</span>
00026 <span class="preprocessor">#ifdef SOLARIS2X</span>
00027 <span class="preprocessor"></span><span class="preprocessor">#include &lt;string.h&gt;</span>
00028 <span class="preprocessor">#define rindex strrchr</span>
00029 <span class="preprocessor"></span><span class="preprocessor">#else</span>
00030 <span class="preprocessor"></span><span class="preprocessor">#include &lt;strings.h&gt;</span>
00031 <span class="preprocessor">#endif</span>
00032 <span class="preprocessor"></span><span class="preprocessor">#include "nfsproto.h"</span>
00033 <span class="preprocessor">#include "admproto.h"</span>
00034 <span class="preprocessor">#include "<a class="code" href="cfs_8h.html">cfs.h</a>"</span>
00035 
00036 <span class="comment">/* following are never used - just so i can re-use the library */</span>
<a name="l00037"></a><a class="code" href="ccat_8c.html#a0">00037</a> <span class="keywordtype">int</span> <a class="code" href="ccat_8c.html#a0">validhost</a>;
<a name="l00038"></a><a class="code" href="ccat_8c.html#a1">00038</a> <span class="keywordtype">char</span> <a class="code" href="ccat_8c.html#a1">zerovect</a>[]={0,0,0,0,0,0,0,0,0};
<a name="l00039"></a><a class="code" href="ccat_8c.html#a2">00039</a> <span class="keywordtype">int</span> <a class="code" href="ccat_8c.html#a2">cursecs</a>=0;
00040 
00041 <a class="code" href="esm__gen_8c.html#a0">main</a>(argc,argv)
00042      <span class="keywordtype">int</span> argc;
<a name="l00043"></a><a class="code" href="ccat_8c.html#a3">00043</a>      <span class="keywordtype">char</span> **<a class="code" href="cattach_8c.html#a3">argv</a>;
00044 {
00045         <span class="keywordtype">char</span> *pw;
00046         <span class="keywordtype">char</span> pword[256];
00047         <span class="keywordtype">char</span> *<a class="code" href="getpass_8c.html#a2">getpassword</a>();
00048         cfs_admkey <a class="code" href="getpass_8c.html#a3">k</a>;
00049         <a class="code" href="structcfskey.html">cfskey</a> kt;
00050         <span class="keywordtype">char</span> *flg;
00051         <span class="keywordtype">char</span> *p;
00052         <span class="keywordtype">char</span> ivfile[1024];
00053         <span class="keywordtype">char</span> base[1024];
00054         <span class="keywordtype">char</span> iv[16];
00055         <span class="keywordtype">int</span> <a class="code" href="cfs__fh_8c.html#a8">fd</a>;
00056         <span class="keywordtype">int</span> <a class="code" href="cfs__fh_8c.html#a0">len</a>;
00057         <span class="keywordtype">int</span> siz;
00058         <span class="keywordtype">int</span> <a class="code" href="cfs__fh_8c.html#a9">offset</a>;
00059         <span class="keywordtype">int</span> i;
00060         <span class="keywordtype">char</span> *<a class="code" href="cfs__fh_8c.html#a34">buf</a>[8192];
00061         <span class="keywordtype">int</span> ciph=CFS_THREE_DES;
00062 
00063         <span class="comment">/* Get cipher from command line if specified */</span>
00064         fprintf(stderr,<span class="stringliteral">"WARNING: ccat works only on old format CFS files\n"</span>);
00065         <span class="keywordflow">while</span> (--argc &amp;&amp; (**++<a class="code" href="cattach_8c.html#a3">argv</a> == <span class="charliteral">'-'</span>)) {
00066                 <span class="keywordflow">for</span> (flg= ++*<a class="code" href="cattach_8c.html#a3">argv</a>; *flg; ++flg)
00067                         <span class="keywordflow">switch</span> (*flg) {
00068                             <span class="keywordflow">case</span> <span class="charliteral">'1'</span>:
00069                                 ciph=CFS_STD_DES;
00070                                 <span class="keywordflow">break</span>;
00071                             <span class="keywordflow">case</span> <span class="charliteral">'3'</span>:
00072                                 ciph=CFS_THREE_DES;
00073                                 <span class="keywordflow">break</span>;
00074                             <span class="keywordflow">case</span> <span class="charliteral">'b'</span>:
00075                                 ciph=CFS_BLOWFISH;
00076                                 <span class="keywordflow">break</span>;
00077                             <span class="keywordflow">case</span> <span class="charliteral">'m'</span>:
00078                                 ciph=CFS_MACGUFFIN;
00079                                 <span class="keywordflow">break</span>;
00080                             <span class="keywordflow">case</span> <span class="charliteral">'s'</span>:
00081                                 ciph=CFS_SAFER_SK128;
00082                                 <span class="keywordflow">break</span>;
00083                             <span class="keywordflow">default</span>:
00084                                 fprintf(stderr,<span class="stringliteral">"usage: ccat [-13bms] file...\n"</span>);
00085                                 exit(1);
00086                         }
00087         }
00088         <span class="keywordflow">if</span> (argc&lt;1) {
00089                 fprintf(stderr,<span class="stringliteral">"Usage: ccat [-3bms] file...\n"</span>);
00090                 exit(1);
00091         }
00092         <span class="comment">/* Get password */</span>
00093         <span class="keywordflow">if</span> ((pw=<a class="code" href="getpass_8c.html#a2">getpassword</a>(<span class="stringliteral">"Key:"</span>))==NULL) {
00094                 fprintf(stderr,<span class="stringliteral">"Can't get key\n"</span>);
00095                 exit(1);
00096         }
00097         strcpy(pword,pw);
00098         <a class="code" href="getpass_8c.html#a3">k</a>.cipher=ciph;
00099         <span class="comment">/* check key */</span>
00100         <span class="keywordflow">if</span> (old_pwcrunch(pw,&amp;<a class="code" href="getpass_8c.html#a3">k</a>)!=0) {
00101                 fprintf(stderr,<span class="stringliteral">"Invalid key\n"</span>);
00102                 exit(1);
00103         }
00104         copykey(&amp;<a class="code" href="getpass_8c.html#a3">k</a>,&amp;kt);
00105         <span class="comment">/* allocate space for masks */</span>
00106         kt.<a class="code" href="structcfskey.html#o22">smsize</a>=<a class="code" href="cfs_8h.html#a17">LARGESMSIZE</a>;
00107         <span class="keywordflow">if</span> (((kt.<a class="code" href="structcfskey.html#o23">primask</a>=(<span class="keywordtype">char</span>*) malloc(kt.<a class="code" href="structcfskey.html#o22">smsize</a>)) == NULL)
00108             || ((kt.<a class="code" href="structcfskey.html#o24">secmask</a>=(<span class="keywordtype">char</span>*) malloc(kt.<a class="code" href="structcfskey.html#o22">smsize</a>)) == NULL)) {
00109                 fprintf(stderr,<span class="stringliteral">"No memory\n"</span>);
00110                 exit(2);
00111         }
00112         <span class="comment">/* and generate them */</span>
00113         genmasks(&amp;kt);
00114         <span class="keywordflow">for</span> (i=0; i&lt;argc; i++) {
00115                 strcpy(ivfile,<a class="code" href="cattach_8c.html#a3">argv</a>[i]);
00116                 <span class="keywordflow">if</span> ((p=rindex(ivfile,<span class="charliteral">'/'</span>))==NULL)
00117                         sprintf(ivfile,<span class="stringliteral">".pvect_%s"</span>,<a class="code" href="cattach_8c.html#a3">argv</a>[i]);
00118                 <span class="keywordflow">else</span> {
00119                         *p=<span class="charliteral">'\0'</span>;
00120                         strcpy(base,++p);
00121                         sprintf(ivfile,<span class="stringliteral">"%s/.pvect_%s"</span>,ivfile,base);
00122                 }
00123                 <span class="keywordflow">if</span> (readlink(ivfile,iv,8) != 8)
00124                         bcopy(<a class="code" href="ccat_8c.html#a1">zerovect</a>,iv,8);
00125                 fprintf(stderr,<span class="stringliteral">"%s %s\n"</span>,ivfile,iv);
00126                 <span class="keywordflow">if</span> ((<a class="code" href="cfs__fh_8c.html#a8">fd</a>=open(<a class="code" href="cattach_8c.html#a3">argv</a>[i],O_RDONLY,0))&lt;0) {
00127                         perror(<a class="code" href="cattach_8c.html#a3">argv</a>[i]);
00128                         <span class="keywordflow">continue</span>;
00129                 }
00130                 <span class="comment">/* get file length */</span>
00131                 <a class="code" href="cfs__fh_8c.html#a0">len</a>=flen(<a class="code" href="cfs__fh_8c.html#a8">fd</a>);
00132                 fprintf(stderr,<span class="stringliteral">"%s %d\n"</span>,<a class="code" href="cattach_8c.html#a3">argv</a>[i],<a class="code" href="cfs__fh_8c.html#a0">len</a>);
00133                 <span class="comment">/* decrypt file */</span>
00134                 <span class="keywordflow">for</span> (<a class="code" href="cfs__fh_8c.html#a9">offset</a>=0; <a class="code" href="cfs__fh_8c.html#a9">offset</a>&lt;<a class="code" href="cfs__fh_8c.html#a0">len</a>;){
00135                         siz=<a class="code" href="cfs__fh_8c.html#a0">len</a>-<a class="code" href="cfs__fh_8c.html#a9">offset</a>;
00136                         <span class="keywordflow">if</span> (siz&gt;8192)
00137                                 siz=8192;
00138                         siz=<a class="code" href="cfs__fh_8c.html#a38">readblock</a>(<a class="code" href="cfs__fh_8c.html#a34">buf</a>,<a class="code" href="cfs__fh_8c.html#a8">fd</a>,<a class="code" href="cfs__fh_8c.html#a9">offset</a>,siz,&amp;kt,iv);
00139                         write(1,<a class="code" href="cfs__fh_8c.html#a34">buf</a>,siz);
00140                         <a class="code" href="cfs__fh_8c.html#a9">offset</a>+=siz;
00141                 }
00142         }
00143 }
00144 <span class="comment"></span>
00145 <span class="comment">/** return file length */</span>
00146 flen(fd)
00147      <span class="keywordtype">int</span> <a class="code" href="cfs__fh_8c.html#a8">fd</a>;
00148 {
00149         <span class="keyword">struct </span>stat <a class="code" href="cfs__fh_8c.html#a25">sb</a>;
00150 
00151         <span class="keywordflow">if</span> (fstat(fd,&amp;sb)&lt;0)
00152                 <span class="keywordflow">return</span> -1;
00153         <span class="keywordflow">return</span> dtov(<a class="code" href="cfs__fh_8c.html#a25">sb</a>.st_size);
00154 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Tue Jun 15 09:59:03 2004 for CFS by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.4 </small></address>
</body>
</html>
