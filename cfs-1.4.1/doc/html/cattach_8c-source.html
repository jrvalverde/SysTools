<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>CFS: cattach.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.4 -->
<div class="qindex">  <form class="search" action="search.php" method="get">
<a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a>  | <span class="search"><u>S</u>earch&nbsp;for&nbsp;<input class="search" type="text" name="query" value="" size="20" accesskey="s"/></span></form></div>
<h1>cattach.c</h1><a href="cattach_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment"> * The author of this software is Matt Blaze.</span>
00003 <span class="comment"> *              Copyright (c) 1992, 1993, 1994, 1995, 1997 by AT&amp;T.</span>
00004 <span class="comment"> * Permission to use, copy, and modify this software without fee</span>
00005 <span class="comment"> * is hereby granted, provided that this entire notice is included in</span>
00006 <span class="comment"> * all copies of any software which is or includes a copy or</span>
00007 <span class="comment"> * modification of this software and in all copies of the supporting</span>
00008 <span class="comment"> * documentation for such software.</span>
00009 <span class="comment"> *</span>
00010 <span class="comment"> * This software is subject to United States export controls.</span>
00011 <span class="comment"> *</span>
00012 <span class="comment"> * THIS SOFTWARE IS BEING PROVIDED "AS IS", WITHOUT ANY EXPRESS OR IMPLIED</span>
00013 <span class="comment"> * WARRANTY.  IN PARTICULAR, NEITHER THE AUTHORS NOR AT&amp;T MAKE ANY</span>
00014 <span class="comment"> * REPRESENTATION OR WARRANTY OF ANY KIND CONCERNING THE MERCHANTABILITY</span>
00015 <span class="comment"> * OF THIS SOFTWARE OR ITS FITNESS FOR ANY PARTICULAR PURPOSE.</span>
00016 <span class="comment"> */</span>
00017 <span class="comment"></span>
00018 <span class="comment">/**</span>
00019 <span class="comment"> * @file cattach.c</span>
00020 <span class="comment"> * client side CFS attach - 1.4.0</span>
00021 <span class="comment"> *</span>
00022 <span class="comment"> * @date december 1997</span>
00023 <span class="comment"> */</span>
00024 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00025 <span class="preprocessor">#include &lt;rpc/rpc.h&gt;</span>
00026 <span class="preprocessor">#include &lt;sys/time.h&gt;</span>
00027 <span class="preprocessor">#ifdef irix</span>
00028 <span class="preprocessor"></span><span class="preprocessor">#include &lt;sys/statfs.h&gt;</span>
00029 <span class="preprocessor">#else</span>
00030 <span class="preprocessor"></span><span class="preprocessor">#ifndef BSD44</span>
00031 <span class="preprocessor"></span><span class="preprocessor">#ifdef  ultrix</span>
00032 <span class="preprocessor"></span><span class="preprocessor">#include &lt;sys/param.h&gt;</span>
00033 <span class="preprocessor">#include &lt;sys/mount.h&gt;</span>
00034 <span class="preprocessor">#else</span>
00035 <span class="preprocessor"></span><span class="preprocessor">#include &lt;sys/vfs.h&gt;</span>
00036 <span class="preprocessor">#endif  </span><span class="comment">/* ultrix */</span>
00037 <span class="preprocessor">#else</span>
00038 <span class="preprocessor"></span><span class="preprocessor">#ifndef MAXHOSTNAMELEN</span>
00039 <span class="preprocessor"></span><span class="preprocessor">#include &lt;sys/param.h&gt;</span>
00040 <span class="preprocessor">#endif</span>
00041 <span class="preprocessor"></span><span class="preprocessor">#include &lt;sys/mount.h&gt;</span>
00042 <span class="preprocessor">#endif  </span><span class="comment">/* BSD44 */</span>
00043 <span class="preprocessor">#endif</span>
00044 <span class="preprocessor"></span><span class="preprocessor">#ifdef SOLARIS2X</span>
00045 <span class="preprocessor"></span><span class="preprocessor">#include &lt;string.h&gt;</span>
00046 <span class="preprocessor">#define rindex strrchr</span>
00047 <span class="preprocessor"></span><span class="preprocessor">#else</span>
00048 <span class="preprocessor"></span><span class="preprocessor">#include &lt;strings.h&gt;</span>
00049 <span class="preprocessor">#endif</span>
00050 <span class="preprocessor"></span><span class="preprocessor">#include "nfsproto.h"</span>
00051 <span class="preprocessor">#include "admproto.h"</span>
00052 <span class="preprocessor">#include "<a class="code" href="cfs_8h.html">cfs.h</a>"</span>
00053 
00054 <span class="preprocessor">#ifdef SOLARIS2X</span>
00055 <span class="preprocessor"></span><span class="comment">/* NOTE!  delete the #define statfs below if this won't compile on</span>
00056 <span class="comment">  your solaris configuration */</span>
00057 <span class="preprocessor">#define statfs          statvfs</span>
00058 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00059 <span class="preprocessor"></span>
00060 <span class="preprocessor">#ifndef TMOUT           </span><span class="comment">/* default timeout; override in makefile */</span>
<a name="l00061"></a><a class="code" href="cattach_8c.html#a0">00061</a> <span class="preprocessor">#define TMOUT 0</span>
00062 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00063 <span class="preprocessor"></span>
00064 <span class="preprocessor">#ifndef IDLE            </span><span class="comment">/* default idle timer; override in makefile */</span>
<a name="l00065"></a><a class="code" href="cattach_8c.html#a1">00065</a> <span class="preprocessor">#define IDLE 0</span>
00066 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00067 <span class="preprocessor"></span>
00068 <a class="code" href="esm__gen_8c.html#a0">main</a>(argc,argv)
00069      <span class="keywordtype">int</span> argc;
<a name="l00070"></a><a class="code" href="cattach_8c.html#a3">00070</a>      <span class="keywordtype">char</span> **<a class="code" href="cattach_8c.html#a3">argv</a>;
00071 {
00072         cfs_attachargs ap;
00073         <span class="keywordtype">char</span> *pw;
00074         <span class="keywordtype">char</span> pword[256];
00075         <span class="keywordtype">int</span> <a class="code" href="shs_8c.html#a29">n</a>;
00076         <span class="keywordtype">int</span> status;
00077         cfsstat ret;
00078         <span class="keywordtype">char</span> *<a class="code" href="getpass_8c.html#a2">getpassword</a>();
00079         <span class="keywordtype">char</span> dir[1024]; <span class="keywordtype">char</span> <a class="code" href="cfs__fh_8c.html#a34">buf</a>[1024];
00080         <span class="keywordtype">char</span> <a class="code" href="cfs__fh_8c.html#a19">ins</a>[1024];
00081 <span class="preprocessor">#ifdef  ultrix</span>
00082 <span class="preprocessor"></span>        <span class="keyword">struct </span>fs_data sfb;
00083 <span class="preprocessor">#define f_blocks  fd_req.btot</span>
00084 <span class="preprocessor"></span><span class="preprocessor">#else</span>
00085 <span class="preprocessor"></span>        <span class="keyword">struct </span>statfs sfb;
00086 <span class="preprocessor">#endif</span>
00087 <span class="preprocessor"></span>        <span class="keywordtype">char</span> *flg;
00088         <span class="keywordtype">int</span> ciph;
00089         FILE *fp;
00090         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> ekey[128];
00091         <span class="keywordtype">char</span> cname[1024]; <span class="comment">/* file identifying cypher method used */</span>
00092         <span class="keywordtype">char</span> kname[1024]; <span class="comment">/* indirect key file */</span>
00093         <span class="keywordtype">char</span> sname[1024];
00094         <span class="keywordtype">char</span> lname[1024]; <span class="comment">/* ..data name */</span>
00095         <span class="keywordtype">int</span> smsize;
00096         <span class="keywordtype">int</span> cfmt=0;
00097         <span class="keyword">static</span> <span class="keyword">struct </span>timeval tout = {60,0};
00098         CLIENT *cln;
00099         <span class="keywordtype">int</span> timeout=<a class="code" href="cattach_8c.html#a0">TMOUT</a>;
00100         <span class="keywordtype">int</span> idle=<a class="code" href="cattach_8c.html#a1">IDLE</a>;
00101         <span class="keywordtype">char</span> *dirarg=NULL;
00102         <span class="keywordtype">char</span> *namearg=NULL;
00103         <span class="keywordtype">int</span> keycheck=1;
00104 
00105         ap.highsec=1;
00106         <span class="keywordflow">while</span> (--argc) <span class="keywordflow">if</span> (**++<a class="code" href="cattach_8c.html#a3">argv</a> == <span class="charliteral">'-'</span>) {
00107                 <span class="keywordflow">for</span> (flg = ++*<a class="code" href="cattach_8c.html#a3">argv</a>; *flg; ++flg)
00108                         <span class="keywordflow">switch</span> (*flg) {
00109                             <span class="keywordflow">case</span> <span class="charliteral">'l'</span>:
00110                                 ap.highsec=0;
00111                                 <span class="keywordflow">break</span>;
00112                             <span class="keywordflow">case</span> <span class="charliteral">'t'</span>:   <span class="comment">/* absolute timeout */</span>
00113                             <span class="keywordflow">case</span> <span class="charliteral">'i'</span>:   <span class="comment">/* idle timer */</span>
00114                                 <a class="code" href="cattach_8c.html#a5">enq</a>(*flg);
00115                                 <span class="keywordflow">break</span>;
00116                             <span class="keywordflow">case</span> <span class="charliteral">'-'</span>:   <span class="comment">/* read key from stdin */</span>
00117                                 keycheck=0;
00118                                 <span class="keywordflow">break</span>;
00119                             <span class="keywordflow">default</span>:
00120                                 fprintf(stderr,<span class="stringliteral">"usage: cattach [-l] [-t timeout] -i [idle] dir name\n"</span>);
00121                                 exit(1);
00122                         }
00123         } <span class="keywordflow">else</span> {
00124                 <span class="keywordflow">switch</span> (deq()) {
00125                     <span class="keywordflow">case</span> -1:
00126                         <span class="keywordflow">if</span> (dirarg==NULL)
00127                                 dirarg = *<a class="code" href="cattach_8c.html#a3">argv</a>;
00128                         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (namearg==NULL)
00129                                 namearg = *<a class="code" href="cattach_8c.html#a3">argv</a>;
00130                         <span class="keywordflow">else</span> {
00131                                 fprintf(stderr,<span class="stringliteral">"usage: cattach [-l] [-t timeout] -i [idle] dir name\n"</span>);
00132                                 exit(1);
00133                         }
00134                         <span class="keywordflow">break</span>;
00135                     <span class="keywordflow">case</span> <span class="charliteral">'t'</span>:
00136                         timeout = atoi(*<a class="code" href="cattach_8c.html#a3">argv</a>);
00137                         <span class="keywordflow">break</span>;
00138                     <span class="keywordflow">case</span> <span class="charliteral">'i'</span>:
00139                         idle = atoi(*<a class="code" href="cattach_8c.html#a3">argv</a>);
00140                         <span class="keywordflow">break</span>;
00141                     <span class="keywordflow">default</span>:    <span class="comment">/* should never happen */</span>
00142                         fprintf(stderr,<span class="stringliteral">"cattach: internal error\n"</span>);
00143                         exit(1);
00144                 }
00145         }
00146 <span class="preprocessor">#ifndef NO_DEFAULT_NAME</span>
00147 <span class="preprocessor"></span>        <span class="comment">/* From George Sipe */</span>
00148         <span class="comment">/* provide sensible default for name if not specified */</span>
00149         <span class="keywordflow">if</span> ((dirarg!=NULL) &amp;&amp; (namearg==NULL)) {
00150                 <span class="keywordflow">while</span> ((namearg = rindex(dirarg, <span class="charliteral">'/'</span>))!=NULL) {
00151                         <span class="keywordflow">if</span> (dirarg==namearg||*++namearg)
00152                                 <span class="keywordflow">break</span>;          <span class="comment">/* not a trailing slash */</span>
00153                         *--namearg = <span class="charliteral">'\000'</span>;    <span class="comment">/* remove it, try again */</span>
00154                 }
00155                 <span class="keywordflow">if</span> (namearg==NULL)
00156                         namearg = dirarg;
00157         }
00158 <span class="preprocessor">#endif</span>
00159 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ((dirarg==NULL) || (namearg==NULL)) {
00160                 fprintf(stderr,<span class="stringliteral">"usage: cattach [-l] [-t timeout] [-i idle] dir name\n"</span>);
00161                 exit(1);
00162         }
00163         <span class="keywordflow">if</span> (*dirarg!=<span class="charliteral">'/'</span>) {
00164                 <span class="keywordflow">if</span> (getcwd(<a class="code" href="cfs__fh_8c.html#a34">buf</a>,1024) == NULL) {
00165                         fprintf(stderr,<span class="stringliteral">"Can't stat current directory\n"</span>);
00166                         exit(1);
00167                 }
00168                 sprintf(dir,<span class="stringliteral">"%s/%s"</span>,<a class="code" href="cfs__fh_8c.html#a34">buf</a>,dirarg);
00169         } <span class="keywordflow">else</span>
00170                 strcpy(dir,dirarg);
00171         sprintf(lname,<span class="stringliteral">"%s/..data"</span>,dir,1024);
00172         sprintf(kname,<span class="stringliteral">"%s/..k"</span>,dir,1024);
00173         <span class="keywordflow">if</span> (chdir(lname) &gt;= 0)
00174                 strcpy(dir,lname);
00175         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (chdir(dir)&lt;0) {
00176                 perror(dirarg);
00177                 exit(1);
00178         }
00179 <span class="preprocessor">#ifdef irix</span>
00180 <span class="preprocessor"></span><span class="comment">/* or (I hope) more or less any system with the 4 parameter statfs */</span>
00181     <span class="keywordflow">if</span> ((statfs(<span class="stringliteral">"."</span>,&amp;sfb,<span class="keyword">sizeof</span> sfb,0)&lt;0) || (sfb.f_blocks==0)) {
00182         fprintf(stderr,<span class="stringliteral">"Sorry, can't attach to a crypted directory\n"</span>);
00183         exit(1);
00184     }
00185 <span class="preprocessor">#else</span>
00186 <span class="preprocessor"></span>        <span class="keywordflow">if</span> ((statfs(<span class="stringliteral">"."</span>,&amp;sfb)&lt;0) || (sfb.f_blocks==0)) {
00187                 fprintf(stderr,<span class="stringliteral">"Sorry, can't attach to a crypted directory\n"</span>);
00188                 exit(1);
00189         }
00190 <span class="preprocessor">#endif</span>
00191 <span class="preprocessor"></span>        ap.dirname=dir;
00192         strcpy(<a class="code" href="cfs__fh_8c.html#a19">ins</a>,namearg);
00193         *namearg=<span class="charliteral">'\0'</span>; <span class="comment">/* weak attempt to hide .instance in ps output */</span>
00194         ap.name=<a class="code" href="cfs__fh_8c.html#a19">ins</a>;
00195         <span class="keywordflow">if</span> (keycheck) {
00196                 <span class="keywordflow">if</span> ((pw=<a class="code" href="getpass_8c.html#a2">getpassword</a>(<span class="stringliteral">"Key:"</span>))==NULL) {
00197                         fprintf(stderr,<span class="stringliteral">"Can't get key\n"</span>);
00198                         exit(1);
00199                 }
00200         } <span class="keywordflow">else</span> {
00201                 <span class="keywordflow">if</span> (fgets(pword,256,stdin) == NULL) {
00202                         perror(<span class="stringliteral">"cmkdir"</span>);
00203                         exit(1);
00204                 }
00205                 pw=pword;
00206                 pw[255]=<span class="charliteral">'\0'</span>;
00207                 <a class="code" href="shs_8c.html#a29">n</a>=strlen(pw);
00208                 <span class="keywordflow">if</span> ((<a class="code" href="shs_8c.html#a29">n</a>&gt;0) &amp;&amp; (pw[<a class="code" href="shs_8c.html#a29">n</a>-1] == <span class="charliteral">'\n'</span>))
00209                         pw[<a class="code" href="shs_8c.html#a29">n</a>-1] = <span class="charliteral">'\0'</span>;
00210         }
00211         sprintf(cname,<span class="stringliteral">"%s/..c"</span>,dir);    <span class="comment">/* identifies the cypher algorithm */</span>
00212         sprintf(sname,<span class="stringliteral">"%s/..s"</span>,dir);
00213         <span class="keywordflow">if</span> ((fp=fopen(cname,<span class="stringliteral">"r"</span>)) == NULL) {
00214                 ciph=CFS_STD_DES;
00215         } <span class="keywordflow">else</span> {
00216                 fscanf(fp,<span class="stringliteral">"%d"</span>,&amp;ciph);
00217                 fclose(fp);
00218         }
00219         <span class="keywordflow">if</span> ((fp=fopen(kname,<span class="stringliteral">"r"</span>)) == NULL) {
00220                 cfmt=0;
00221         } <span class="keywordflow">else</span> {
00222                 cfmt=1;
00223                 <span class="keywordflow">if</span> (fread(ekey,32,1,fp) &lt; 0)
00224                         cfmt=0;
00225                 fclose(fp);
00226         }
00227         <span class="keywordflow">if</span> ((fp=fopen(sname,<span class="stringliteral">"r"</span>)) == NULL) {
00228                 smsize=<a class="code" href="cfs_8h.html#a17">LARGESMSIZE</a>;
00229         } <span class="keywordflow">else</span> {
00230                 <span class="keywordflow">if</span> (fscanf(fp,<span class="stringliteral">"%d"</span>,&amp;smsize) != 1)
00231                         smsize=<a class="code" href="cfs_8h.html#a17">LARGESMSIZE</a>;
00232                 fclose(fp);
00233                 <span class="keywordflow">if</span> ((smsize &lt; CFSBLOCK) || (smsize &gt; (<a class="code" href="cfs_8h.html#a17">LARGESMSIZE</a>*2)))
00234                         smsize=<a class="code" href="cfs_8h.html#a17">LARGESMSIZE</a>;
00235         }
00236         ap.smsize = smsize;
00237         ap.idle = idle;
00238         ap.expire = timeout;
00239         ap.key.cipher=ciph;
00240         <span class="keywordflow">if</span> (smsize != <a class="code" href="cfs_8h.html#a17">LARGESMSIZE</a>)
00241                 sprintf(pw,<span class="stringliteral">"%s%d"</span>,pw,smsize);
00242 
00243         <span class="keywordflow">if</span> (cfmt) {
00244                 <span class="keywordflow">if</span> (new_pwcrunch(pw,&amp;ap.key)!=0) {
00245                         fprintf(stderr,<span class="stringliteral">"Invalid key\n"</span>);
00246                         exit(1);
00247                 }
00248                 decrypt_key(&amp;ap.key,ekey);
00249         }
00250         <span class="keywordflow">else</span> {
00251                 <span class="keywordflow">if</span> (old_pwcrunch(pw,&amp;ap.key)!=0) {
00252                         fprintf(stderr,<span class="stringliteral">"Invalid key\n"</span>);
00253                         exit(1);
00254                 }
00255         }
00256         ap.anon = ap.name[0]==<span class="charliteral">'.'</span>;
00257         ap.uid=getuid();
00258         <span class="keywordflow">if</span> ((cln=clnt_create(<span class="stringliteral">"localhost"</span>,ADM_PROGRAM,ADM_VERSION,<span class="stringliteral">"udp"</span>))
00259             == NULL) {
00260                 clnt_pcreateerror(<span class="stringliteral">"adm"</span>);
00261                 exit(1);
00262         }
00263         cln-&gt;cl_auth = authunix_create_default();
00264         <span class="keywordflow">if</span> ((status = clnt_call(cln,ADMPROC_ATTACH,xdr_cfs_attachargs,&amp;ap,
00265                                 xdr_cfsstat,&amp;ret,tout)) != RPC_SUCCESS) {
00266                 clnt_perrno(status);
00267                 exit(1);
00268         }
00269         <span class="keywordflow">if</span> (ret!=CFS_OK)
00270                 fprintf(stderr,<span class="stringliteral">"cattach: %s\n"</span>,<a class="code" href="cfs_8h.html#a38">admmsg</a>(ret));
00271         exit(ret);
00272 }
00273 <span class="comment"></span>
00274 <span class="comment">/** define a queue of 5 ints */</span>
00275 <span class="preprocessor">#define QS 5</span>
00276 <span class="preprocessor"></span><span class="keyword">struct </span>{
00277         <span class="keywordtype">int</span> <a class="code" href="cfs__bfsk_8c.html#a1">data</a>[QS];
00278         <span class="keywordtype">int</span> head;
00279         <span class="keywordtype">int</span> tail;
00280 } argq = {{0},0,0};
00281 <span class="comment"></span>
00282 <span class="comment">/** enqueue */</span>
00283 <a class="code" href="cattach_8c.html#a5">enq</a>(f)
00284      <span class="keywordtype">char</span> f;
00285 {
00286         argq.tail++;
00287         argq.tail %= QS;
00288         <span class="keywordflow">if</span> (argq.head==argq.tail) {
00289                 fprintf(stderr,<span class="stringliteral">"Can't deal with this\n"</span>);
00290                 exit(-2);
00291         }
00292         argq.data[argq.tail]=f;
00293 }
00294 <span class="comment"></span>
00295 <span class="comment">/** dequeue */</span>
00296 deq()
00297 {
00298         <span class="keywordflow">if</span> (argq.head==argq.tail)
00299                 <span class="keywordflow">return</span> -1;
00300         argq.head++;
00301         argq.head %= QS;
00302         <span class="keywordflow">return</span>(argq.data[argq.head]);
00303 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Tue Jun 15 09:59:03 2004 for CFS by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.4 </small></address>
</body>
</html>
