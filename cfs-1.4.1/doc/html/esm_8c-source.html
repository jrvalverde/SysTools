<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>CFS: esm.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.4 -->
<div class="qindex">  <form class="search" action="search.php" method="get">
<a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a>  | <span class="search"><u>S</u>earch&nbsp;for&nbsp;<input class="search" type="text" name="query" value="" size="20" accesskey="s"/></span></form></div>
<h1>esm.c</h1><a href="esm_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment"> * ESM - Encrypted Session Manager</span>
00003 <span class="comment"> * v1.0.2</span>
00004 <span class="comment"> * matt blaze</span>
00005 <span class="comment"> * December 1995</span>
00006 <span class="comment"> */</span>
00007 
00008 <span class="comment">/* SunOS 5 port by Greg Onufer, based in part on the pty_termios</span>
00009 <span class="comment"> * package written by Don Libes, NIST, 2/6/90</span>
00010 <span class="comment"> */</span>
00011 
00012 <span class="comment">/*</span>
00013 <span class="comment"> * The author of this software is Matt Blaze.</span>
00014 <span class="comment"> *              Copyright (c) 1995 by AT&amp;T.</span>
00015 <span class="comment"> * Permission to use, copy, and modify this software without fee</span>
00016 <span class="comment"> * is hereby granted, provided that this entire notice is included in</span>
00017 <span class="comment"> * all copies of any software which is or includes a copy or</span>
00018 <span class="comment"> * modification of this software and in all copies of the supporting</span>
00019 <span class="comment"> * documentation for such software.</span>
00020 <span class="comment"> *</span>
00021 <span class="comment"> * This software is subject to United States export controls.</span>
00022 <span class="comment"> *</span>
00023 <span class="comment"> * THIS SOFTWARE IS BEING PROVIDED "AS IS", WITHOUT ANY EXPRESS OR IMPLIED</span>
00024 <span class="comment"> * WARRANTY.  IN PARTICULAR, NEITHER THE AUTHORS NOR AT&amp;T MAKE ANY</span>
00025 <span class="comment"> * REPRESENTATION OR WARRANTY OF ANY KIND CONCERNING THE MERCHANTABILITY</span>
00026 <span class="comment"> * OF THIS SOFTWARE OR ITS FITNESS FOR ANY PARTICULAR PURPOSE.</span>
00027 <span class="comment"> */</span>
00028 <span class="comment">/*</span>
00029 <span class="comment"> * Some of this file was stolen from the BSD "script" program, which</span>
00030 <span class="comment"> * is covered under the following notice:</span>
00031 <span class="comment"> *</span>
00032 <span class="comment"> * Copyright (c) 1980 Regents of the University of California.</span>
00033 <span class="comment"> * All rights reserved.</span>
00034 <span class="comment"> *</span>
00035 <span class="comment"> * Redistribution and use in source and binary forms, with or without</span>
00036 <span class="comment"> * modification, are permitted provided that the following conditions</span>
00037 <span class="comment"> * are met:</span>
00038 <span class="comment"> * 1. Redistributions of source code must retain the above copyright</span>
00039 <span class="comment"> *    notice, this list of conditions and the following disclaimer.</span>
00040 <span class="comment"> * 2. Redistributions in binary form must reproduce the above copyright</span>
00041 <span class="comment"> *    notice, this list of conditions and the following disclaimer in the</span>
00042 <span class="comment"> *    documentation and/or other materials provided with the distribution.</span>
00043 <span class="comment"> * 3. All advertising materials mentioning features or use of this software</span>
00044 <span class="comment"> *    must display the following acknowledgement:</span>
00045 <span class="comment"> *      This product includes software developed by the University of</span>
00046 <span class="comment"> *      California, Berkeley and its contributors.</span>
00047 <span class="comment"> * 4. Neither the name of the University nor the names of its contributors</span>
00048 <span class="comment"> *    may be used to endorse or promote products derived from this software</span>
00049 <span class="comment"> *    without specific prior written permission.</span>
00050 <span class="comment"> *</span>
00051 <span class="comment"> * THIS SOFTWARE IS PROVIDED BY THE REGENTS AND CONTRIBUTORS ``AS IS'' AND</span>
00052 <span class="comment"> * ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE</span>
00053 <span class="comment"> * IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR PURPOSE</span>
00054 <span class="comment"> * ARE DISCLAIMED.  IN NO EVENT SHALL THE REGENTS OR CONTRIBUTORS BE LIABLE</span>
00055 <span class="comment"> * FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR CONSEQUENTIAL</span>
00056 <span class="comment"> * DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF SUBSTITUTE GOODS</span>
00057 <span class="comment"> * OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS INTERRUPTION)</span>
00058 <span class="comment"> * HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN CONTRACT, STRICT</span>
00059 <span class="comment"> * LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY</span>
00060 <span class="comment"> * OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF</span>
00061 <span class="comment"> * SUCH DAMAGE.</span>
00062 <span class="comment"> */</span>
00063 
00064 <span class="preprocessor">#ifndef lint</span>
<a name="l00065"></a><a class="code" href="esm_8c.html#a21">00065</a> <span class="preprocessor"></span><span class="keywordtype">char</span> <a class="code" href="esm_8c.html#a21">copyright1</a>[] =
00066 <span class="stringliteral">"@(#) Copyright (c) 1980 Regents of the University of California.\n\</span>
00067 <span class="stringliteral"> All rights reserved.\n"</span>;
<a name="l00068"></a><a class="code" href="esm_8c.html#a22">00068</a> <span class="keywordtype">char</span> <a class="code" href="esm_8c.html#a22">copyright2</a>[] =
00069 <span class="stringliteral">"@(#) Copyright (c) 1995 AT&amp;T\nAll rights reserved.\n"</span>;
00070 <span class="preprocessor">#endif </span><span class="comment">/* not lint */</span>
00071 
00072 <span class="preprocessor">#include &lt;sys/types.h&gt;</span>
00073 <span class="preprocessor">#include &lt;sys/stat.h&gt;</span>
00074 <span class="preprocessor">#include &lt;termios.h&gt;</span>
00075 <span class="preprocessor">#ifndef SUN</span>
00076 <span class="preprocessor"></span><span class="preprocessor">#include &lt;sys/ioctl.h&gt;</span>
00077 <span class="preprocessor">#endif</span>
00078 <span class="preprocessor"></span><span class="preprocessor">#include &lt;sys/time.h&gt;</span>
00079 <span class="preprocessor">#include &lt;sys/file.h&gt;</span>
00080 <span class="preprocessor">#include &lt;sys/signal.h&gt;</span>
00081 <span class="preprocessor">#include &lt;unistd.h&gt;</span>
00082 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00083 <span class="preprocessor">#ifdef SOLARIS2X</span>
00084 <span class="preprocessor"></span><span class="preprocessor">#include &lt;fcntl.h&gt;</span>
00085 <span class="preprocessor">#endif</span>
00086 <span class="preprocessor"></span><span class="preprocessor">#ifdef PTMX</span>
00087 <span class="preprocessor"></span><span class="preprocessor">#include &lt;stropts.h&gt;</span>
00088 <span class="preprocessor">#endif</span>
00089 <span class="preprocessor"></span><span class="preprocessor">#include "global.h"</span>
00090 <span class="preprocessor">#include "rsaref.h"</span>
00091 <span class="preprocessor">#include "<a class="code" href="esm_8h.html">esm.h</a>"</span>
00092 
00093 
<a name="l00094"></a><a class="code" href="esm_8c.html#a23">00094</a> <span class="keywordtype">char</span>    *<a class="code" href="esm_8c.html#a23">shell</a>;
<a name="l00095"></a><a class="code" href="esm_8c.html#a24">00095</a> <span class="keywordtype">int</span>     <a class="code" href="esm_8c.html#a24">master</a>;
<a name="l00096"></a><a class="code" href="esm_8c.html#a25">00096</a> <span class="keywordtype">int</span>     <a class="code" href="esm_8c.html#a25">slave</a>;
<a name="l00097"></a><a class="code" href="esm_8c.html#a26">00097</a> <span class="keywordtype">int</span>     <a class="code" href="esm_8c.html#a26">subchild</a>;
00098 
<a name="l00099"></a><a class="code" href="esm_8c.html#a27">00099</a> <span class="keywordtype">int</span> <a class="code" href="esm_8c.html#a27">escape</a>=036; <span class="comment">/* ^^ */</span>
<a name="l00100"></a><a class="code" href="esm_8c.html#a28">00100</a> <span class="keywordtype">int</span> <a class="code" href="esm_8c.html#a28">ciphstate</a>=0;
<a name="l00101"></a><a class="code" href="esm_8c.html#a29">00101</a> <span class="keywordtype">int</span> <a class="code" href="esm_8c.html#a29">ciphbyte</a>=0;
00102 
<a name="l00103"></a><a class="code" href="esm_8c.html#a30">00103</a> <span class="keywordtype">int</span> <a class="code" href="esm_8c.html#a30">keyed</a>=0;
00104 
<a name="l00105"></a><a class="code" href="esm_8c.html#a31">00105</a> <span class="keyword">struct  </span>termios <a class="code" href="esm_8c.html#a31">tt</a>;
<a name="l00106"></a><a class="code" href="esm_8c.html#a32">00106</a> <span class="keyword">struct  </span>winsize <a class="code" href="esm_8c.html#a32">win</a>;
<a name="l00107"></a><a class="code" href="esm_8c.html#a33">00107</a> <span class="keywordtype">int</span>     <a class="code" href="esm_8c.html#a33">lb</a>;
<a name="l00108"></a><a class="code" href="esm_8c.html#a34">00108</a> <span class="keywordtype">int</span>     <a class="code" href="cfs__fh_8c.html#a14">l</a>;
00109 <span class="preprocessor">#ifdef PTMX</span>
00110 <span class="preprocessor"></span><span class="keywordtype">char</span>    *slave_name;
00111 <span class="preprocessor">#else</span>
<a name="l00112"></a><a class="code" href="esm_8c.html#a35">00112</a> <span class="preprocessor"></span><span class="keywordtype">char</span>    <a class="code" href="esm_8c.html#a35">line</a>[] = <span class="stringliteral">"/dev/ptyXX"</span>;
00113 <span class="preprocessor">#endif</span>
<a name="l00114"></a><a class="code" href="esm_8c.html#a36">00114</a> <span class="preprocessor"></span><span class="keywordtype">int</span>     <a class="code" href="esm_8c.html#a36">aflg</a>;
00115 
<a name="l00116"></a><a class="code" href="esm_8c.html#a0">00116</a> <span class="preprocessor">#define REMOTE 0</span>
<a name="l00117"></a><a class="code" href="esm_8c.html#a1">00117</a> <span class="preprocessor"></span><span class="preprocessor">#define LOCAL 1</span>
<a name="l00118"></a><a class="code" href="esm_8c.html#a2">00118</a> <span class="preprocessor"></span><span class="preprocessor">#define CALC 2</span>
00119 <span class="preprocessor"></span>
<a name="l00120"></a><a class="code" href="esm_8c.html#a37">00120</a> <span class="keywordtype">int</span> <a class="code" href="cfs__fh_8c.html#a21">mode</a>=<a class="code" href="esm_8c.html#a1">LOCAL</a>;
<a name="l00121"></a><a class="code" href="esm_8c.html#a38">00121</a> <span class="keywordtype">int</span> <a class="code" href="esm_8c.html#a38">paranoid</a>=0;
00122 
<a name="l00123"></a><a class="code" href="esm_8c.html#a3">00123</a> <span class="preprocessor">#define SL_START 0</span>
<a name="l00124"></a><a class="code" href="esm_8c.html#a4">00124</a> <span class="preprocessor"></span><span class="preprocessor">#define SL_GOT1 1</span>
<a name="l00125"></a><a class="code" href="esm_8c.html#a5">00125</a> <span class="preprocessor"></span><span class="preprocessor">#define SL_GOT2 2</span>
<a name="l00126"></a><a class="code" href="esm_8c.html#a6">00126</a> <span class="preprocessor"></span><span class="preprocessor">#define SL_GOT3 3</span>
<a name="l00127"></a><a class="code" href="esm_8c.html#a7">00127</a> <span class="preprocessor"></span><span class="preprocessor">#define SL_GOT4 4</span>
<a name="l00128"></a><a class="code" href="esm_8c.html#a8">00128</a> <span class="preprocessor"></span><span class="preprocessor">#define SL_KEYING 5</span>
<a name="l00129"></a><a class="code" href="esm_8c.html#a9">00129</a> <span class="preprocessor"></span><span class="preprocessor">#define SL_CRYPT 6</span>
<a name="l00130"></a><a class="code" href="esm_8c.html#a39">00130</a> <span class="preprocessor"></span><span class="keywordtype">int</span> <a class="code" href="esm_8c.html#a39">sloutstate</a>=<a class="code" href="esm_8c.html#a3">SL_START</a>;
<a name="l00131"></a><a class="code" href="esm_8c.html#a40">00131</a> <span class="keywordtype">char</span> *<a class="code" href="esm_8c.html#a40">cmd</a>=NULL;
00132 
<a name="l00133"></a><a class="code" href="esm_8c.html#a41">00133</a> FILE *<a class="code" href="esm_8c.html#a41">fpmaster</a>;
00134 
<a name="l00135"></a><a class="code" href="esm_8c.html#a10">00135</a> <span class="preprocessor">#define bwrite(fp,buf,len) (fwrite(buf,len,1,fp))</span>
00136 <span class="preprocessor"></span>
00137 <a class="code" href="esm__gen_8c.html#a0">main</a>(argc, argv)
00138         <span class="keywordtype">int</span> argc;
<a name="l00139"></a><a class="code" href="esm_8c.html#a42">00139</a>         <span class="keywordtype">char</span> *<a class="code" href="cattach_8c.html#a3">argv</a>[];
00140 {
00141         <span class="keyword">extern</span> <span class="keywordtype">char</span> *optarg;
00142         <span class="keyword">extern</span> <span class="keywordtype">int</span> optind;
00143         <span class="keywordtype">int</span> ch;
00144         <span class="keywordtype">void</span> finish();
00145         <span class="keywordtype">char</span> *getenv();
00146         fd_set <a class="code" href="cfs__fh_8c.html#a5">fds</a>;
00147 
00148         <span class="keywordflow">while</span> ((ch = getopt(argc, <a class="code" href="cattach_8c.html#a3">argv</a>, <span class="stringliteral">"e:splrci"</span>)) != EOF)
00149                 <span class="keywordflow">switch</span>((<span class="keywordtype">char</span>)ch) {
00150                     <span class="keywordflow">case</span> <span class="charliteral">'e'</span>:
00151                         <a class="code" href="esm_8c.html#a40">cmd</a>=optarg;
00152                         <span class="keywordflow">break</span>;
00153                     <span class="keywordflow">case</span> <span class="charliteral">'i'</span>:
00154                     <span class="keywordflow">case</span> <span class="charliteral">'s'</span>:
00155                     <span class="keywordflow">case</span> <span class="charliteral">'p'</span>:
00156                         <a class="code" href="esm_8c.html#a38">paranoid</a>=1;
00157                     <span class="keywordflow">case</span> <span class="charliteral">'r'</span>:
00158                         <a class="code" href="cfs__fh_8c.html#a21">mode</a>=<a class="code" href="esm_8c.html#a0">REMOTE</a>;
00159                         <span class="keywordflow">break</span>;
00160                     <span class="keywordflow">case</span> <span class="charliteral">'l'</span>:
00161                         <a class="code" href="cfs__fh_8c.html#a21">mode</a>=<a class="code" href="esm_8c.html#a1">LOCAL</a>;
00162                         <span class="keywordflow">break</span>;
00163                     <span class="keywordflow">case</span> <span class="charliteral">'c'</span>:
00164                         <a class="code" href="cfs__fh_8c.html#a21">mode</a>=<a class="code" href="esm_8c.html#a2">CALC</a>;
00165                         <span class="keywordflow">break</span>;
00166                     <span class="keywordflow">case</span> <span class="charliteral">'?'</span>:
00167                     <span class="keywordflow">default</span>:
00168                         fprintf(stderr,
00169                            <span class="stringliteral">"usage: esm [-rlc] [-e program\n"</span>);
00170                         exit(1);
00171                 }
00172         argc -= optind;
00173         <a class="code" href="cattach_8c.html#a3">argv</a> += optind;
00174 
00175         <span class="keywordflow">if</span> ((<a class="code" href="esm_8c.html#a23">shell</a>=getenv(<span class="stringliteral">"SHELL"</span>)) == NULL)
00176                 <a class="code" href="esm_8c.html#a23">shell</a> = <span class="stringliteral">"/bin/sh"</span>;
00177         
00178         getmaster();
00179 
00180         (<span class="keywordtype">void</span>) signal(SIGCHLD, finish);
00181         <a class="code" href="esm_8c.html#a26">subchild</a> = fork();
00182         <span class="keywordflow">if</span> (<a class="code" href="esm_8c.html#a26">subchild</a> &lt; 0) {
00183                 perror(<span class="stringliteral">"fork"</span>);
00184                 fail();
00185         }
00186         <span class="keywordflow">if</span> (<a class="code" href="esm_8c.html#a26">subchild</a>==0)
00187                 doshell(<a class="code" href="cfs__fh_8c.html#a21">mode</a>);
00188         <span class="keywordflow">else</span> {
00189                 <span class="comment">/* main loop */</span>
00190                 printf(<span class="stringliteral">"ESM v1.0.2 - encrypted session manager\n"</span>);
00191                 printf(<span class="stringliteral">"    by Matt Blaze, AT&amp;T Bell Labs, December 1995\n"</span>);
00192                 <a class="code" href="esm__cipher_8c.html#a34">randinit</a>();
00193                 <a class="code" href="esm__cipher_8c.html#a32">cipherinit</a>();
00194                 <span class="keywordflow">switch</span> (<a class="code" href="cfs__fh_8c.html#a21">mode</a>) {
00195                     <span class="keywordflow">case</span> <a class="code" href="esm_8c.html#a0">REMOTE</a>:
00196                         <span class="keywordflow">if</span> (<a class="code" href="esm_8c.html#a38">paranoid</a>)
00197                              printf(<span class="stringliteral">"remote server ready\n"</span>);
00198                         <span class="keywordflow">else</span>
00199                              printf(<span class="stringliteral">"remote server ready; ctl-^ to escape\n"</span>);
00200                         <span class="keywordflow">break</span>;
00201                     <span class="keywordflow">case</span> <a class="code" href="esm_8c.html#a1">LOCAL</a>:
00202                         printf(<span class="stringliteral">"local layer ready (run 'esm -s' on remote)\n"</span>);
00203                         <span class="keywordflow">break</span>;
00204                     <span class="keywordflow">default</span>:  <span class="comment">/* not yet */</span>
00205                         printf(<span class="stringliteral">"esm ready\n"</span>);
00206                 }
00207                 rawtty();
00208                 <a class="code" href="esm_8c.html#a41">fpmaster</a>=fdopen(<a class="code" href="esm_8c.html#a24">master</a>,<span class="stringliteral">"w"</span>);
00209                 <span class="keywordflow">if</span> (<a class="code" href="esm_8c.html#a41">fpmaster</a> == NULL)
00210                         done();
00211                 <span class="keywordflow">if</span> (<a class="code" href="esm_8c.html#a38">paranoid</a>)
00212                         <a class="code" href="esm_8c.html#a51">startsession</a>();
00213                 FD_ZERO(&amp;<a class="code" href="cfs__fh_8c.html#a5">fds</a>);
00214                 FD_SET(0,&amp;<a class="code" href="cfs__fh_8c.html#a5">fds</a>);
00215                 FD_SET(<a class="code" href="esm_8c.html#a24">master</a>,&amp;<a class="code" href="cfs__fh_8c.html#a5">fds</a>);
00216                 <span class="keywordflow">while</span> (select (FD_SETSIZE,&amp;<a class="code" href="cfs__fh_8c.html#a5">fds</a>,NULL,NULL,NULL)&gt;0) {
00217                         <span class="keywordflow">if</span> (FD_ISSET(0,&amp;<a class="code" href="cfs__fh_8c.html#a5">fds</a>))
00218                                 <a class="code" href="esm_8c.html#a49">doinput</a>();
00219                         <span class="keywordflow">if</span> (FD_ISSET(<a class="code" href="esm_8c.html#a24">master</a>,&amp;<a class="code" href="cfs__fh_8c.html#a5">fds</a>))
00220                                 dooutput();
00221                         FD_ZERO(&amp;<a class="code" href="cfs__fh_8c.html#a5">fds</a>);
00222                         FD_SET(0,&amp;<a class="code" href="cfs__fh_8c.html#a5">fds</a>);
00223                         FD_SET(<a class="code" href="esm_8c.html#a24">master</a>,&amp;<a class="code" href="cfs__fh_8c.html#a5">fds</a>);
00224                 }
00225                 done();
00226         }
00227 }
00228 
00229 <span class="preprocessor">#define TRANS 0</span>
00230 <span class="preprocessor"></span><span class="preprocessor">#define CMDWAIT 1</span>
00231 <span class="preprocessor"></span><span class="preprocessor">#define CIPHER 2</span>
00232 <span class="preprocessor"></span><span class="preprocessor">#define KEYWAIT 3</span>
00233 <span class="preprocessor"></span>
00234 <span class="preprocessor">#define IV0 0</span>
00235 <span class="preprocessor"></span><span class="preprocessor">#define IV1 1</span>
00236 <span class="preprocessor"></span><span class="preprocessor">#define IV2 2</span>
00237 <span class="preprocessor"></span><span class="preprocessor">#define IV3 3</span>
00238 <span class="preprocessor"></span><span class="preprocessor">#define C0  4</span>
00239 <span class="preprocessor"></span><span class="preprocessor">#define C1  5</span>
00240 <span class="preprocessor"></span>
00241 <span class="keywordtype">int</span> state=TRANS;
<a name="l00242"></a><a class="code" href="esm_8c.html#a43">00242</a> <span class="keywordtype">int</span> <a class="code" href="esm_8c.html#a43">cstate</a>=IV0;
00243 
<a name="l00244"></a><a class="code" href="esm_8c.html#a49">00244</a> <a class="code" href="esm_8c.html#a49">doinput</a>()
00245 {
00246         <span class="keywordtype">int</span> cc;
00247         <span class="keywordtype">int</span> i;
00248         <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> ibuf[512];
00249         
00250         <span class="keywordflow">if</span> ((cc = read(0, ibuf, 512)) &gt; 0) {
00251                 <span class="keywordflow">switch</span> (<a class="code" href="cfs__fh_8c.html#a21">mode</a>) {
00252                     <span class="keywordflow">case</span> <a class="code" href="esm_8c.html#a0">REMOTE</a>:
00253                         <span class="keywordflow">for</span> (i=0; i&lt;cc; i++)
00254                                 domasterin(ibuf[i]);
00255                         <span class="keywordflow">break</span>;
00256                     <span class="keywordflow">case</span> <a class="code" href="esm_8c.html#a1">LOCAL</a>:
00257                         <span class="keywordflow">for</span> (i=0; i&lt;cc; i++)
00258                                 <a class="code" href="esm_8c.html#a50">doslavein</a>(ibuf[i]);
00259                         <span class="keywordflow">break</span>;
00260                     <span class="keywordflow">default</span>:
00261                         <span class="keywordflow">for</span> (i=0; i&lt;cc; i++)
00262                                 <a class="code" href="esm_8c.html#a10">bwrite</a>(<a class="code" href="esm_8c.html#a41">fpmaster</a>,&amp;ibuf[i],1);
00263                         <span class="keywordflow">break</span>;
00264                 }
00265                 fflush(<a class="code" href="esm_8c.html#a41">fpmaster</a>);
00266                 fflush(stdout);
00267         } <span class="keywordflow">else</span>
00268                 done();
00269 }
00270 
00271 <a class="code" href="esm_8c.html#a50">doslavein</a>(ibuf)
00272      <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> ibuf;
00273 {
00274         <span class="keywordtype">int</span> <a class="code" href="esm_8c.html#a47">c</a>;
00275         <span class="keyword">static</span> <span class="keywordtype">int</span> count=0;
00276         
00277         <span class="keywordflow">switch</span> (<a class="code" href="esm_8c.html#a39">sloutstate</a>) {
00278             <span class="keywordflow">case</span> <a class="code" href="esm_8c.html#a9">SL_CRYPT</a>:
00279                 <span class="keywordflow">if</span> (ibuf==<a class="code" href="esm_8c.html#a27">escape</a>) {
00280                         <a class="code" href="esm_8c.html#a10">bwrite</a>(stdout,<span class="stringliteral">"&gt;&gt;"</span>,2);
00281                         fflush(stdout);
00282                         <span class="keywordflow">if</span> (slescape()) {
00283                                 printf(<span class="stringliteral">"q\r\nEntering CLEARTEXT mode\r\n"</span>);
00284                                 <a class="code" href="esm_8c.html#a10">bwrite</a>(fpmaster,<span class="stringliteral">"PPPPPPPPPPPPPPPP"</span>,16);
00285                                 <a class="code" href="esm_8c.html#a39">sloutstate</a>=<a class="code" href="esm_8c.html#a3">SL_START</a>;
00286                         }
00287                         <span class="keywordflow">break</span>;
00288                 }                       
00289                 <a class="code" href="esm_8c.html#a47">c</a>=<a class="code" href="esm_8h.html#a15">cfb8_encrypt</a>(ibuf);
00290                 <span class="keywordflow">if</span> (!(++count % 8))
00291                         <a class="code" href="esm_8c.html#a10">bwrite</a>(fpmaster,<span class="stringliteral">"!"</span>,1);
00292                 sendhex(fpmaster,c);
00293                 <span class="keywordflow">break</span>;
00294             <span class="keywordflow">default</span>:
00295                 <a class="code" href="esm_8c.html#a10">bwrite</a>(fpmaster,&amp;ibuf,1);
00296                 <span class="keywordflow">break</span>;
00297         }
00298 }
00299 
00300 slescape()
00301 {
00302         <span class="keywordtype">char</span> <a class="code" href="cfs__fh_8c.html#a34">buf</a>;
00303         <span class="keywordtype">int</span> <a class="code" href="esm_8c.html#a47">c</a>;
00304         <span class="keywordtype">int</span> escaped=0;
00305         
00306         <span class="keywordflow">while</span> (read(0,&amp;buf,1)&gt;0) {
00307                 <span class="keywordflow">if</span> (escaped) {
00308                         escaped=0;
00309                         <a class="code" href="esm_8c.html#a10">bwrite</a>(fpmaster,&amp;buf,1);
00310                         <span class="keywordflow">continue</span>;
00311                 }
00312                 <span class="keywordflow">if</span> (<a class="code" href="cfs__fh_8c.html#a34">buf</a>==<a class="code" href="esm_8c.html#a27">escape</a>) {
00313                         <a class="code" href="esm_8c.html#a47">c</a>=<a class="code" href="esm_8h.html#a15">cfb8_encrypt</a>(buf);
00314                         sendhex(fpmaster,c);
00315                         <span class="keywordflow">return</span> 0;
00316                 }
00317                 <a class="code" href="esm_8c.html#a10">bwrite</a>(stdout,&amp;buf,1);
00318                 fflush(stdout);
00319                 <span class="keywordflow">if</span> (<a class="code" href="cfs__fh_8c.html#a34">buf</a>==<span class="charliteral">'\\'</span>) {
00320                         escaped=1;
00321                         <span class="keywordflow">continue</span>;
00322                 }
00323                 <span class="keywordflow">if</span> (<a class="code" href="cfs__fh_8c.html#a34">buf</a>==<span class="charliteral">'\r'</span>)
00324                         <span class="keywordflow">return</span> 0;
00325                 <span class="keywordflow">if</span> (<a class="code" href="cfs__fh_8c.html#a34">buf</a>==<span class="charliteral">'C'</span>) {
00326                         <span class="keywordflow">return</span> 1;
00327                 }
00328                 printf(<span class="stringliteral">"\r\nType one of the following:\r\n"</span>);
00329                 printf(<span class="stringliteral">"  \\[char] to send char as cleartext\r\n"</span>);
00330                 printf(<span class="stringliteral">"  ctrl-^ to send escape character\r\n"</span>);
00331                 printf(<span class="stringliteral">"  'C' to return to CLEARTEXT session\r\n"</span>);
00332                 printf(<span class="stringliteral">"  &lt;enter&gt; to return to encrypted session\r\n"</span>);
00333         }
00334         <span class="keywordflow">return</span> 1; <span class="comment">/* should never happen */</span>
00335 }
00336 
00337                                
00338 
00339 domasterin(ibuf)
00340      <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> ibuf;
00341 {
00342         <span class="keywordtype">int</span> <a class="code" href="esm_8c.html#a47">c</a>;
00343         <span class="keywordtype">char</span> ch;
00344         <span class="keyword">static</span> <span class="keywordtype">int</span> bad=0;
00345         
00346         <span class="keywordflow">switch</span> (state) {
00347             <span class="keywordflow">case</span> TRANS:
00348                 <span class="keywordflow">if</span> (ibuf != <a class="code" href="esm_8c.html#a27">escape</a>)
00349                         <a class="code" href="esm_8c.html#a10">bwrite</a>(fpmaster, &amp;ibuf, 1);
00350                 <span class="keywordflow">else</span> {
00351                         state=CMDWAIT;
00352                         <a class="code" href="esm_8c.html#a10">bwrite</a>(stdout,<span class="stringliteral">"&gt;&gt;"</span>,2);
00353                         <a class="code" href="esm_8c.html#a43">cstate</a>=IV0;
00354                 }
00355                 <span class="keywordflow">break</span>;
00356             <span class="keywordflow">case</span> CMDWAIT:
00357                 <span class="keywordflow">if</span> (ibuf == <a class="code" href="esm_8c.html#a27">escape</a>) {
00358                         <a class="code" href="esm_8c.html#a10">bwrite</a>(fpmaster, &amp;ibuf, 1);
00359                         state=TRANS;
00360                 } <span class="keywordflow">else</span> <span class="keywordflow">switch</span> (ibuf) {
00361                     <span class="keywordflow">case</span> <span class="charliteral">'\r'</span>:
00362                     <span class="keywordflow">case</span> <span class="charliteral">'\n'</span>:
00363                         <a class="code" href="esm_8c.html#a10">bwrite</a>(stdout,<span class="stringliteral">"\r\n"</span>,2);
00364                         state=TRANS;
00365                         <span class="keywordflow">break</span>;
00366                     <span class="keywordflow">case</span> <span class="charliteral">'s'</span>:
00367                     <span class="keywordflow">case</span> <span class="charliteral">'S'</span>:
00368                         <a class="code" href="esm_8c.html#a51">startsession</a>(LONG);
00369                         <span class="keywordflow">break</span>;
00370                     <span class="keywordflow">case</span> <span class="charliteral">'Q'</span>:
00371                         done();
00372                         <span class="keywordflow">break</span>;
00373                     <span class="keywordflow">default</span>:
00374                         printf(<span class="stringliteral">"Type 's' to start encrypted session\r\n"</span>);
00375                         printf(<span class="stringliteral">"     'Q' to terminate remote session\r\n"</span>);
00376                         printf(<span class="stringliteral">"     ctrl-^ to send escape character\r\n"</span>);
00377                         printf(<span class="stringliteral">"     &lt;enter&gt; to return to session\r\n"</span>);
00378                         <span class="keywordflow">break</span>;
00379                 }
00380                 <span class="keywordflow">break</span>;
00381             <span class="keywordflow">case</span> CIPHER:
00382                 <span class="keywordflow">if</span> (strchr(<span class="stringliteral">"0123456789abcdef!"</span>,ibuf)!=NULL) {
00383                         bad=0;
00384                         <span class="keywordflow">if</span> ((<a class="code" href="esm_8c.html#a47">c</a> = cipherout(ibuf)) &gt;= 0) {
00385                                 ch=<a class="code" href="esm_8c.html#a47">c</a>;
00386                                 <a class="code" href="esm_8c.html#a10">bwrite</a>(fpmaster,&amp;ch,1);
00387                         }
00388                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bad++ &gt; 16) {
00389                         delkey();
00390                         <a class="code" href="esm_8c.html#a10">bwrite</a>(stdout,<span class="stringliteral">"XXXXXXXXXXXXXXXX"</span>,16);
00391                         <span class="keywordflow">if</span> (<a class="code" href="esm_8c.html#a38">paranoid</a>)
00392                                 done();
00393                         state=TRANS;
00394                 } <span class="keywordflow">else</span>
00395                         <a class="code" href="esm_8c.html#a28">ciphstate</a>=0;
00396                 <span class="keywordflow">break</span>;
00397             <span class="keywordflow">case</span> KEYWAIT:
00398                 <span class="keywordflow">if</span> (strchr(<span class="stringliteral">"0123456789abcdef:"</span>,ibuf)!=NULL) {
00399                         <a class="code" href="esm_8c.html#a53">masterkeyin</a>(ibuf);
00400                 } <span class="keywordflow">else</span> {
00401                         delkey();
00402                         <a class="code" href="esm_8c.html#a10">bwrite</a>(stdout,<span class="stringliteral">"XXXXXXXXXXXXXXXX"</span>,16);
00403                         <span class="keywordflow">if</span> (<a class="code" href="esm_8c.html#a38">paranoid</a>)
00404                                 done();
00405                         state=TRANS;
00406                 }
00407                 <span class="keywordflow">break</span>;
00408         }
00409 }
00410 
00411 <span class="keywordtype">int</span> pubstat=0;
<a name="l00412"></a><a class="code" href="esm_8c.html#a44">00412</a> <span class="keywordtype">int</span> <a class="code" href="esm_8c.html#a44">pubpos</a>=0;
<a name="l00413"></a><a class="code" href="esm_8c.html#a45">00413</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="esm_8c.html#a45">pubbyte</a>=0;
<a name="l00414"></a><a class="code" href="esm_8c.html#a46">00414</a> <span class="keywordtype">int</span> <a class="code" href="esm_8c.html#a46">pksize</a> = -1;
00415 
<a name="l00416"></a><a class="code" href="esm_8c.html#a51">00416</a> <a class="code" href="esm_8c.html#a51">startsession</a>()
00417 {
00418         <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="cfs__fh_8c.html#a34">buf</a>[5] = {0177, <span class="charliteral">'~'</span>, 0177, <span class="charliteral">'~'</span>, <span class="charliteral">'L'</span>};
00419         <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> colon=<span class="charliteral">':'</span>;
00420         <span class="keywordtype">int</span> i;
00421 
00422         <a class="code" href="esm_8h.html#a14">pklen</a>=<a class="code" href="dhparams_8c.html#a6">dhparams</a>[<a class="code" href="esm_8h.html#a2">LONG</a>].primeLen;
00423         printf(<span class="stringliteral">"Starting remote side of %d bit key exchange.\r\n"</span>,<a class="code" href="esm_8h.html#a14">pklen</a>*8);
00424         printf(<span class="stringliteral">"  (type any character to abort)"</span>);
00425         fflush(stdout);
00426         <a class="code" href="esm_8c.html#a10">bwrite</a>(stdout,<a class="code" href="cfs__fh_8c.html#a34">buf</a>,5);
00427         <span class="keywordflow">if</span> (<a class="code" href="esm__cipher_8c.html#a38">createdh</a>(<a class="code" href="esm_8h.html#a2">LONG</a>) &lt; 0)
00428                 <span class="keywordflow">return</span> -1;
00429         <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="esm_8h.html#a14">pklen</a>; i++)
00430                 sendhex(stdout,<a class="code" href="esm_8h.html#a11">ourpub</a>[i]);
00431         <a class="code" href="esm_8c.html#a10">bwrite</a>(stdout,&amp;colon,1);
00432         <a class="code" href="esm_8c.html#a46">pksize</a>=<a class="code" href="esm_8h.html#a2">LONG</a>;
00433         pubstat=0;
00434         <a class="code" href="esm_8c.html#a44">pubpos</a>=0;
00435         <a class="code" href="esm_8c.html#a45">pubbyte</a>=0;
00436         state=KEYWAIT;
00437         <span class="keywordflow">return</span> 0;
00438 }
00439 
<a name="l00440"></a><a class="code" href="esm_8c.html#a52">00440</a> <a class="code" href="esm_8c.html#a52">sltranspub</a>(len)
00441 {
00442         <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> colon=<span class="charliteral">':'</span>;
00443         <span class="keywordtype">int</span> i;
00444         
00445         <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="cfs__fh_8c.html#a0">len</a>; i++)
00446                 sendhex(<a class="code" href="esm_8c.html#a41">fpmaster</a>,<a class="code" href="esm_8h.html#a11">ourpub</a>[i]);
00447         <a class="code" href="esm_8c.html#a10">bwrite</a>(<a class="code" href="esm_8c.html#a41">fpmaster</a>,&amp;colon,1);
00448 }
00449 
00450 <a class="code" href="esm_8c.html#a53">masterkeyin</a>(c)
00451      <span class="keywordtype">char</span> <a class="code" href="esm_8c.html#a47">c</a>;
00452 {
00453         <span class="keywordtype">int</span> <a class="code" href="esm__cipher_8c.html#a27">bits</a>;
00454 
00455         <span class="keywordflow">if</span> (<a class="code" href="esm_8c.html#a47">c</a>==<span class="charliteral">':'</span>) {
00456                 <span class="keywordflow">if</span> (<a class="code" href="esm_8c.html#a44">pubpos</a>!=(<a class="code" href="esm_8h.html#a14">pklen</a>))
00457                         <span class="keywordflow">goto</span> abort;
00458                 <span class="keywordflow">if</span> (mcalckeys(pksize)&lt;0)
00459                         <span class="keywordflow">goto</span> abort;
00460                 <a class="code" href="esm_8c.html#a28">ciphstate</a>=0;
00461                 state=CIPHER;
00462                 <span class="comment">/* state = CHECK */</span>
00463                 <span class="comment">/* add code to do check */</span>
00464                 <span class="keywordflow">return</span>;
00465         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="esm_8c.html#a44">pubpos</a>&lt;<a class="code" href="esm_8h.html#a3">MAXPUBKEY</a>) {
00466                 <a class="code" href="esm__cipher_8c.html#a27">bits</a>=atoh(c);
00467                 <span class="keywordflow">if</span> (<a class="code" href="esm__cipher_8c.html#a27">bits</a>&lt;0)
00468                         <span class="keywordflow">goto</span> abort;
00469                 <span class="keywordflow">if</span> (pubstat) {
00470                         <a class="code" href="esm_8c.html#a45">pubbyte</a> |= <a class="code" href="esm__cipher_8c.html#a27">bits</a>;
00471                         <a class="code" href="esm_8h.html#a10">otherpub</a>[<a class="code" href="esm_8c.html#a44">pubpos</a>]=<a class="code" href="esm_8c.html#a45">pubbyte</a>;
00472                         <a class="code" href="esm_8c.html#a44">pubpos</a>++;
00473                 } <span class="keywordflow">else</span> {
00474                         <a class="code" href="esm_8c.html#a45">pubbyte</a> = <a class="code" href="esm__cipher_8c.html#a27">bits</a>&lt;&lt;4;
00475                 }
00476                 pubstat = 1-pubstat;
00477                 <span class="keywordflow">return</span>;
00478         }
00479     abort:
00480         <a class="code" href="esm_8c.html#a10">bwrite</a>(stdout,<span class="stringliteral">"XXXXXXXXXXXXXXXX"</span>,16);
00481         <span class="keywordflow">if</span> (<a class="code" href="esm_8c.html#a38">paranoid</a>)
00482                 done();
00483         state=TRANS;
00484 }
00485 
00486 <span class="keywordtype">int</span> mcalckeys(len)
00487      <span class="keywordtype">int</span> <a class="code" href="cfs__fh_8c.html#a0">len</a>;
00488 {
00489         <span class="keywordtype">int</span> i;
00490         <span class="keyword">static</span> <span class="keywordtype">char</span> kh[32];
00491         
00492         <span class="keywordflow">if</span> (dhagree(len,1)&lt;0) <span class="comment">/* sets up session keys */</span>
00493                 <span class="keywordflow">return</span> -1;
00494         <span class="keywordflow">for</span> (i=0; i&lt;8; i++) {
00495                 <a class="code" href="esm_8h.html#a8">ivin</a>[i]=0;
00496                 <a class="code" href="esm_8h.html#a9">ivout</a>[i]=0xff;
00497         }
00498         <span class="comment">/* TODO</span>
00499 <span class="comment">        sprintf(kh,"KEYHASH=%02x%02x%02x%02x",</span>
00500 <span class="comment">                check[0],check[1],check[2],check[3]);</span>
00501 <span class="comment">        putenv(kh);     */</span>
00502         <span class="keywordflow">return</span> 0;
00503 }
00504 
00505 <span class="keywordtype">int</span> slcalckeys(len)
00506      <span class="keywordtype">int</span> <a class="code" href="cfs__fh_8c.html#a0">len</a>;
00507 {
00508         <span class="keywordtype">int</span> i;
00509         
00510         <span class="keywordflow">if</span> (dhagree(len,0)&lt;0) <span class="comment">/* sets up session keys */</span>
00511                 <span class="keywordflow">return</span> -1;
00512         <span class="keywordflow">for</span> (i=0; i&lt;8; i++) {
00513                 <a class="code" href="esm_8h.html#a9">ivout</a>[i]=0;
00514                 <a class="code" href="esm_8h.html#a8">ivin</a>[i]=0xff;
00515         }
00516         printf(<span class="stringliteral">"\r\n(key hash is %02x%02x%02x%02x)\r\n"</span>,
00517                 check[0],check[1],check[2],check[3]);
00518         <span class="keywordflow">return</span> 0;
00519 }
00520 
00521 initslkey(param)
00522      <span class="keywordtype">int</span> param;
00523 {
00524         <span class="keywordflow">if</span> ((param&lt;0) || (param&gt;2))
00525                 <span class="keywordflow">return</span> -1;
00526         <a class="code" href="esm_8h.html#a14">pklen</a>=<a class="code" href="dhparams_8c.html#a6">dhparams</a>[param].primeLen;
00527         <a class="code" href="esm_8c.html#a46">pksize</a>=param;
00528         pubstat=0;
00529         <a class="code" href="esm_8c.html#a44">pubpos</a>=0;
00530         <a class="code" href="esm_8c.html#a45">pubbyte</a>=0;
00531 }
00532 
00533 slkeyin(c)
00534      <span class="keywordtype">char</span> <a class="code" href="esm_8c.html#a47">c</a>;
00535 {
00536         <span class="keywordtype">int</span> <a class="code" href="esm__cipher_8c.html#a27">bits</a>;
00537 
00538         <span class="keywordflow">if</span> (<a class="code" href="esm_8c.html#a47">c</a>==<span class="charliteral">':'</span>) {
00539                 <span class="keywordflow">if</span> (<a class="code" href="esm_8c.html#a44">pubpos</a>!=<a class="code" href="esm_8h.html#a14">pklen</a>)
00540                         <span class="keywordflow">goto</span> abort;
00541                 printf(<span class="stringliteral">"\r\nStarting local key exchange..."</span>);
00542                 <span class="keywordflow">if</span> (<a class="code" href="esm__cipher_8c.html#a38">createdh</a>(pksize)&lt;0)
00543                         <span class="keywordflow">goto</span> abort;
00544                 <a class="code" href="esm_8c.html#a52">sltranspub</a>(pklen);
00545                 printf(<span class="stringliteral">"calculating DH key..."</span>);
00546                 fflush(stdout);
00547                 <span class="keywordflow">if</span> (slcalckeys(pksize)&lt;0)
00548                         <span class="keywordflow">goto</span> abort;
00549                 printf(<span class="stringliteral">"Entering ENCRYPTED mode; type ctrl-^ to escape\r\n"</span>);
00550                 <a class="code" href="esm_8c.html#a28">ciphstate</a>=0;
00551                 <a class="code" href="esm_8c.html#a39">sloutstate</a>=<a class="code" href="esm_8c.html#a9">SL_CRYPT</a>;
00552                 <span class="comment">/* add code to send two ascci nulls for check */</span>
00553                 <span class="keywordflow">return</span>;
00554         } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (<a class="code" href="esm_8c.html#a44">pubpos</a>&lt;<a class="code" href="esm_8h.html#a3">MAXPUBKEY</a>){
00555                 <a class="code" href="esm__cipher_8c.html#a27">bits</a>=atoh(c);
00556                 <span class="keywordflow">if</span> (<a class="code" href="esm__cipher_8c.html#a27">bits</a>&lt;0)
00557                         <span class="keywordflow">goto</span> abort;
00558                 <span class="keywordflow">if</span> (pubstat) {
00559                         <a class="code" href="esm_8c.html#a45">pubbyte</a> |= <a class="code" href="esm__cipher_8c.html#a27">bits</a>;
00560                         <a class="code" href="esm_8h.html#a10">otherpub</a>[<a class="code" href="esm_8c.html#a44">pubpos</a>]=<a class="code" href="esm_8c.html#a45">pubbyte</a>;
00561                         <a class="code" href="esm_8c.html#a44">pubpos</a>++;
00562                 } <span class="keywordflow">else</span> {
00563                         <a class="code" href="esm_8c.html#a45">pubbyte</a> = <a class="code" href="esm__cipher_8c.html#a27">bits</a>&lt;&lt;4;
00564                 }
00565                 pubstat = 1-pubstat;
00566                 <span class="keywordflow">return</span>;
00567         }
00568     abort:
00569         <a class="code" href="esm_8c.html#a10">bwrite</a>(stdout,<span class="stringliteral">"X"</span>,1);
00570         state=<a class="code" href="esm_8c.html#a3">SL_START</a>;
00571 
00572 }
00573 
00574 
00575 
00576 <span class="keywordtype">int</span> cipherout(ch)
00577      <span class="keywordtype">char</span> ch;
00578 {
00579         <span class="keywordtype">int</span> <a class="code" href="esm__cipher_8c.html#a27">bits</a>;
00580         
00581         <span class="keywordflow">if</span> (ch==<span class="charliteral">'!'</span>) {
00582                 <a class="code" href="esm_8c.html#a28">ciphstate</a>=0;
00583                 <span class="keywordflow">return</span> -1;
00584         }
00585         <a class="code" href="esm__cipher_8c.html#a27">bits</a>=atoh(ch);
00586         <span class="keywordflow">if</span> (<a class="code" href="esm_8c.html#a28">ciphstate</a>) {
00587                 <a class="code" href="esm_8c.html#a29">ciphbyte</a> |= <a class="code" href="esm__cipher_8c.html#a27">bits</a>;
00588                 <a class="code" href="esm_8c.html#a28">ciphstate</a>=0;
00589                 <span class="keywordflow">return</span>(<a class="code" href="esm_8h.html#a16">cfb8_decrypt</a>(ciphbyte));
00590         } <span class="keywordflow">else</span> {
00591                 <a class="code" href="esm_8c.html#a29">ciphbyte</a> = <a class="code" href="esm__cipher_8c.html#a27">bits</a>&lt;&lt;4;
00592                 <a class="code" href="esm_8c.html#a28">ciphstate</a>=1;
00593                 <span class="keywordflow">return</span> -1;
00594         }
00595 }
00596 
00597 <span class="keywordtype">int</span> ciphercalcin(ch)
00598      <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> ch;
00599 {
00600         <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> iv[8];
00601         <span class="keyword">static</span> <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> cbuf;
00602         <span class="keywordtype">int</span> <a class="code" href="esm_8c.html#a47">c</a>;
00603         <span class="keywordtype">int</span> i;
00604 
00605         <a class="code" href="esm_8c.html#a47">c</a> = atoh(ch);
00606         <span class="keywordflow">switch</span> (<a class="code" href="esm_8c.html#a43">cstate</a>) {
00607             <span class="keywordflow">case</span> IV0:
00608                 <span class="keywordflow">for</span>(i=0; i&lt;8; i++)
00609                         iv[i]=0;
00610                 cbuf = (<a class="code" href="esm_8c.html#a47">c</a>&amp;0xf)&lt;&lt;4;
00611                 <a class="code" href="esm_8c.html#a43">cstate</a>=IV1;
00612                 <span class="keywordflow">return</span> <span class="charliteral">'.'</span>;
00613             <span class="keywordflow">case</span> IV1:
00614                 cbuf = cbuf | (<a class="code" href="esm_8c.html#a47">c</a>&amp;0xf);
00615                 iv[7]=cbuf;
00616                 <a class="code" href="esm_8c.html#a43">cstate</a>=IV2;
00617                 <span class="keywordflow">return</span> <span class="charliteral">'.'</span>;
00618             <span class="keywordflow">case</span> IV2:
00619                 cbuf = (<a class="code" href="esm_8c.html#a47">c</a>&amp;0xf)&lt;&lt;4;
00620                 <a class="code" href="esm_8c.html#a43">cstate</a>=IV3;
00621                 <span class="keywordflow">return</span> <span class="charliteral">'.'</span>;
00622             <span class="keywordflow">case</span> IV3:
00623                 cbuf = cbuf | (<a class="code" href="esm_8c.html#a47">c</a>&amp;0xf);
00624                 iv[6]=cbuf;
00625                 <a class="code" href="esm_8c.html#a43">cstate</a>=C0;
00626                 <span class="keywordflow">return</span> <span class="charliteral">'.'</span>;
00627             <span class="keywordflow">case</span> C0:
00628                 cbuf = (<a class="code" href="esm_8c.html#a47">c</a>&amp;0xf)&lt;&lt;4;
00629                 <a class="code" href="esm_8c.html#a43">cstate</a>=C1;
00630                 <span class="keywordflow">return</span> <span class="charliteral">'.'</span>;
00631             <span class="keywordflow">case</span> C1:
00632                 cbuf = cbuf | <a class="code" href="esm_8c.html#a47">c</a>&amp;0xf;
00633                 <a class="code" href="esm_8c.html#a47">c</a>=<a class="code" href="esm_8h.html#a16">cfb8_decrypt</a>(cbuf);
00634                 <a class="code" href="esm_8c.html#a43">cstate</a>=C0;
00635                 <span class="keywordflow">if</span> (isprint(c)) {
00636                         <a class="code" href="esm_8c.html#a10">bwrite</a>(fpmaster,&amp;c,1);
00637                         <span class="keywordflow">return</span> <span class="charliteral">'_'</span>;
00638                 } <span class="keywordflow">else</span> {
00639                         <span class="keywordflow">return</span> <span class="charliteral">'?'</span>;
00640                 }
00641             <span class="keywordflow">default</span>:
00642                 <span class="keywordflow">return</span> <span class="charliteral">'?'</span>;
00643         }
00644 }
00645 
00646 <span class="preprocessor">#include &lt;sys/wait.h&gt;</span>
00647 
00648 <span class="keywordtype">void</span>
00649 finish()
00650 {
00651         <span class="keywordtype">int</span> status;
00652         <span class="keyword">register</span> <span class="keywordtype">int</span> pid;
00653         <span class="keyword">register</span> <span class="keywordtype">int</span> die = 0;
00654 
00655         <span class="keywordflow">while</span> ((pid = waitpid((pid_t)-1, &amp;status, WNOHANG)) &gt; 0)
00656                 <span class="keywordflow">if</span> (pid == <a class="code" href="esm_8c.html#a26">subchild</a>)
00657                         die = 1;
00658 
00659         <span class="keywordflow">if</span> (die)
00660                 done();
00661 }
00662 
00663 dooutput()
00664 {
00665         <span class="keyword">register</span> <span class="keywordtype">int</span> cc;
00666         <span class="keywordtype">int</span> i;
00667         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> obuf[512];
00668         
00669         <span class="keywordflow">if</span> ((cc = read(master, obuf, 512)) &gt; 0) {
00670                 <span class="keywordflow">switch</span> (<a class="code" href="cfs__fh_8c.html#a21">mode</a>) {
00671                     <span class="keywordflow">case</span> <a class="code" href="esm_8c.html#a0">REMOTE</a>:
00672                         <span class="keywordflow">for</span> (i=0; i&lt;cc; i++)
00673                                 domasterout(obuf[i]);
00674                         <span class="keywordflow">break</span>;
00675                     <span class="keywordflow">case</span> <a class="code" href="esm_8c.html#a1">LOCAL</a>:
00676                         <span class="keywordflow">for</span> (i=0; i&lt;cc; i++)
00677                                 doslaveout(obuf[i]);
00678                         <span class="keywordflow">break</span>;
00679                     <span class="keywordflow">default</span>:
00680                         <span class="keywordflow">for</span> (i=0; i&lt;cc; i++)
00681                                 <a class="code" href="esm_8c.html#a10">bwrite</a>(stdout, &amp;obuf[i], 1);
00682                         <span class="keywordflow">break</span>;
00683                 }
00684                 fflush(fpmaster);
00685                 fflush(stdout);
00686         } <span class="keywordflow">else</span>
00687                 done();
00688 }
00689 
00690 domasterout(obuf)
00691      <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> obuf;
00692 {
00693         <span class="keywordtype">int</span> <a class="code" href="esm_8c.html#a47">c</a>;
00694         <span class="keyword">static</span> <span class="keywordtype">int</span> count=0;
00695         
00696         <span class="keywordflow">switch</span> (state) {
00697             <span class="keywordflow">case</span> CIPHER:
00698                 <a class="code" href="esm_8c.html#a47">c</a>=<a class="code" href="esm_8h.html#a15">cfb8_encrypt</a>(obuf);
00699                 <span class="keywordflow">if</span> (!(++count % 8))
00700                         <a class="code" href="esm_8c.html#a10">bwrite</a>(stdout,<span class="stringliteral">"!"</span>,1);
00701                 sendhex(stdout,c);
00702                 <span class="keywordflow">break</span>;
00703             <span class="keywordflow">case</span> TRANS:
00704                 <a class="code" href="esm_8c.html#a10">bwrite</a>(stdout, &amp;obuf, 1);
00705                 <span class="keywordflow">break</span>;
00706             <span class="keywordflow">default</span>:
00707                 <span class="comment">/* throw away since i/o screws up keying */</span>
00708                 <span class="keywordflow">break</span>;
00709         }
00710 }
00711 
00712 
00713 doslaveout(obuf)
00714      <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> obuf;
00715 {
00716         <span class="keyword">static</span> <span class="keywordtype">int</span> bad=0;
00717         <span class="keywordtype">int</span> <a class="code" href="esm_8c.html#a47">c</a>;
00718         <span class="keywordtype">char</span> ch;
00719         
00720         <span class="keywordflow">switch</span> (<a class="code" href="esm_8c.html#a39">sloutstate</a>) {
00721             <span class="keywordflow">case</span> <a class="code" href="esm_8c.html#a3">SL_START</a>:
00722                 <a class="code" href="esm_8c.html#a10">bwrite</a>(stdout, &amp;obuf, 1);
00723                 <span class="keywordflow">if</span> (obuf==0177)
00724                         <a class="code" href="esm_8c.html#a39">sloutstate</a>=<a class="code" href="esm_8c.html#a4">SL_GOT1</a>;
00725                 <span class="keywordflow">break</span>;
00726             <span class="keywordflow">case</span> <a class="code" href="esm_8c.html#a4">SL_GOT1</a>:
00727                 <span class="keywordflow">if</span> (obuf==<span class="charliteral">'~'</span>)
00728                         <a class="code" href="esm_8c.html#a39">sloutstate</a>=<a class="code" href="esm_8c.html#a5">SL_GOT2</a>;
00729                 <span class="keywordflow">else</span> {
00730                         <a class="code" href="esm_8c.html#a10">bwrite</a>(stdout, &amp;obuf, 1);
00731                         <a class="code" href="esm_8c.html#a39">sloutstate</a>=<a class="code" href="esm_8c.html#a3">SL_START</a>;
00732                 }
00733                 <span class="keywordflow">break</span>;
00734             <span class="keywordflow">case</span> <a class="code" href="esm_8c.html#a5">SL_GOT2</a>:
00735                 <span class="keywordflow">if</span> (obuf==0177)
00736                         <a class="code" href="esm_8c.html#a39">sloutstate</a>=<a class="code" href="esm_8c.html#a6">SL_GOT3</a>;
00737                 <span class="keywordflow">else</span> {
00738                         <a class="code" href="esm_8c.html#a10">bwrite</a>(stdout, &amp;obuf, 1);
00739                         <a class="code" href="esm_8c.html#a39">sloutstate</a>=<a class="code" href="esm_8c.html#a3">SL_START</a>;
00740                 }
00741                 <span class="keywordflow">break</span>;
00742             <span class="keywordflow">case</span> <a class="code" href="esm_8c.html#a6">SL_GOT3</a>:
00743                 <span class="keywordflow">if</span> (obuf==<span class="charliteral">'~'</span>)
00744                         <a class="code" href="esm_8c.html#a39">sloutstate</a>=<a class="code" href="esm_8c.html#a7">SL_GOT4</a>;
00745                 <span class="keywordflow">else</span> {
00746                         <a class="code" href="esm_8c.html#a10">bwrite</a>(stdout, &amp;obuf, 1);
00747                         <a class="code" href="esm_8c.html#a39">sloutstate</a>=<a class="code" href="esm_8c.html#a3">SL_START</a>;
00748                 }
00749                 <span class="keywordflow">break</span>;
00750             <span class="keywordflow">case</span> <a class="code" href="esm_8c.html#a7">SL_GOT4</a>: <span class="comment">/* key size indicator */</span>
00751                 <span class="keywordflow">if</span> (obuf==<span class="charliteral">'S'</span>) {
00752                         initslkey(SHORT);
00753                         <a class="code" href="esm_8c.html#a39">sloutstate</a>=<a class="code" href="esm_8c.html#a8">SL_KEYING</a>;
00754                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (obuf==<span class="charliteral">'M'</span>) {
00755                         initslkey(MEDIUM);
00756                         <a class="code" href="esm_8c.html#a39">sloutstate</a>=<a class="code" href="esm_8c.html#a8">SL_KEYING</a>;
00757                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (obuf==<span class="charliteral">'L'</span>) {
00758                         initslkey(LONG);
00759                         <a class="code" href="esm_8c.html#a39">sloutstate</a>=<a class="code" href="esm_8c.html#a8">SL_KEYING</a>;
00760                 } <span class="keywordflow">else</span> {
00761                         <a class="code" href="esm_8c.html#a39">sloutstate</a>=<a class="code" href="esm_8c.html#a3">SL_START</a>;
00762                         <a class="code" href="esm_8c.html#a10">bwrite</a>(stdout, &amp;obuf, 1);
00763                 }
00764                 <span class="keywordflow">if</span> (<a class="code" href="esm__cipher_8c.html#a38">createdh</a>(pksize)&lt;0)
00765                         <a class="code" href="esm_8c.html#a39">sloutstate</a>=<a class="code" href="esm_8c.html#a3">SL_START</a>;
00766                 <span class="keywordflow">break</span>;
00767             <span class="keywordflow">case</span> <a class="code" href="esm_8c.html#a8">SL_KEYING</a>:
00768                 <span class="keywordflow">if</span> (strchr(<span class="stringliteral">"0123456789abcdef:"</span>,obuf) != NULL) {
00769                         slkeyin(obuf);
00770                 } <span class="keywordflow">else</span> {
00771                         <a class="code" href="esm_8c.html#a10">bwrite</a>(stdout,<span class="stringliteral">"U"</span>,1);
00772                         <a class="code" href="esm_8c.html#a39">sloutstate</a>=<a class="code" href="esm_8c.html#a3">SL_START</a>;
00773                 }
00774                 <span class="keywordflow">break</span>;
00775             <span class="keywordflow">case</span> <a class="code" href="esm_8c.html#a9">SL_CRYPT</a>:
00776                 <span class="keywordflow">if</span> (strchr(<span class="stringliteral">"0123456789abcdef!"</span>,obuf) != NULL) {
00777                         bad=0;
00778                         <span class="keywordflow">if</span> ((<a class="code" href="esm_8c.html#a47">c</a> = cipherout(obuf))&gt;=0) {
00779                                 ch=<a class="code" href="esm_8c.html#a47">c</a>;
00780                                 <a class="code" href="esm_8c.html#a10">bwrite</a>(stdout,&amp;ch,1);
00781                         }
00782                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (bad++ &gt; 8) {
00783                         fprintf(stderr,<span class="stringliteral">"\r\nEncrypted session terminated -"</span>);
00784                         fprintf(stderr,<span class="stringliteral">"\r\npress enter for CLEARTEXT mode: "</span>);
00785                         waitenter();
00786                         delkey();
00787                         <a class="code" href="esm_8c.html#a39">sloutstate</a>=<a class="code" href="esm_8c.html#a3">SL_START</a>;
00788                 } <span class="keywordflow">else</span>
00789                         <a class="code" href="esm_8c.html#a28">ciphstate</a>=0;
00790                 <span class="keywordflow">break</span>;
00791             <span class="keywordflow">default</span>:
00792                 <a class="code" href="esm_8c.html#a10">bwrite</a>(stdout, &amp;obuf, 1);
00793                 <span class="keywordflow">break</span>;
00794         }
00795 }
00796 
00797 
00798 
00799 doshell(mode)
00800      <span class="keywordtype">int</span> <a class="code" href="cfs__fh_8c.html#a21">mode</a>;
00801 {
00802         <span class="keywordtype">int</span> <a class="code" href="cfs__fh_8c.html#a35">t</a>;
00803 
00804         <span class="comment">/***</span>
00805 <span class="comment">        t = open(_PATH_TTY, O_RDWR);</span>
00806 <span class="comment">        if (t &gt;= 0) {</span>
00807 <span class="comment">                (void) ioctl(t, TIOCNOTTY, (char *)0);</span>
00808 <span class="comment">                (void) close(t);</span>
00809 <span class="comment">        }</span>
00810 <span class="comment">        ***/</span>
00811         <span class="comment">/* setprompt(mode); */</span>
00812         getslave();
00813         (<span class="keywordtype">void</span>) close(master);
00814         (<span class="keywordtype">void</span>) dup2(slave, 0);
00815         (<span class="keywordtype">void</span>) dup2(slave, 1);
00816         (<span class="keywordtype">void</span>) dup2(slave, 2);
00817         (<span class="keywordtype">void</span>) close(slave);
00818         <span class="keywordflow">if</span> (<a class="code" href="esm_8c.html#a40">cmd</a>==NULL)
00819                 execl(shell, <span class="stringliteral">"sh"</span>, <span class="stringliteral">"-i"</span>, 0);
00820         <span class="keywordflow">else</span>
00821                 execl(<span class="stringliteral">"/bin/sh"</span>, <span class="stringliteral">"sh"</span>, <span class="stringliteral">"-c"</span>, cmd, 0);
00822         perror(shell);
00823         fail();
00824 }
00825 
00826 <span class="preprocessor">#ifdef NOTDEF</span>
00827 <span class="preprocessor"></span><span class="comment">/* make this work more generally */</span>
00828 setprompt(mode)
00829      <span class="keywordtype">int</span> <a class="code" href="cfs__fh_8c.html#a21">mode</a>;
00830 {
00831         <span class="comment">/* TO DO - make this work for csh */</span>
00832         <span class="keywordtype">char</span> *oldps1;
00833         <span class="keyword">static</span> <span class="keywordtype">char</span> newps1[128];
00834         <span class="keywordtype">char</span> *getenv();
00835 
00836         <span class="keywordflow">if</span> ((oldps1=getenv(<span class="stringliteral">"PS1"</span>)) == NULL)
00837                 oldps1=<span class="stringliteral">"$ "</span>;
00838         <span class="keywordflow">switch</span> (<a class="code" href="cfs__fh_8c.html#a21">mode</a>) {
00839             <span class="keywordflow">case</span> <a class="code" href="esm_8c.html#a1">LOCAL</a>:
00840                 sprintf(newps1,<span class="stringliteral">"PS1=ESM:%s"</span>,oldps1);
00841                 <span class="keywordflow">break</span>;
00842             <span class="keywordflow">case</span> <a class="code" href="esm_8c.html#a0">REMOTE</a>:
00843                 sprintf(newps1,<span class="stringliteral">"PS1=SECURE:%s"</span>,oldps1);
00844                 <span class="keywordflow">break</span>;;
00845             <span class="keywordflow">default</span>:
00846                 sprintf(newps1,<span class="stringliteral">"PS1=?esm:%s"</span>,oldps1);
00847                 <span class="keywordflow">break</span>;
00848         }
00849         putenv(newps1);
00850 }
00851 <span class="preprocessor">#endif</span>
00852 <span class="preprocessor"></span>
00853 rawtty()
00854 {
00855 
00856         <span class="keyword">struct </span>termios sbuf;
00857 
00858         sbuf = <a class="code" href="esm_8c.html#a31">tt</a>;
00859         sbuf.c_iflag &amp;= ~(INLCR|IGNCR|ICRNL|IXON);
00860         sbuf.c_oflag &amp;= ~OPOST;
00861         sbuf.c_lflag &amp;= ~(ICANON|ISIG|ECHO);
00862         sbuf.c_cc[VMIN] = 1;
00863         sbuf.c_cc[VTIME] = 0;
00864         (<span class="keywordtype">void</span>) tcsetattr(0, TCSAFLUSH, &amp;sbuf);
00865 }
00866 
00867 cookedtty()
00868 {
00869         (<span class="keywordtype">void</span>) tcsetattr(0, TCSAFLUSH, &amp;tt);
00870 }
00871 
00872 fail()
00873 {
00874 
00875         (<span class="keywordtype">void</span>) kill(0, SIGTERM);
00876         done();
00877 }
00878 
00879 done()
00880 {
00881         cookedtty();
00882         <span class="keywordflow">switch</span> (<a class="code" href="cfs__fh_8c.html#a21">mode</a>) {
00883             <span class="keywordflow">case</span> <a class="code" href="esm_8c.html#a0">REMOTE</a>:
00884                 <span class="keywordflow">if</span> (state==CIPHER)
00885                         printf(<span class="stringliteral">"XXXXXXXXXXXXXXXX\n"</span>);
00886                 printf(<span class="stringliteral">"esm remote "</span>);
00887                 <span class="keywordflow">break</span>;
00888             <span class="keywordflow">case</span> <a class="code" href="esm_8c.html#a1">LOCAL</a>:
00889                 printf(<span class="stringliteral">"esm local "</span>);
00890                 <span class="keywordflow">break</span>;
00891         }
00892         printf(<span class="stringliteral">"done\n"</span>);
00893         exit(0);
00894 }
00895 
00896 
00897 <span class="preprocessor">#ifdef PTMX</span>
00898 <span class="preprocessor"></span>
00899 getmaster()
00900 {
00901         <span class="keywordflow">if</span> ((<a class="code" href="esm_8c.html#a24">master</a> = open(<span class="stringliteral">"/dev/ptmx"</span>, O_RDWR)) == -1)
00902                 <span class="keywordflow">return</span> (-1);
00903         <span class="keywordflow">if</span> ((slave_name = (<span class="keywordtype">char</span> *)ptsname(master)) == NULL ||
00904                 unlockpt(master) ||
00905                 grantpt(master)) {
00906                 close(master);
00907                 fail();
00908         }
00909         (<span class="keywordtype">void</span>) ioctl(master, TIOCFLUSH, NULL);
00910         (<span class="keywordtype">void</span>) tcgetattr(0, &amp;tt);
00911         (<span class="keywordtype">void</span>) ioctl(0, TIOCGWINSZ, (<span class="keywordtype">char</span> *)&amp;win);
00912 }
00913 
00914 getslave()
00915 {
00916         (<span class="keywordtype">void</span>) setsid();
00917         <span class="keywordflow">if</span> ((<a class="code" href="esm_8c.html#a25">slave</a> = open(slave_name, O_RDWR)) &lt; 0) {
00918                 fail();
00919         }
00920         <span class="keywordflow">if</span> (ioctl(slave, I_PUSH, <span class="stringliteral">"ptem"</span>)) {
00921                 fail();
00922         }
00923         <span class="keywordflow">if</span> (ioctl(slave, I_PUSH, <span class="stringliteral">"ldterm"</span>)) {
00924                 fail();
00925         }
00926         <span class="keywordflow">if</span> (ioctl(slave, I_PUSH, <span class="stringliteral">"ttcompat"</span>)) {
00927                 fail();
00928         }
00929         (<span class="keywordtype">void</span>) tcsetattr(slave, TCSAFLUSH, &amp;tt);
00930         (<span class="keywordtype">void</span>) ioctl(slave, TIOCSWINSZ, (<span class="keywordtype">char</span> *)&amp;win);
00931 }
00932 
00933 <span class="preprocessor">#else</span>
00934 <span class="preprocessor"></span>
00935 getmaster()
00936 {
00937         <span class="keywordtype">char</span> *pty, *bank, *cp;
00938         <span class="keyword">struct </span>stat stb;
00939 
00940         pty = &amp;<a class="code" href="esm_8c.html#a35">line</a>[strlen(<span class="stringliteral">"/dev/ptyp"</span>)];
00941         <span class="keywordflow">for</span> (bank = <span class="stringliteral">"pqrstuvwxyz"</span>; *bank; bank++) {
00942                 <a class="code" href="esm_8c.html#a35">line</a>[strlen(<span class="stringliteral">"/dev/pty"</span>)] = *bank;
00943                 *pty = <span class="charliteral">'0'</span>;
00944                 <span class="keywordflow">if</span> (stat(line, &amp;stb) &lt; 0)
00945                         <span class="keywordflow">break</span>;
00946                 <span class="keywordflow">for</span> (cp = <span class="stringliteral">"0123456789abcdef"</span>; *cp; cp++) {
00947                         *pty = *cp;
00948                         <a class="code" href="esm_8c.html#a24">master</a> = open(line, O_RDWR);
00949                         <span class="keywordflow">if</span> (<a class="code" href="esm_8c.html#a24">master</a> &gt;= 0) {
00950                                 <span class="keywordtype">char</span> *tp = &amp;<a class="code" href="esm_8c.html#a35">line</a>[strlen(<span class="stringliteral">"/dev/"</span>)];
00951                                 <span class="keywordtype">int</span> ok;
00952 
00953                                 <span class="comment">/* verify slave side is usable */</span>
00954                                 *tp = <span class="charliteral">'t'</span>;
00955                                 ok = access(line, R_OK|W_OK) == 0;
00956                                 *tp = <span class="charliteral">'p'</span>;
00957                                 <span class="keywordflow">if</span> (ok) {
00958                                         (<span class="keywordtype">void</span>) tcgetattr(0, &amp;tt);
00959                                         (<span class="keywordtype">void</span>) ioctl(0, TIOCGWINSZ, 
00960                                                 (<span class="keywordtype">char</span> *)&amp;win);
00961                                         <span class="keywordflow">return</span>;
00962                                 }
00963                                 (<span class="keywordtype">void</span>) close(master);
00964                         }
00965                 }
00966         }
00967         fprintf(stderr, <span class="stringliteral">"Out of pty's\n"</span>);
00968         fail();
00969 }
00970 
00971 getslave()
00972 {
00973 
00974         <a class="code" href="esm_8c.html#a35">line</a>[strlen(<span class="stringliteral">"/dev/"</span>)] = <span class="charliteral">'t'</span>;
00975         <a class="code" href="esm_8c.html#a25">slave</a> = open(line, O_RDWR);
00976         <span class="keywordflow">if</span> (<a class="code" href="esm_8c.html#a25">slave</a> &lt; 0) {
00977                 perror(line);
00978                 fail();
00979         }
00980         (<span class="keywordtype">void</span>) tcsetattr(slave, TCSAFLUSH, &amp;tt);
00981         (<span class="keywordtype">void</span>) ioctl(slave, TIOCSWINSZ, (<span class="keywordtype">char</span> *)&amp;win);
00982         (<span class="keywordtype">void</span>) setsid();
00983         (<span class="keywordtype">void</span>) ioctl(slave, TIOCSCTTY, 0);
00984 }
00985 
00986 <span class="preprocessor">#endif</span>
00987 <span class="preprocessor"></span>
00988 waitenter()
00989 {
00990         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> b;
00991         <span class="keywordflow">do</span> {
00992                 read(0,&amp;b,1);
00993         } <span class="keywordflow">while</span> (b!=<span class="charliteral">'\r'</span>);
00994         printf(<span class="stringliteral">"\r\n"</span>);
00995 }
00996 
00997 sendhex(fp,c)
00998      FILE *fp;
<a name="l00999"></a><a class="code" href="esm_8c.html#a47">00999</a>      <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> <a class="code" href="esm_8c.html#a47">c</a>;
01000 {
01001         <span class="keyword">static</span> <span class="keywordtype">char</span> <a class="code" href="cfs__fh_8c.html#a34">buf</a>[16];
01002 
01003         sprintf(<a class="code" href="cfs__fh_8c.html#a34">buf</a>,<span class="stringliteral">"%02x"</span>,<a class="code" href="esm_8c.html#a47">c</a>);
01004         <a class="code" href="esm_8c.html#a10">bwrite</a>(fp,<a class="code" href="cfs__fh_8c.html#a34">buf</a>,2);
01005 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Tue Jun 15 09:59:03 2004 for CFS by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.4 </small></address>
</body>
</html>
