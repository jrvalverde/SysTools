<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>CFS: mcgsbox.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.4 -->
<div class="qindex">  <form class="search" action="search.php" method="get">
<a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a>  | <span class="search"><u>S</u>earch&nbsp;for&nbsp;<input class="search" type="text" name="query" value="" size="20" accesskey="s"/></span></form></div>
<h1>mcgsbox.c</h1><a href="mcgsbox_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment"> * The author of this software is Matt Blaze.</span>
00003 <span class="comment"> *              Copyright (c) 1992, 1993, 1994 by AT&amp;T.</span>
00004 <span class="comment"> * Permission to use, copy, and modify this software without fee</span>
00005 <span class="comment"> * is hereby granted, provided that this entire notice is included in</span>
00006 <span class="comment"> * all copies of any software which is or includes a copy or</span>
00007 <span class="comment"> * modification of this software and in all copies of the supporting</span>
00008 <span class="comment"> * documentation for such software.</span>
00009 <span class="comment"> *</span>
00010 <span class="comment"> * This software is subject to United States export controls.</span>
00011 <span class="comment"> *</span>
00012 <span class="comment"> * THIS SOFTWARE IS BEING PROVIDED "AS IS", WITHOUT ANY EXPRESS OR IMPLIED</span>
00013 <span class="comment"> * WARRANTY.  IN PARTICULAR, NEITHER THE AUTHORS NOR AT&amp;T MAKE ANY</span>
00014 <span class="comment"> * REPRESENTATION OR WARRANTY OF ANY KIND CONCERNING THE MERCHANTABILITY</span>
00015 <span class="comment"> * OF THIS SOFTWARE OR ITS FITNESS FOR ANY PARTICULAR PURPOSE.</span>
00016 <span class="comment"> */</span>
00017 
00018 <span class="comment">/*</span>
00019 <span class="comment"> * MacGuffin optimized table initialization and key setup</span>
00020 <span class="comment"> *</span>
00021 <span class="comment"> * 10/3/94 matt blaze</span>
00022 <span class="comment"> */</span>
00023 
00024 
00025 <span class="preprocessor">#include "<a class="code" href="mcg_8h.html">mcg.h</a>"</span>
00026 
00027 <span class="comment">/*</span>
00028 <span class="comment"> * the 8 s-boxes, expanded to put the output bits in the right</span>
00029 <span class="comment"> * places.  note that these are the des s-boxes (in left-right,</span>
00030 <span class="comment"> * not cannonical, order), but with only the "outer" two output</span>
00031 <span class="comment"> * bits.</span>
00032 <span class="comment"> */</span>
<a name="l00033"></a><a class="code" href="mcgsbox_8c.html#a0">00033</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> <a class="code" href="mcgsbox_8c.html#a0">sboxes</a>[8][64] = {
00034 <span class="comment">/* 0 (S1) */</span>
00035         {0x0002, 0x0000, 0x0000, 0x0003, 0x0003, 0x0001, 0x0001, 0x0000,
00036          0x0000, 0x0002, 0x0003, 0x0000, 0x0003, 0x0003, 0x0002, 0x0001,
00037          0x0001, 0x0002, 0x0002, 0x0000, 0x0000, 0x0002, 0x0002, 0x0003,
00038          0x0001, 0x0003, 0x0003, 0x0001, 0x0000, 0x0001, 0x0001, 0x0002,
00039          0x0000, 0x0003, 0x0001, 0x0002, 0x0002, 0x0002, 0x0002, 0x0000,
00040          0x0003, 0x0000, 0x0000, 0x0003, 0x0000, 0x0001, 0x0003, 0x0001,
00041          0x0003, 0x0001, 0x0002, 0x0003, 0x0003, 0x0001, 0x0001, 0x0002,
00042          0x0001, 0x0002, 0x0002, 0x0000, 0x0001, 0x0000, 0x0000, 0x0003},
00043 <span class="comment">/* 1 (S2) */</span>
00044         {0x000c, 0x0004, 0x0004, 0x000c, 0x0008, 0x0000, 0x0008, 0x0004,
00045          0x0000, 0x000c, 0x000c, 0x0000, 0x0004, 0x0008, 0x0000, 0x0008,
00046          0x000c, 0x0008, 0x0004, 0x0000, 0x0000, 0x0004, 0x000c, 0x0008,
00047          0x0008, 0x0000, 0x0000, 0x000c, 0x0004, 0x000c, 0x0008, 0x0004,
00048          0x0000, 0x000c, 0x0008, 0x0008, 0x0004, 0x0008, 0x000c, 0x0004,
00049          0x0008, 0x0004, 0x0000, 0x000c, 0x000c, 0x0000, 0x0004, 0x0000,
00050          0x0004, 0x000c, 0x0008, 0x0000, 0x0008, 0x0004, 0x0000, 0x0008,
00051          0x000c, 0x0000, 0x0004, 0x0004, 0x0000, 0x0008, 0x000c, 0x000c},
00052 <span class="comment">/* 2 (S3) */</span>
00053         {0x0020, 0x0030, 0x0000, 0x0010, 0x0030, 0x0000, 0x0020, 0x0030,
00054          0x0000, 0x0010, 0x0010, 0x0000, 0x0030, 0x0000, 0x0010, 0x0020,
00055          0x0010, 0x0000, 0x0030, 0x0020, 0x0020, 0x0010, 0x0010, 0x0020,
00056          0x0030, 0x0020, 0x0000, 0x0030, 0x0000, 0x0030, 0x0020, 0x0010,
00057          0x0030, 0x0010, 0x0000, 0x0020, 0x0000, 0x0030, 0x0030, 0x0000,
00058          0x0020, 0x0000, 0x0030, 0x0030, 0x0010, 0x0020, 0x0000, 0x0010,
00059          0x0030, 0x0000, 0x0010, 0x0030, 0x0000, 0x0020, 0x0020, 0x0010,
00060          0x0010, 0x0030, 0x0020, 0x0010, 0x0020, 0x0000, 0x0010, 0x0020},
00061 <span class="comment">/* 3 (S4) */</span>
00062         {0x0040, 0x00c0, 0x00c0, 0x0080, 0x0080, 0x00c0, 0x0040, 0x0040,
00063          0x0000, 0x0000, 0x0000, 0x00c0, 0x00c0, 0x0000, 0x0080, 0x0040,
00064          0x0040, 0x0000, 0x0000, 0x0040, 0x0080, 0x0000, 0x0040, 0x0080,
00065          0x00c0, 0x0040, 0x0080, 0x0080, 0x0000, 0x0080, 0x00c0, 0x00c0,
00066          0x0080, 0x0040, 0x0000, 0x00c0, 0x00c0, 0x0000, 0x0000, 0x0000,
00067          0x0080, 0x0080, 0x00c0, 0x0040, 0x0040, 0x00c0, 0x00c0, 0x0080,
00068          0x00c0, 0x00c0, 0x0040, 0x0000, 0x0040, 0x0040, 0x0080, 0x00c0,
00069          0x0040, 0x0080, 0x0000, 0x0040, 0x0080, 0x0000, 0x0000, 0x0080},
00070 <span class="comment">/* 4 (S5) */</span>
00071         {0x0000, 0x0200, 0x0200, 0x0300, 0x0000, 0x0000, 0x0100, 0x0200,
00072          0x0100, 0x0000, 0x0200, 0x0100, 0x0300, 0x0300, 0x0000, 0x0100,
00073          0x0200, 0x0100, 0x0100, 0x0000, 0x0100, 0x0300, 0x0300, 0x0200,
00074          0x0300, 0x0100, 0x0000, 0x0300, 0x0200, 0x0200, 0x0300, 0x0000,
00075          0x0000, 0x0300, 0x0000, 0x0200, 0x0100, 0x0200, 0x0300, 0x0100,
00076          0x0200, 0x0100, 0x0300, 0x0200, 0x0100, 0x0000, 0x0200, 0x0300,
00077          0x0300, 0x0000, 0x0300, 0x0300, 0x0200, 0x0000, 0x0100, 0x0300,
00078          0x0000, 0x0200, 0x0100, 0x0000, 0x0000, 0x0100, 0x0200, 0x0100},
00079 <span class="comment">/* 5 (S6) */</span>
00080         {0x0800, 0x0800, 0x0400, 0x0c00, 0x0800, 0x0000, 0x0c00, 0x0000,
00081          0x0c00, 0x0400, 0x0000, 0x0800, 0x0000, 0x0c00, 0x0800, 0x0400,
00082          0x0000, 0x0000, 0x0c00, 0x0400, 0x0400, 0x0c00, 0x0000, 0x0800,
00083          0x0800, 0x0000, 0x0400, 0x0c00, 0x0400, 0x0400, 0x0c00, 0x0800,
00084          0x0c00, 0x0000, 0x0800, 0x0400, 0x0c00, 0x0000, 0x0400, 0x0800,
00085          0x0000, 0x0c00, 0x0800, 0x0400, 0x0800, 0x0c00, 0x0400, 0x0800,
00086          0x0400, 0x0c00, 0x0000, 0x0800, 0x0000, 0x0400, 0x0800, 0x0400,
00087          0x0400, 0x0000, 0x0c00, 0x0000, 0x0c00, 0x0800, 0x0000, 0x0c00},
00088 <span class="comment">/* 6 (S7) */</span>
00089         {0x0000, 0x3000, 0x3000, 0x0000, 0x0000, 0x3000, 0x2000, 0x1000,
00090          0x3000, 0x0000, 0x0000, 0x3000, 0x2000, 0x1000, 0x3000, 0x2000,
00091          0x1000, 0x2000, 0x2000, 0x1000, 0x3000, 0x1000, 0x1000, 0x2000,
00092          0x1000, 0x0000, 0x2000, 0x3000, 0x0000, 0x2000, 0x1000, 0x0000,
00093          0x1000, 0x0000, 0x0000, 0x3000, 0x3000, 0x3000, 0x3000, 0x2000,
00094          0x2000, 0x1000, 0x1000, 0x0000, 0x1000, 0x2000, 0x2000, 0x1000,
00095          0x2000, 0x3000, 0x3000, 0x1000, 0x0000, 0x0000, 0x2000, 0x3000,
00096          0x0000, 0x2000, 0x1000, 0x0000, 0x3000, 0x1000, 0x0000, 0x2000},
00097 <span class="comment">/* 7 (S8) */</span>
00098         {0xc000, 0x4000, 0x0000, 0xc000, 0x8000, 0xc000, 0x0000, 0x8000,
00099          0x0000, 0x8000, 0xc000, 0x4000, 0xc000, 0x4000, 0x4000, 0x0000,
00100          0x8000, 0x8000, 0xc000, 0x4000, 0x4000, 0x0000, 0x8000, 0xc000,
00101          0x4000, 0x0000, 0x0000, 0x8000, 0x8000, 0xc000, 0x4000, 0x0000,
00102          0x4000, 0x0000, 0xc000, 0x4000, 0x0000, 0x8000, 0x4000, 0x4000,
00103          0xc000, 0x0000, 0x8000, 0x8000, 0x8000, 0x8000, 0x0000, 0xc000,
00104          0x0000, 0xc000, 0x0000, 0x8000, 0x8000, 0xc000, 0xc000, 0x0000,
00105          0xc000, 0x4000, 0x4000, 0x4000, 0x4000, 0x0000, 0x8000, 0xc000}};
00106 
00107 <span class="comment">/*</span>
00108 <span class="comment"> * table s-box outputs, expanded for 16 bit input</span>
00109 <span class="comment"> * this one table includes all 8 sboxes - just mask off</span>
00110 <span class="comment"> * the output bits not in use</span>
00111 <span class="comment"> */</span>
<a name="l00112"></a><a class="code" href="mcgsbox_8c.html#a1">00112</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> <a class="code" href="mcg_8h.html#a19">stable</a>[<a class="code" href="mcg_8h.html#a0">SIZE</a>];
00113 
00114 <span class="comment">/*</span>
00115 <span class="comment"> * we can exploit two features of the s-box input and output</span>
00116 <span class="comment"> * permutations - first, each s-box uses as input two different bits</span>
00117 <span class="comment"> * from each of the three registers in the right side, and, second,</span>
00118 <span class="comment"> * for each s-box there is another-sbox with no common input bits</span>
00119 <span class="comment"> * between them.  therefore we can lookup two s-box outputs in one</span>
00120 <span class="comment"> * probe of the table.  just mask off the approprate input bits</span>
00121 <span class="comment"> * in the table below for each of the three registers and or</span>
00122 <span class="comment"> * together for the table lookup index.</span>
00123 <span class="comment"> *</span>
00124 <span class="comment"> * These are also available in #defines, for better lookup </span>
00125 <span class="comment"> * speed in unrolled loops.</span>
00126 <span class="comment"> */</span>
<a name="l00127"></a><a class="code" href="mcgsbox_8c.html#a2">00127</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> <a class="code" href="mcg_8h.html#a20">lookupmasks</a>[4][3] = {
00128         <span class="comment">/* a   ,   b   ,   c    */</span>
00129         {0x0036, 0x06c0, 0x6900},       <span class="comment">/* s1+s2 */</span>
00130         {0x5048, 0x2106, 0x8411},       <span class="comment">/* s3+s4 */</span>
00131         {0x8601, 0x4828, 0x10c4},       <span class="comment">/* s5+s7 */</span>
00132         {0x2980, 0x9011, 0x022a}};      <span class="comment">/* s6+s8 */</span>
00133 
00134 <span class="comment">/*</span>
00135 <span class="comment"> * this table contains the corresponding output masks for the table</span>
00136 <span class="comment"> * lookup procedure mentioned above.</span>
00137 <span class="comment"> *</span>
00138 <span class="comment"> * similarly available in #defines.</span>
00139 <span class="comment"> */</span>
<a name="l00140"></a><a class="code" href="mcgsbox_8c.html#a3">00140</a> <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> <a class="code" href="mcg_8h.html#a21">outputmasks</a>[4] = {
00141         0x000f,  <span class="comment">/* s1+s2 */</span>
00142         0x00f0,  <span class="comment">/* s3+s4 */</span>
00143         0x3300,  <span class="comment">/* s5+s7 */</span>
00144         0xcc00}; <span class="comment">/* s6+s8 */</span>
00145 
00146 
00147 
00148 <span class="comment">/*</span>
00149 <span class="comment"> * initialize the macguffin s-box tables.</span>
00150 <span class="comment"> * this takes a while, but is only done once.</span>
00151 <span class="comment"> */</span>
<a name="l00152"></a><a class="code" href="mcgsbox_8c.html#a5">00152</a> <a class="code" href="mcgsbox_8c.html#a5">mcg_init</a>()
00153 {
00154         <span class="keywordtype">unsigned</span> <span class="keywordtype">int</span> i,j,<a class="code" href="getpass_8c.html#a3">k</a>;
00155         <span class="keywordtype">int</span> b;
00156         <span class="comment">/*</span>
00157 <span class="comment">         * input permutation for the 8 s-boxes.</span>
00158 <span class="comment">         * each row entry is a bit position from</span>
00159 <span class="comment">         * one of the three right hand registers,</span>
00160 <span class="comment">         * as follows:</span>
00161 <span class="comment">         *   a,a,b,b,c,c</span>
00162 <span class="comment">         */</span>
00163         <span class="keyword">static</span> <span class="keywordtype">int</span> sbits[8][6] = {
00164                 {2,5,6,9,11,13},
00165                 {1,4,7,10,8,14},
00166                 {3,6,8,13,0,15},
00167                 {12,14,1,2,4,10},
00168                 {0,10,3,14,6,12},
00169                 {7,8,12,15,1,5},
00170                 {9,15,5,11,2,7},
00171                 {11,13,0,4,3,9}};
00172 
00173         <span class="comment">/* fill the table */</span>
00174         <span class="keywordflow">if</span> ((<a class="code" href="mcg_8h.html#a19">stable</a>[0]==0xc86e) &amp;&amp; (<a class="code" href="mcg_8h.html#a19">stable</a>[0xffff]==0xedaf))
00175                 <span class="keywordflow">return</span> 0;
00176         <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="mcg_8h.html#a0">SIZE</a>; i++) {
00177                 <a class="code" href="mcg_8h.html#a19">stable</a>[i]=0;
00178                 <span class="keywordflow">for</span> (j=0; j&lt;8; j++)
00179                         <a class="code" href="mcg_8h.html#a19">stable</a>[i] |=
00180                                 <a class="code" href="mcgsbox_8c.html#a0">sboxes</a>[j][((i&gt;&gt;sbits[j][0])&amp;1)
00181                                           |(((i&gt;&gt;sbits[j][1])&amp;1)&lt;&lt;1)
00182                                           |(((i&gt;&gt;sbits[j][2])&amp;1)&lt;&lt;2)
00183                                           |(((i&gt;&gt;sbits[j][3])&amp;1)&lt;&lt;3)
00184                                           |(((i&gt;&gt;sbits[j][4])&amp;1)&lt;&lt;4)
00185                                           |(((i&gt;&gt;sbits[j][5])&amp;1)&lt;&lt;5)];
00186                 
00187         }
00188         <span class="keywordflow">return</span> 1;
00189 }
00190 
00191 <span class="preprocessor">#ifdef SOLARIS2X</span>
00192 <span class="preprocessor"></span><span class="preprocessor">#define bcopy(s,d,l) memcpy(d,s,l)</span>
00193 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
00194 <span class="preprocessor"></span>
00195 <a class="code" href="mcgsbox_8c.html#a6">mcg_keyset</a>(key,ek)
00196      <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> *<a class="code" href="mcg_8c.html#a0">key</a>;
<a name="l00197"></a><a class="code" href="mcgsbox_8c.html#a4">00197</a>      <a class="code" href="structmcg__key.html">mcg_key</a> *<a class="code" href="getpass_8c.html#a1">ek</a>;
00198 {
00199         <span class="keywordtype">int</span> i,j;
00200         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> <a class="code" href="getpass_8c.html#a3">k</a>[2][8];
00201 
00202         <a class="code" href="mcgsbox_8c.html#a5">mcg_init</a>();
00203         bcopy(&amp;<a class="code" href="mcg_8c.html#a0">key</a>[0],<a class="code" href="getpass_8c.html#a3">k</a>[0],8);
00204         bcopy(&amp;<a class="code" href="mcg_8c.html#a0">key</a>[8],<a class="code" href="getpass_8c.html#a3">k</a>[1],8);
00205         <span class="keywordflow">for</span> (i=0; i&lt;<a class="code" href="mcg_8h.html#a18">KSIZE</a>; i++)
00206                 <a class="code" href="getpass_8c.html#a1">ek</a>-&gt;val[i]=0;
00207         <span class="keywordflow">for</span> (i=0; i&lt;2; i++)
00208                 <span class="keywordflow">for</span> (j=0; j&lt;32; j++) {
00209                         <a class="code" href="mcg_8c.html#a1">mcg_block_encrypt</a>(<a class="code" href="getpass_8c.html#a3">k</a>[i],<a class="code" href="getpass_8c.html#a1">ek</a>);
00210                         <a class="code" href="getpass_8c.html#a1">ek</a>-&gt;val[j*3] ^= <a class="code" href="getpass_8c.html#a3">k</a>[i][0] | (<a class="code" href="getpass_8c.html#a3">k</a>[i][1]&lt;&lt;8);
00211                         <a class="code" href="getpass_8c.html#a1">ek</a>-&gt;val[j*3+1] ^= <a class="code" href="getpass_8c.html#a3">k</a>[i][2] | (<a class="code" href="getpass_8c.html#a3">k</a>[i][3]&lt;&lt;8);
00212                         <a class="code" href="getpass_8c.html#a1">ek</a>-&gt;val[j*3+2] ^= <a class="code" href="getpass_8c.html#a3">k</a>[i][4] | (<a class="code" href="getpass_8c.html#a3">k</a>[i][5]&lt;&lt;8);
00213                 }
00214 }       
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Tue Jun 15 09:59:03 2004 for CFS by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.4 </small></address>
</body>
</html>
