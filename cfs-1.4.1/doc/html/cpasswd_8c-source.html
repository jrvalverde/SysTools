<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>CFS: cpasswd.c Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.3.4 -->
<div class="qindex">  <form class="search" action="search.php" method="get">
<a class="qindex" href="index.html">Main&nbsp;Page</a> | <a class="qindex" href="annotated.html">Data&nbsp;Structures</a> | <a class="qindex" href="files.html">File&nbsp;List</a> | <a class="qindex" href="functions.html">Data&nbsp;Fields</a> | <a class="qindex" href="globals.html">Globals</a>  | <span class="search"><u>S</u>earch&nbsp;for&nbsp;<input class="search" type="text" name="query" value="" size="20" accesskey="s"/></span></form></div>
<h1>cpasswd.c</h1><a href="cpasswd_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <span class="comment">/*</span>
00002 <span class="comment"> * The author of this software is Matt Blaze.</span>
00003 <span class="comment"> *              Copyright (c) 1995 by AT&amp;T.</span>
00004 <span class="comment"> * Permission to use, copy, and modify this software without fee</span>
00005 <span class="comment"> * is hereby granted, provided that this entire notice is included in</span>
00006 <span class="comment"> * all copies of any software which is or includes a copy or</span>
00007 <span class="comment"> * modification of this software and in all copies of the supporting</span>
00008 <span class="comment"> * documentation for such software.</span>
00009 <span class="comment"> *</span>
00010 <span class="comment"> * This software is subject to United States export controls.</span>
00011 <span class="comment"> *</span>
00012 <span class="comment"> * THIS SOFTWARE IS BEING PROVIDED "AS IS", WITHOUT ANY EXPRESS OR IMPLIED</span>
00013 <span class="comment"> * WARRANTY.  IN PARTICULAR, NEITHER THE AUTHORS NOR AT&amp;T MAKE ANY</span>
00014 <span class="comment"> * REPRESENTATION OR WARRANTY OF ANY KIND CONCERNING THE MERCHANTABILITY</span>
00015 <span class="comment"> * OF THIS SOFTWARE OR ITS FITNESS FOR ANY PARTICULAR PURPOSE.</span>
00016 <span class="comment"> */</span>
00017 
00018 <span class="comment">/*</span>
00019 <span class="comment"> * client cfs cpasswd - 1.3</span>
00020 <span class="comment"> */</span>
00021 <span class="preprocessor">#include &lt;stdio.h&gt;</span>
00022 <span class="preprocessor">#include &lt;rpc/rpc.h&gt;</span>
00023 <span class="preprocessor">#include &lt;sys/time.h&gt;</span>
00024 <span class="preprocessor">#include "nfsproto.h"</span>
00025 <span class="preprocessor">#include "admproto.h"</span>
00026 <span class="preprocessor">#include "<a class="code" href="cfs_8h.html">cfs.h</a>"</span>
00027 <span class="preprocessor">#include "<a class="code" href="shs_8h.html">shs.h</a>"</span>
00028 
00029 <a class="code" href="esm__gen_8c.html#a0">main</a>(argc,argv)
00030      <span class="keywordtype">int</span> argc;
<a name="l00031"></a><a class="code" href="cpasswd_8c.html#a0">00031</a>      <span class="keywordtype">char</span> **<a class="code" href="cattach_8c.html#a3">argv</a>;
00032 {
00033         <span class="keywordtype">char</span> *pw;
00034         <span class="keywordtype">char</span> pword[256];
00035         <span class="keywordtype">char</span> <a class="code" href="cfs__fh_8c.html#a34">buf</a>[1024];
00036         <span class="keywordtype">char</span> *<a class="code" href="getpass_8c.html#a2">getpassword</a>();
00037         cfs_admkey oldkey;
00038         cfs_admkey newkey;
00039         <a class="code" href="structcfskey.html">cfskey</a> kt;
00040         <span class="keywordtype">char</span> nname[1024];
00041         <span class="keywordtype">char</span> oname[1024];
00042         <span class="keywordtype">char</span> cname[1024];
00043         <span class="keywordtype">char</span> kname[1024];
00044         <span class="keywordtype">char</span> sname[1024];
00045         <span class="keywordtype">char</span> lname[1024];
00046         <span class="keywordtype">char</span> dir[1024];
00047         <span class="keywordtype">int</span> smsize;
00048         FILE *fp;
00049         <span class="keywordtype">char</span> *flg;
00050         <span class="keywordtype">int</span> ciph=CFS_STD_DES;
00051         <span class="keywordtype">int</span> cfmt=1;
00052         <span class="keywordtype">unsigned</span> <span class="keywordtype">char</span> ekey[128];
00053         
00054         <span class="keywordflow">while</span> (--argc &amp;&amp; (**++<a class="code" href="cattach_8c.html#a3">argv</a> == <span class="charliteral">'-'</span>)) {
00055                 <span class="keywordflow">for</span> (flg= ++*<a class="code" href="cattach_8c.html#a3">argv</a>; *flg; ++flg)
00056                         <span class="keywordflow">switch</span> (*flg) {
00057                             <span class="keywordflow">default</span>:
00058                                 fprintf(stderr,<span class="stringliteral">"usage: cpasswd dir\n"</span>);
00059                                 exit(1);
00060                         }
00061         }
00062         <span class="keywordflow">if</span> (argc!=1) {
00063                 fprintf(stderr,<span class="stringliteral">"Usage: cpasswd dir\n"</span>);
00064                 exit(1);
00065         }
00066         <span class="keywordflow">if</span> (*<a class="code" href="cattach_8c.html#a3">argv</a>[0]!=<span class="charliteral">'/'</span>) {
00067                 <span class="keywordflow">if</span> (getcwd(<a class="code" href="cfs__fh_8c.html#a34">buf</a>,1024) == NULL) {
00068                         fprintf(stderr,<span class="stringliteral">"Can't stat current directory\n"</span>);
00069                         exit(1);
00070                 }
00071                 sprintf(dir,<span class="stringliteral">"%s/%s"</span>,<a class="code" href="cfs__fh_8c.html#a34">buf</a>,<a class="code" href="cattach_8c.html#a3">argv</a>[0]);
00072         } <span class="keywordflow">else</span>
00073                 strcpy(dir,<a class="code" href="cattach_8c.html#a3">argv</a>[0]);
00074         sprintf(kname,<span class="stringliteral">"%s/..k"</span>,dir);
00075         sprintf(nname,<span class="stringliteral">"%s/..n"</span>,dir);
00076         sprintf(oname,<span class="stringliteral">"%s/..o"</span>,dir);
00077         sprintf(lname,<span class="stringliteral">"%s/..data"</span>,dir);
00078         <span class="keywordflow">if</span> (chdir(lname) &gt;= 0)
00079                 strcpy(dir,lname);
00080         <span class="keywordflow">else</span> <span class="keywordflow">if</span> (chdir(dir)&lt;0) {
00081                 perror(dir);
00082                 exit(1);
00083         }
00084 
00085         sprintf(cname,<span class="stringliteral">"%s/..c"</span>,dir);
00086         sprintf(sname,<span class="stringliteral">"%s/..s"</span>,dir);
00087         <span class="keywordflow">if</span> ((fp=fopen(cname,<span class="stringliteral">"r"</span>)) == NULL) {
00088                 fprintf(stderr,<span class="stringliteral">"Can only change passphrase on new format CFS directories\n"</span>);
00089                 exit(1);
00090         } <span class="keywordflow">else</span> {
00091                 fscanf(fp,<span class="stringliteral">"%d"</span>,&amp;ciph);
00092                 fclose(fp);
00093         }
00094         <span class="keywordflow">if</span> (((fp=fopen(kname,<span class="stringliteral">"r"</span>)) == NULL) || (fread(ekey,1,32,fp)&lt;16)) {
00095                 perror(dir);
00096                 fprintf(stderr,<span class="stringliteral">"Can only change passphrase on new format CFS directories\n"</span>);
00097                 exit(1);
00098         }
00099         fclose(fp);
00100         <span class="keywordflow">if</span> ((fp=fopen(sname,<span class="stringliteral">"r"</span>)) == NULL) {
00101                 smsize=<a class="code" href="cfs_8h.html#a17">LARGESMSIZE</a>;
00102         } <span class="keywordflow">else</span> {
00103                 <span class="keywordflow">if</span> (fscanf(fp,<span class="stringliteral">"%d"</span>,&amp;smsize) != 1)
00104                         smsize=<a class="code" href="cfs_8h.html#a17">LARGESMSIZE</a>;
00105                 fclose(fp);
00106                 <span class="keywordflow">if</span> ((smsize &lt; CFSBLOCK) || (smsize &gt; (<a class="code" href="cfs_8h.html#a17">LARGESMSIZE</a>*2)))
00107                         smsize=<a class="code" href="cfs_8h.html#a17">LARGESMSIZE</a>;
00108         }
00109 
00110         oldkey.cipher=ciph;
00111         <span class="keywordflow">if</span> ((pw=<a class="code" href="getpass_8c.html#a2">getpassword</a>(<span class="stringliteral">"Old passphrase:"</span>))==NULL) {
00112                 fprintf(stderr,<span class="stringliteral">"Can't get key\n"</span>);
00113                 exit(1);
00114         }
00115         <span class="keywordflow">if</span> (smsize != <a class="code" href="cfs_8h.html#a17">LARGESMSIZE</a>)
00116                 sprintf(pw,<span class="stringliteral">"%s%d"</span>,pw,smsize);
00117         <span class="keywordflow">if</span> (new_pwcrunch(pw,&amp;oldkey)!=0) {
00118                 fprintf(stderr,<span class="stringliteral">"Invalid key\n"</span>);
00119                 exit(1);
00120         }
00121         decrypt_key(&amp;oldkey,ekey);
00122         <span class="keywordflow">if</span> (!checkkey(dir,&amp;oldkey)) {
00123                 fprintf(stderr,<span class="stringliteral">"Incorrect passphrase\n"</span>);
00124                 exit(1);
00125         }
00126 
00127         newkey.cipher=ciph;
00128         <span class="keywordflow">if</span> ((pw=<a class="code" href="getpass_8c.html#a2">getpassword</a>(<span class="stringliteral">"New passphrase:"</span>))==NULL) {
00129                 fprintf(stderr,<span class="stringliteral">"Can't get key\n"</span>);
00130                 exit(1);
00131         }
00132         strcpy(pword,pw);
00133         <span class="keywordflow">if</span> (strlen(pw)&lt;16) {
00134                 fprintf(stderr,<span class="stringliteral">"Key must be at least 16 chars.\n"</span>);
00135                 exit(1);
00136         }
00137         <span class="keywordflow">if</span> ((pw=<a class="code" href="getpass_8c.html#a2">getpassword</a>(<span class="stringliteral">"Again:"</span>))==NULL) {
00138                 fprintf(stderr,<span class="stringliteral">"Can't get key\n"</span>);
00139                 exit(1);
00140         }
00141         <span class="keywordflow">if</span> (strcmp(pword,pw)!=0) {
00142                 fprintf(stderr,
00143                         <span class="stringliteral">"Keys don't match; drink some coffee and try again\n"</span>);
00144                 exit(1);
00145         }
00146         <span class="keywordflow">if</span> (smsize != <a class="code" href="cfs_8h.html#a17">LARGESMSIZE</a>)
00147                 sprintf(pw,<span class="stringliteral">"%s%d"</span>,pw,smsize);
00148         <span class="keywordflow">if</span> (new_pwcrunch(pw,&amp;newkey)!=0) {
00149                 fprintf(stderr,<span class="stringliteral">"Invalid key\n"</span>);
00150                 exit(1);
00151         }
00152         encrypt_key(&amp;newkey,ekey);
00153         <span class="keywordflow">if</span> ((fp=fopen(nname,<span class="stringliteral">"w"</span>)) == NULL) {
00154                 perror(<span class="stringliteral">"cmkdir"</span>);
00155                 exit(1);
00156         }
00157         <span class="keywordflow">if</span> (fwrite(ekey,1,32,fp) != 32) {
00158                 perror(<span class="stringliteral">"can't create new key file"</span>);
00159                 exit(1);
00160         }
00161         fclose(fp);
00162         <span class="comment">/* do this in 3 phases, ultra paranoid */</span>
00163         <span class="keywordflow">if</span> (rename(kname,oname) &lt; 0) {
00164                 perror(<span class="stringliteral">"can't rename old key file"</span>);
00165                 exit(1);
00166         }
00167         <span class="keywordflow">if</span> (rename(nname,kname) &lt; 0) {
00168                 perror(<span class="stringliteral">"can't link new key file"</span>);
00169                 exit(1);
00170         }
00171         <span class="keywordflow">if</span> (unlink(oname)&lt;0)
00172                 perror(<span class="stringliteral">"warning: old key file not removed"</span>);
00173         exit(0);
00174 }
00175 
00176 
00177 checkkey(path,ak)
00178      <span class="keywordtype">char</span> *path;
<a name="l00179"></a><a class="code" href="cpasswd_8c.html#a1">00179</a>      cfs_admkey *<a class="code" href="cpasswd_8c.html#a1">ak</a>;
00180 {
00181         FILE *fp;
00182         <span class="keywordtype">char</span> <a class="code" href="cfs__fh_8c.html#a36">fn</a>[1024];
00183         <span class="keywordtype">char</span> <a class="code" href="cfs__fh_8c.html#a34">buf</a>[9];
00184         <a class="code" href="structcfskey.html">cfskey</a> <a class="code" href="getpass_8c.html#a3">k</a>;
00185         
00186         copykey(<a class="code" href="cpasswd_8c.html#a1">ak</a>,&amp;<a class="code" href="getpass_8c.html#a3">k</a>);
00187         sprintf(<a class="code" href="cfs__fh_8c.html#a36">fn</a>,<span class="stringliteral">"%s/..."</span>,path);
00188         <span class="keywordflow">if</span> ((fp=fopen(<a class="code" href="cfs__fh_8c.html#a36">fn</a>,<span class="stringliteral">"r"</span>))==NULL)
00189                 <span class="keywordflow">return</span> 0;
00190         <span class="keywordflow">if</span> (fread(<a class="code" href="cfs__fh_8c.html#a34">buf</a>,8,1,fp)!=1) {
00191                 fclose (fp);
00192                 <span class="keywordflow">return</span> 0;
00193         }
00194         fclose (fp);
00195         <a class="code" href="cfs__cipher_8c.html#a3">cipher</a>(&amp;<a class="code" href="getpass_8c.html#a3">k</a>,<a class="code" href="cfs__fh_8c.html#a34">buf</a>,1);        <span class="comment">/* note order here */</span>
00196         mask_cipher(&amp;<a class="code" href="getpass_8c.html#a3">k</a>,<a class="code" href="cfs__fh_8c.html#a34">buf</a>,0);
00197         <a class="code" href="cfs__cipher_8c.html#a3">cipher</a>(&amp;<a class="code" href="getpass_8c.html#a3">k</a>,<a class="code" href="cfs__fh_8c.html#a34">buf</a>,1);        <span class="comment">/* note order here */</span>
00198         <span class="keywordflow">if</span> (bcmp(<a class="code" href="cfs__fh_8c.html#a34">buf</a>,<span class="stringliteral">"qua!"</span>,4)!=0)
00199                 <span class="keywordflow">return</span> 0;
00200         <span class="keywordflow">return</span> 1;
00201 }
</pre></div><hr size="1"><address style="align: right;"><small>Generated on Tue Jun 15 09:59:03 2004 for CFS by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 > 
</a>1.3.4 </small></address>
</body>
</html>
