<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<html class="regenabled jsenabled"><head>









<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<script type="text/JavaScript" src="lib_interposers%20Files/cookie_get.js"></script>
<title>Debugging and Performance Tuning with Library Interposers</title>
<meta name="collection" content="reference">
<meta name="keywords" content="Article covers: Data Structure, Getting Started, Data Types, kstat Names, Functions, Dealing with Chain Updates, and more.">
<meta name="description" content="Article covers: Data Structure, Getting Started, Data Types, kstat Names, Functions, Dealing with Chain Updates, and more.">
<meta http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<meta name="date" content="2001-07-01">
<link rel="stylesheet" href="lib_interposers%20Files/default_developer.css">
<script language="JavaScript" type="text/javascript" src="lib_interposers%20Files/popUp.js"></script>
<script language="javascript1.2" type="text/javascript" src="lib_interposers%20Files/sniff.js"></script>
<script language="javascript1.2" type="text/javascript" src="lib_interposers%20Files/menucontent.js"></script>
<script language="javascript1.2" type="text/javascript" src="lib_interposers%20Files/menucode.js"></script>
<script language="javascript1.2" type="text/javascript" src="lib_interposers%20Files/developer.js"></script>
<!--stopindex-->
</head><body leftmargin="0" topmargin="0" rightmargin="0" onload="prepmenus(); done=true" bgcolor="#ffffff" marginheight="0" marginwidth="0">
<a name="top"></a>
<!-- BEGIN GENERIC MASTHEAD -->
<!-- BEGIN A1 COMPONENT V.0 -->
<div class="a1 a1r2">
<div class="a1v0">
<a href="#skip2content" class="skiplink">Skip to Content</a>
<span class="toolbarlinks">
<a class="karrow k2over a1menu1 y3 x-6" href="http://developers.sun.com/global/mh/suncom/index.html">Sun</a><div id="a1menu1" class="a1menu a1Large"><div class="a1menux1"></div>
<div class="a1menuw2"><div class="a1menuw1">
<div class="a1-2colwrap"><div class="a1-2colul"><ul class="bluearrows"><li><a href="http://www.sun.com/">Sun.com</a></li><li><a href="http://www.sun.com/aboutsun/">About Sun</a></li><li><a href="http://www.sun.com/download/">Downloads</a></li><li><a href="http://www.sun.com/products/">Products</a></li></ul><ul class="bluearrows"><li><a href="http://www.sun.com/servicessolutions/">Solutions</a></li><li><a href="http://sunsolve.sun.com/pub-cgi/show.pl?target=tous">Support</a></li><li><a href="http://www.sun.com/training/">Training</a><p></p></li></ul></div></div><br class="clear"></div><div class="a1menux2"></div></div></div>
<a class="karrow k2over a1menu2 y3 x-6" href="http://developers.sun.com/global/mh/java/">Java</a><div id="a1menu2" class="a1menu a1Large"><div class="a1menux1"></div>
<div class="a1menuw2"><div class="a1menuw1">
<div class="a1-2colwrap"><div class="a1-2colul"><ul class="bluearrows"><li><a href="http://java.com/download/">Java for your computer</a><p>Stay up to date with the latest versions of Java for your desktop computer.</p></li><li><a href="http://www.sun.com/software/opensource/java/">Free and Open Source Java</a><p>Get your own copy of the underlying software code for the Java language.</p></li><li><a href="http://java.sun.com/javase/downloads/">Download the latest JDK</a><p>The basic developer kit for Java developers.</p></li><li><a href="http://java.sun.com/javaee/downloads/">Download the Java EE SDK</a><p>The SDK supports Java SE 6 and the latest Java EE 5 technologies.</p></li><li><a href="http://download.netbeans.org/netbeans/6.0/final/">Download NetBeans IDE</a><p>Get the award-winning, open-source tool suite for developing Java applications.</p></li><li><a href="http://java.sun.com/">Java Developer Resources</a><p>Visit java.sun.com for everything you need to know about the Java technology.</p></li></ul><ul class="bluearrows"><li><a href="http://developers.sun.com/prodtech/javatools/">Java Developer Tools</a><p>See and download all software tools available from Sun.</p></li><li><a href="http://java.sun.com/javase/">Java Standard Edition</a><p>For developing and deploying Java applications for the desktop, servers, embedded, and real-time environments.</p></li><li><a href="http://java.sun.com/javaee/">Java Enterprise Edition</a><p>For enterprise, server-side Java applications.</p></li><li><a href="http://java.sun.com/javame/">Java Micro Edition</a><p>For Java applications running on mobile devices.</p></li><li><a href="http://java.sun.com/learning/training/">Java Training</a><p>Sharpen your Java skills with courses from the source.</p></li><li><a href="http://developers.sun.com/services/">Java Support</a><p>Get dedicated help from Sun including technical assistance, product support, and support for deployed Java applications.</p></li></ul></div></div><br class="clear"></div><div class="a1menux2"></div></div></div>
<a class="karrow k2over a1menu3 y3 x-6" href="http://developers.sun.com/global/mh/solaris/">Solaris</a><div id="a1menu3" class="a1menu a1Medium"><div class="a1menux1"></div>
<div class="a1menuw2"><div class="a1menuw1">
<ul class="bluearrows"><li><a href="http://www.sun.com/software/solaris/get.jsp">Solaris</a><p>Download the most advanced operating system in the world</p></li><li><a href="http://developers.sun.com/sunstudio/">Sun Studio</a><p>Optimizing compilers and tools for C/C++/Fortran application development</p></li><li><a href="http://developers.sun.com/solaris/">Solaris Developer Center</a><p>Explore the resources and community available to the Solaris developer.</p></li><li><a href="http://developers.sun.com/services/">Sun Developer Services</a><p>Get technical assistance, product support, training, and other services from the source.</p></li><li><a href="http://www.sun.com/bigadmin/home/index.html">BigAdmin</a><p>A
community site with Solaris system administration information, hardware
compatibility, a script library, and other resources for administrators
of Sun products.</p></li><li><a href="http://www.opensolaris.org/">OpenSolaris</a><p>Join the open-source community for collaboration and conversation around the OpenSolaris technology.</p></li></ul></div><div class="a1menux2"></div></div></div>
<a href="http://developers.sun.com/global/mh/communities/" class="dividelink karrow k2over a1menu4 y3 x-6">Communities</a><div id="a1menu4" class="a1menu a1Large"><div class="a1menux1"></div>
<div class="a1menuw2"><div class="a1menuw1">
<div class="a1-2colwrap"><div class="a1-2colul"><ul class="bluearrows"><li><a href="https://openjdk.dev.java.net/">OpenJDK</a><p>The place to collaborate on the open-source JDK, an implementation of the Java Platform, Standard Edition specification.</p></li><li><a href="http://community.java.net/mobileandembedded/">Mobile &amp; Embedded </a><p>The
Mobile &amp; Embedded Community enables and empowers developers to
collaborate and innovate, driving the evolution and adoption of the
Java(TM) Platform, Micro Edition (Java ME) for mobile and embedded
devices.</p></li><li><a href="http://glassfish.dev.java.net/">GlassFish</a><p>The GlassFish community is building free, open source, production-quality, enterprise software.</p> </li><li><a href="http://netbeans.org/">NetBeans</a><p>You
have the opportunity to submit bugs and feature requests in IssueZilla,
submit news for the NetBeans Community, and contribute code or even
create a project of your own. Welcome to the team!</p></li><li><a href="http://www.sun.com/software/opensource/opensolaris.jsp">OpenSolaris</a><p>The OpenSolaris source code is already cutting edge, but innovation happens everywhere, so we welcome your involvement.</p></li><li><a href="http://www.opensparc.net/">OpenSPARC</a><p>OpenSPARC.net
is the genesis of a vision to create a larger community where open
conversations and collaborative development projects spawn dramatic
innovations around chip design.</p></li></ul><ul class="bluearrows"><li><a href="http://developers.sun.com/openstorage/">Open Storage</a><p>The
OpenSolaris storage community is your gateway to data management
related communities and projects - file sharing, file systems, volume
managers, data services, storage drivers, and much more.</p></li><li><a href="https://openjfx.dev.java.net/">OpenJFX</a><p>Project
OpenJFX is a community for sharing early versions of the JavaFX Script
language and for collaborating on its development.</p></li><li><a href="http://java.net/">java.net</a><p>A gathering place for Java technology enthusiasts and existing communities across industries, platforms, and interest groups.</p></li><li><a href="http://developers.sun.com/learning/academic/">Sun Student Developers</a><p>The SDN Academic Developer Program offers you ready access to tools, resources, and student communities.</p></li><li><a href="http://jcp.org/">Java Community Process</a><p>The
JCP gives you a chance to both have your own work become an official
component of the Java platform, and to offer suggestions for improving
and growing the technology.</p></li></ul></div></div><br class="clear"></div><div class="a1menux2"></div></div></div>
<a class="karrow k2over a1menu5 y3 x-6" href="http://developers.sun.com/global/my_profile.html">My SDN Account</a><div id="a1menu5" class="a1menu a1Small"><div class="a1menux1"></div>
<div class="a1menuw2"><div class="a1menuw1">
<ul class="bluearrows"><li><a href="https://reg.sun.com/updateaccount?program=sdn&amp;goto=http://developers.sun.com">Update My Profile</a></li></ul></div><div class="a1menux2"></div></div></div>
<a href="http://developers.sun.com/global/join_sdn.html" class="dividelink karrow k2over a1menu6 y3 x-6">Join SDN</a><div id="a1menu6" class="a1menu a1Medium"><div class="a1menux1"></div>
<div class="a1menuw2"><div class="a1menuw1">
<ul class="bluearrows"><li><a href="https://reg.sun.com/register?program=sdn">Join SDN Now</a></li><li><a href="http://developers.sun.com/user_registration/whyregister.jsp">Why Join</a><p>Becoming
an Sun Developer Network (SDN) member makes you part of a vibrant
worldwide community of developers, and gives you access to cool stuff
and exclusive offers.</p></li></ul></div><div class="a1menux2"></div></div></div>
</span>
</div>
</div>
<!-- END A1 COMPONENT V.0 -->

<!-- BEGIN A2 COMPONENT V.1 -->
<div class="a2w0">
<div class="a2" id="a2v1">
<div class="a2w1"><div class="a2w2"><div class="a2w3"><div class="a2w4">
<div class="a2topiclinks">
<div class="a2search">
<form action="http://developers.sun.com/search/onesearch/index.jsp" accept-charset="utf-8" method="get">
<input name="charset" value="utf-8" type="hidden">
<input name="col" value="developer-reference" type="hidden">
<span class="rightarrowwhite">»</span> <a href="http://developers.sun.com/global/search_tips.html">search tips</a> 
<input name="qt" class="searchfield" size="7" onfocus="if( this.value==this.defaultValue ) this.value='';" value="Search">
<input id="searchbttn" src="lib_interposers%20Files/a2_bttn_search.gif" alt="Submit Search" type="image" border="0">
</form>
</div>
<a href="http://www.sun.com/" title="Home Page" id="sunlogo"><img src="lib_interposers%20Files/a.gif" alt="Home Page" border="0" width="98" height="58"></a>
<a href="http://developers.sun.com/" title="Sun Developer Network"><img src="lib_interposers%20Files/a.gif" id="venuespacer" alt="Sun Developer Network" border="0" width="400" height="33"></a>
<ul id="mtopics">
<li id="mtopic1"><a id="glink1" class="tpclink a2menu" title="See All APIs" href="http://developers.sun.com/global/mh/api/index.html">APIs</a><div style="margin-left: -20px;" class="a2m"><ul><li class="firstchild"><a href="http://java.sun.com/reference/api/">Java SE</a></li>
<li><a href="http://java.sun.com/javaee/reference/">Java EE</a></li>
<li><a href="http://java.sun.com/javame/reference/apis.jsp">Java ME</a></li>
<li><a href="http://developers.sun.com/solaris/reference/docs/">Solaris</a></li>
<li><a href="http://developers.sun.com/sunstudio/reference/docs/">Sun Studio Compilers &amp; Tools</a></li>
<li><a href="http://java.sun.com/webservices/reference/api/">Web Services</a></li>
<li><a href="http://java.sun.com/products/javacard/reference/docs/">Java Card</a></li>
<li><a href="http://developers.sun.com/global/mh/api/index.html">See All »</a></li></ul></div></li>
<li id="mtopic2"><a id="glink2" class="tpclink a2menu" title="See All Downloads" href="http://developers.sun.com/global/mh/downloads/index.html">Downloads</a><div style="margin-left: -20px;" class="a2m"><ul><li class="firstchild"><a href="http://java.sun.com/downloads/ea/">Early Access</a></li>
<li><a href="http://java.sun.com/javase/downloads/">Java SE</a></li>
<li><a href="http://java.sun.com/javaee/downloads/">Java EE</a></li>
<li><a href="http://java.sun.com/javame/downloads/">Java ME</a></li>
<li><a href="http://java.sun.com/javafx/downloads/">JavaFX</a></li>
<li><a href="http://developers.sun.com/solaris/downloads/">Solaris</a></li>
<li><a href="http://download.netbeans.org/netbeans/6.0/final/">NetBeans</a></li>
<li><a href="http://developers.sun.com/sunstudio/downloads/">Sun Studio Compilers &amp; Tools</a></li>
<li><a href="http://www.sun.com/software/products/mysql/getit.jsp">MySQL</a></li>
<li><a href="http://developers.sun.com/global/mh/downloads/index.html">See All »</a></li></ul></div></li>
<li id="mtopic3"><a id="glink3" class="tpclink a2menu" title="See All Products" href="http://developers.sun.com/global/mh/products/index.html">Products</a><div style="margin-left: -20px;" class="a2m"><ul><li class="firstchild"><a href="http://java.sun.com/javase/">Java SE</a></li>
<li><a href="http://java.sun.com/javaee/">Java EE</a></li>
<li><a href="http://java.sun.com/javame/">Java ME</a></li>
<li><a href="http://java.sun.com/javafx/">JavaFX</a></li>
<li><a href="http://developers.sun.com/web/scripting/">Scripting</a></li>
<li><a href="http://developers.sun.com/solaris/">Solaris</a></li>
<li><a href="http://developers.sun.com/sunstudio/">Sun Studio Compilers &amp; Tools</a></li>
<li><a href="http://www.netbeans.org/">NetBeans IDE </a></li>
<li><a href="http://developers.sun.com/openstorage/">Open Storage</a></li>
<li><a href="http://developers.sun.com/mobility/">Mobility</a></li>
<li><a href="http://www.sun.com/software/products/mysql/index.jsp">MySQL</a></li>
<li><a href="http://developers.sun.com/javadb/">Java DB</a></li>
<li><a href="http://developers.sun.com/global/mh/products/index.html">See All »</a></li></ul></div></li>
<li id="mtopic4"><a id="glink4" class="tpclink a2menu" title="See All Support" href="http://developers.sun.com/global/mh/support/index.html">Support</a><div style="margin-left: -20px;" class="a2m"><ul><li class="firstchild"><a href="http://www.sun.com/bigadmin/home/?intcmp=1394">Big Admin</a></li>
<li><a href="http://developers.sun.com/services/">Developer Services</a></li>
<li><a href="http://forum.java.sun.com/index.jspa">Forums</a></li>
<li><a href="http://developers.sun.com/global/">Globalization</a></li>
<li><a href="http://developers.sun.com/global/mh/support/index.html">See All »</a></li></ul></div></li>
<li id="mtopic5"><a id="glink5" class="tpclink a2menu" title="See All Training" href="http://developers.sun.com/global/mh/training/index.html">Training</a><div style="margin-left: -20px;" class="a2m"><ul><li class="firstchild"><a href="http://www.sun.com/training/certification/index.xml?intcmp=1394">Certification</a></li>
<li><a href="http://www.sun.com/training/catalog/developer.xml?intcmp=1394">Developer Training</a></li>
<li><a href="http://developers.sun.com/global/mh/training/index.html">See All »</a></li></ul></div></li>
<li id="mtopic6"><a id="glink6" class="tpclink a2menu" title="See All Participate" href="http://developers.sun.com/global/mh/participate/index.html">Participate</a><div style="margin-left: -20px;" class="a2m"><ul><li class="firstchild"><a href="http://forum.java.sun.com/index.jspa">Forums</a></li>
<li><a href="http://blogs.sun.com/">Blogs</a></li>
<li><a href="http://developers.sun.com/sdnshare/">SDN Share</a></li>
<li><a href="http://wikis.sun.com/">Wikis</a></li>
<li><a href="http://java.sun.com/community/usergroups/">Java User Groups</a></li>
<li><a href="http://developers.sun.com/newsletters/index.html">Newsletters</a></li>
<li><a href="http://developers.sun.com/global/mh/participate/index.html">See All »</a></li></ul></div></li>
</ul>
</div>
</div></div></div></div>
</div></div>
<!-- END A2 COMPONENT V.1 -->
<!-- END GENERIC MASTHEAD -->
<!-- BEGIN BREADCRUMB -->
<table class="vatop" border="0" cellpadding="0" cellspacing="0" width="100%">
<tbody><tr>
<td>      
<div class="breadcrumb">
<a href="http://developers.sun.com/index.html">Developers Home</a> &gt; <a href="http://developers.sun.com/solaris/">Solaris</a> &gt; <a href="http://developers.sun.com/solaris/reference/">Reference</a> &gt; <a href="http://developers.sun.com/solaris/reference/techart/">Technical Articles and Tips</a> &gt;
</div>
</td>
<td align="right" nowrap="nowrap"><div class="breadcrumb">
</div></td></tr>
<tr><td colspan="2"><img src="lib_interposers%20Files/a.gif" alt=" " border="0" width="770" height="1"></td></tr>
</tbody></table>
<span class="sp5"> </span><br>
<!-- END BREADCRUMB -->
<!-- BEGIN PAGETITLE -->
<div class="pagetitle2">Article</div>
<div id="sharepage" class="smallpagetitle"><h1>Debugging and
Performance Tuning with Library Interposers (Originally published in
Unix Insider under the title "Building library interposers for fun and
profit", July 2001)</h1><div class="sharepage">		<div class="sharepagew1 share-mailto">		<table summary="layout" cellpadding="0" cellspacing="0"><tbody><tr>		<td id="share-mailto"><a href="mailto:?subject=Sun%20Web%20Page:%20Debugging%20and%20Performance%20Tuning%20with%20Library%20Interposers%20%28Originally%20published%20in%20Unix%20Insider%20under%20the%20title" building="" library="" interposers="" for="" fun="" and="" profit="" ,="" july="" 2001)&body="Check" out="" this="" page="" on="" sun.com:="" %0a%0ahttp%3a%2f%2fdevelopers.sun.com%2fsolaris%2farticles%2flib_interposers.html="" class="sharelink mailto" title="Email this page to a friend"></a></td>		<td id="share-technorati"><a href="http://www.technorati.com/search/http%3A%2F%2Fdevelopers.sun.com%2Fsolaris%2Farticles%2Flib_interposers.html" class="sharelink technorati" title="See who links to this page on Technorati"></a></td>		<td id="share-delicious"><a href="http://del.icio.us/post?v=4;url=http%3A%2F%2Fdevelopers.sun.com%2Fsolaris%2Farticles%2Flib_interposers.html;title=Debugging%20and%20Performance%20Tuning%20with%20Library%20Interposers" class="sharelink delicious" title="Bookmark this page in del.icio.us"></a></td>		<td id="share-digg"><a href="http://digg.com/submit?phase=2&amp;url=http%3A%2F%2Fdevelopers.sun.com%2Fsolaris%2Farticles%2Flib_interposers.html&amp;title=Debugging%20and%20Performance%20Tuning%20with%20Library%20Interposers" class="sharelink digg" title="Submit this page to Digg"></a></td>		<td id="share-slashdot"><a href="http://slashdot.org/bookmark.pl?title=Debugging%20and%20Performance%20Tuning%20with%20Library%20Interposers&amp;url=http%3A%2F%2Fdevelopers.sun.com%2Fsolaris%2Farticles%2Flib_interposers.html" class="sharelink slashdot" title="Submit this page to Slashdot"></a></td>		<td id="share-blank"> </td></tr></tbody></table></div></div></div>
<!-- END PAGETITLE -->
<!-- BEGIN WRAPPER TABLE, 2 COLUMN, MAIN/RIGHT -->
<table border="0" cellpadding="10" cellspacing="0" width="100%">
<tbody><tr><td valign="top" width="100%">
<!-- BEGIN CENTRAL COLUMN COMPONENTS -->
<!--startindex-->
<!-- ============ -->
<!-- MAIN CONTENT -->
<!-- ============ -->
<a name="skip2content"></a>
<!--  BEGIN VCD4 PFV  -->
<table border="0" cellpadding="0" cellspacing="0" width="100%">
<tbody><tr>
<td class="smaller" valign="top"><em></em></td>
<td width="10"> </td>
<td align="right" valign="bottom"><div class="sitelinks" style="padding: 0px;">
<table border="0" cellpadding="0" cellspacing="0">
<tbody><tr>
<td align="right" valign="bottom"> </td>
<td class="smaller" valign="bottom" nowrap="nowrap"><a href="http://developers.sun.com/jsp_utils/PrintPage.jsp" target="printFriendlyView" onclick="openPopup('','printFriendlyView',710,650,'no',1,1,0,0,0,0); return true;"><img src="lib_interposers%20Files/ic_print.gif" alt="Print-friendly Version" border="0" width="14" height="12" hspace="4">Print-friendly Version</a><br></td>
</tr></tbody></table></div>
</td></tr>
</tbody></table>
<!--  END VCD4 PFV -->
<table border="0" cellpadding="0" cellspacing="0" width="100%">
<tbody><tr><td class="smaller" valign="top"><em>
By <a href="#author">Greg Nakhimovsky</a>, July 2001
</em></td>
<td width="10"> </td>
<td align="right" valign="bottom">
<div class="sitelinks" style="padding: 0px;">
<table border="0" cellpadding="0" cellspacing="0">
<tbody><tr>
<!--
<td valign="bottom" align="right"><img src="/im/ic_email.gif" width="14" height="12" border="0" hspace="4" vspace="1" alt=" " /></td>
<td valign="bottom" class="smaller" nowrap="nowrap"><a href="#{link placeholder}">E-mail</a></td>
<td>&nbsp;&nbsp;</td>
<td valign="bottom" align="right">&nbsp;</td>
<td valign="bottom" class="smaller" nowrap="nowrap"><a href="/jsp_utils/PrintPage.jsp" target="printFriendlyView" onclick="openPopup('','printFriendlyView',710,650,'no',1,1,0,0,0,0); return true;"><img src="/im/ic_print.gif" width="14" height="12" alt="Print-friendly Version" border="0" hspace="4" />Print-friendly Version</a></td>
<td>&nbsp;&nbsp;</td>
<td valign="bottom" align="right"><img src="/im/ic_download_thin.gif" width="9" height="14" hspace="4" border="0" alt=" " /></td>
<td valign="bottom" class="smaller" nowrap="nowrap"><a href="#{link placeholder}">Download</a></td>
-->
</tr>
</tbody></table>
</div>
</td></tr>
</tbody></table>
<div class="contentdivider"><table class="grey4" border="0" cellpadding="0" cellspacing="0" width="100%">
<tbody><tr><td><img src="lib_interposers%20Files/a.gif" alt=" " border="0" width="1" height="4"></td></tr></tbody></table></div>
<!--  END VCD4 BYLINE AND TOOLS  -->
<h4>Summary</h4> 
<br>
<p>
Library interposition is a useful technique for tuning performance, collecting 
runtime statistics, or debugging applications. This article offers helpful 
tips and tools for working with the technique, and gets you started on your own 
interposer.
</p>
<p>
Most of today's applications use shared libraries and dynamic linking,
especially for such system libraries as the standard C library (<code>libc</code>), or the X Windows or OpenGL libraries. Operating system vendors encourage this method because it provides many advantages. 
</p>
<p>
With dynamic linking, you can intercept any function call an
application makes to any shared library. Once you intercept it, you can
do whatever you want in that function, as well as call the real
function the application originally intended to call.
</p><p>
</p><p>Performance tuning is one use of this technology. Even if you
have access to profilers and other development tools, or the
application's source code itself, having your own library interposer
puts you completely in control. You can see exactly what you're doing
and make adjustments at any time. </p>
<a name="return1"></a><h4>Building and running your first interposer</h4> 
<br>
<p>
To use library interposition, you need to create a special shared library and 
set the <code>LD_PRELOAD</code> environment variable. When <code>LD_PRELOAD</code> is set, the dynamic linker will use the specified library before any other when it searches for shared libraries. 
</p>
<p>
Let's create a simple interposer for <code>malloc()</code>, which is normally a part of <code>/usr/lib/libc.so.1</code>, the standard C library. A message, displaying the argument passed to each <code>malloc()</code> call, will be printed out each time the application calls <code>malloc()</code>.
</p>
<p>
Here's the source for this interposer:
</p>
<p>
<a linkid="A-040393-000" href="http://developers.sun.com/solaris/articles/lib_interposers_code.html#malloc_interposer.c" target="_blank"><code>malloc_interposer.c</code></a><br> 
In the above example, <code>func</code> is a function pointer to the real <code>malloc()</code> routine, which is in <code>/usr/lib/libc.so.1</code>. The <code>RTLD_NEXT</code> argument passed to <code>dlsym(3X)</code> tells the dynamic linker to find the next reference to the specified function, using the normal dynamic linker search sequence.
</p>
<p>
Now let's build and run this interposer, using <code>ls(1)</code> as our sample application. We'll use the C-shell syntax for this and other examples. 
</p>
<pre>% cc -o malloc_interposer.so -G -Kpic malloc_interposer.c
% setenv LD_PRELOAD $cwd/malloc_interposer.so
% ls -l malloc_interposer.so
malloc(64) is called
malloc(52) is called
malloc(1072) is called
-rwxr-xr-x  1 gregn  5224 Aug 3 15:21 malloc_interposer.so*
% unsetenv LD_PRELOAD
</pre>
<p>
Without access to the source code of <code>ls(1)</code>, and without rebuilding it in any way, you've just discovered which arguments the application uses to call <code>malloc()</code> in the test run.
</p>
<p>
Note that <code>LD_PRELOAD</code> must specify the full path to the interposer library, and that library interposition is disabled for <code>setuid</code> programs in order to prevent security problems.
</p>
<a name="return2"></a><h4>Collecting runtime statistics</h4> 
<p>
Here's a more practical example of library interposition on <code>malloc()</code>, as well as on a few other routines. It collects statistics about the size of the memory blocks requested with the calls to <code>malloc()</code>, <code>calloc()</code>, and <code>realloc()</code>, and prints out a histogram detailing their use upon exiting the application.  
</p>
<p>
Here's the source code:
</p>
<p>
<a linkid="A-040393-001" href="http://developers.sun.com/solaris/articles/lib_interposers_code.html#malloc_hist.c" target="_blank"><code>malloc_hist.c</code></a>
</p>
<p>
Note that we round up all memory-request sizes to the next power of
two. To obtain the name of the current executable, we use the <code>proc(4)</code> interface. The version of the <code>proc(4)</code> interface used here works with the Solaris operating environment beginning with version 2.6.
</p>
<p>
We can run this interposer with the CDE editor <code>dtpad</code> as the test application. 
</p>
<pre>% setenv LD_PRELOAD $cwd/malloc_hist.so
% dtpad malloc_hist.c
% unsetenv LD_PRELOAD
</pre>
<p>
Here are the results.
</p>
<pre>% cat /tmp/malloc_histogram.dtpad.15203
prog_name=dtpad.15203
******** malloc **********
         1              76
         2             105
         4             450
         8             667
        16            2047
        32             620
        64             158
       128              39
       256              33
       512              22
      1024              32
      2048              10
      4096              14
      8192              46
     32768               2
    131072               3
******** calloc **********
         1               0
         2               0
         4            1676
         8              40
        16              21
        32              12
        64              34
       128               4
       256               2
       512               0
      1024               3
      8192               7
******** realloc **********
         1               0
         2               0
         4               2
         8               2
        16              11
        32              11
        64              14
       128               1
       256               0
       512               0 
</pre>
<p>
If the application invokes more than one executable, you'll get a histogram in the <code>/tmp</code> directory for each.
</p>
<p>
Such histograms can be quite useful in application performance tuning. We now know that <code>dtpad</code> (as used in this session) calls <code>malloc()</code> to request 16-byte memory blocks more often than it requests other sizes. 
</p>
<p>
This tool has been used with many real applications. It revealed that most of one application's <code>malloc()</code> requests were for blocks of four bytes or less. There are two performance problems with this pattern. 
</p>
<p>
First of all, most <code>malloc()</code> implementations, including the default Solaris <code>malloc(3C)</code>, will waste a lot of memory when used this way. <code>malloc(3C)</code> uses eight bytes of overhead for each memory block it returns to the caller. When the application calls <code>malloc</code>, requesting only four bytes of memory, the <code>malloc()</code>
overhead is twice as large as the useful memory consumed. This memory
waste can easily lead to increased paging to disk, ruining the
application's performance.
</p>
<p>Second, it's possible to create your own memory allocator specially
geared towards small blocks. It can be made a lot faster than the
system's default <code>malloc()</code>, which is designed to deal with a wide variety of block sizes.
</p>
<a name="return3"></a><h4>Fixing a bug</h4> 
<br>
<p>
This is a true story. A major mechanical CAD application stopped
working with Solaris 2.6, but continued to work with Solaris 2.5.1.
Debugging showed that the reason for failure was a call to <code>XOpenDisplay(3X11)</code> that returned <code>NULL</code>. Interposing on that routine revealed that the application was calling <code>XOpenDisplay()</code> with the argument <code>unix:0.0</code> instead of with the usual <code>NULL</code>.
</p>
<p>
The reason it didn't work was a bug in X. It could also be considered a bug in the application, because using <code>unix:0.0</code> for <code>DISPLAY</code> is an old Unix technique which no longer makes sense.
</p>
<p>
In any case, we needed a quick workaround until the bug was fixed. 
</p><p>
</p><p>
The application in question was old and complex. It called <code>XOpenDisplay()</code>
many times from different modules, so even tracking the troublesome
calls was a challenge. The following library interposer was our
solution. Not only did this interposer print out the argument passed to
<code>XOpenDisplay()</code>, it actually changed the <code>XOpenDisplay()</code> argument to <code>NULL</code>, fixing the problem.
</p>
<p>
<a linkid="A-040393-002" href="http://developers.sun.com/solaris/articles/lib_interposers_code.html#XOpenDisplay_interpose.c" target="_blank"><code>XOpenDisplay_interpose.c</code></a> </p>
<h4>More ideas</h4>
<br>
<p>Now that you know how to build and use library interposers, here are some other things you can have them do::</p>
<ul>
<li>Compute the amount of time spent in <code>malloc()</code>, <code>realloc()</code>, and <code>free()</code> routines, and print out the results upon exiting. A good timing routine in Solaris is <code>gethrtime(3C)</code>. Once you have this information, you will know if memory management is causing a performance bottleneck.<br><br></li>
<li>Collect usage statistics for <code>memmove()</code>, <code>memcpy()</code>, and <code>memset()</code> routines, and print out a histogram similar to the one for <code>malloc()</code>.
This will tell you how much data the application is moving around, and
whether or not this area of the program needs optimizing.
<br><br>You can also determine how many backward moves or copies the
application performs. A backward move occurs when the source address is
larger than the destination address. The performance of backward memory
moves is often much worse than that of forward moves.<br><br></li>
<li>Determine what environment variables the application is using. Interpose on <code>getenv(3C)</code>, and print its argument and return value.<br><br></li>
<li>Test a different version of <code>malloc()</code>, or any other
dynamically-linked routine, with your application. All you have to do
is interpose the test version (assuming it's built as a shared
library). To go back to using the original version, simply undefine <code>LD_PRELOAD</code>.</li>
</ul>
<p>
Using the library interposers described in this article, you can
monitor your applications' patterns of system-resource consumption and
provide useful feedback to application developers. </p> 
<!--
<A NAME="malloc_interposer.c"></A><H4>Source Code: malloc_interposer.c</H4>
<PRE>
/* Example of a library interposer: interpose on 
 * malloc().
 * Build and use this interposer as following:
 * cc -o malloc_interposer.so -G -Kpic malloc_interposer.c
 * setenv LD_PRELOAD $cwd/malloc_interposer.so
 * run the app
 * unsetenv LD_PRELOAD
 */

#include <stdio.h>
#include <dlfcn.h>

void *malloc(size_t size)
{
  static void * (*func)();

  if(!func)
    func = (void *(*)()) dlsym(RTLD_NEXT, "malloc");
  printf("malloc(%d) is called\n", size);     
  return(func(size));
}
</PRE>
<P><A linkID="A-040393-003" href="lib_interposers.html#return1">Return</A></P>
<H4><A NAME="malloc_hist.c"></A>Source Code: malloc_hist.c</H4>
<PRE>
/* Library interposer to collect malloc/calloc/realloc 
 * statistics
 * and produce a histogram of their use.
 * cc -o malloc_hist.so -G -Kpic malloc_hist.c
 * setenv LD_PRELOAD $cwd/malloc_hist.so
 * run the application
 * unsetenv LD_PRELOAD
 *
 * The results will be in 
 * /tmp/malloc_histogram.&lt;prog_name&gt;.&lt;pid&gt;
 * for each process invoked by current application.
 */
#include &lt;dlfcn.h&gt;
#include &lt;memory.h&gt;
#include &lt;assert.h&gt;
#include &lt;thread.h&gt;
#include &lt;stdio.h&gt;
#include &lt;procfs.h&gt;
#include &lt;fcntl.h&gt;

typedef struct data {
  int histogram[32];
  char * caller;
} data_t;

data_t mdata = { 
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0, 
  "malloc"};

data_t cdata = { 
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0, 
  "calloc"};

data_t rdata = { 
0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,
0,0,0,0,0, 
  "realloc"};

static FILE* output;
static int pid;
static char prog_name[32];
static char path[64];

static void done()
{
  fprintf(output, "prog_name=%s\n", prog_name);
  print_data(&mdata);
  print_data(&cdata);
  print_data(&rdata);
}

static int print_data(data_t * ptr)
{
  int i;

  fprintf(output, "******** %s **********\n", 
    ptr-&gt;caller);
  for(i=0;i&lt;32;i++)
      if(i &lt; 10 || ptr-&gt;histogram[i])
    fprintf(output, "%10u\t%10d\n", 1&lt;&lt;i, 
    ptr-&gt;histogram[i]);
}

exit(int status)
{
  char procbuf[32];
  psinfo_t psbuf;
  int fd;

  /* Get current executable's name using proc(4) 
     interface */
  pid = (int)getpid();
  (void)sprintf(procbuf, "/proc/%ld/psinfo", (long)pid);
  if ((fd = open(procbuf, O_RDONLY)) != -1)
  {
    if (read(fd, &psbuf, sizeof(psbuf)) == sizeof(psbuf))
      sprintf(prog_name, "%s.%d", psbuf.pr_fname, pid);
    else
      sprintf(prog_name, "%s.%d", "unknown", pid);
  }
  else
    sprintf(prog_name, "%s.%d", "unknown", pid);
  sprintf(path, "%s%s", "/tmp/malloc_histogram.", 
  prog_name);

  /* Open the file here since
     the shell closes all file descriptors 
     before calling exit() */
  output = fopen(path, "w");
  if(output)
      done();
  (*((void (*)())dlsym(RTLD_NEXT, "exit")))(status);
}

static int bump_counter(data_t * ptr, int size)
{
  static mutex_t lock;
  int size_orig;
  int i = 0;

  size_orig = size;
  while(size /= 2)
      i++;
  if(1&lt;&lt;i &lt; size_orig)
      i++;

  /* protect histogram data if application is 
     multithreaded */  
  mutex_lock(&lock);
  ptr-&gt;histogram[i]++;
  mutex_unlock(&lock);
}


void * malloc(size_t size)
{
  static void * (*func)();
  void * ret;

  if(!func) {
    func = (void *(*)()) dlsym(RTLD_NEXT, "malloc");
  }

  ret = func(size);

  bump_counter(&mdata, size);
  
  return(ret);
}

void * calloc(size_t nelem, size_t elsize)
{
  static void * (*func)();
  void * ret;
  int i;

  if(!func)
    func = (void *(*)()) dlsym(RTLD_NEXT, "calloc");

  ret = func(nelem, elsize);

  for(i=0;i&lt;nelem;i++)
      bump_counter(&cdata, elsize);
  
  return(ret);
}

void * realloc(void *ptr, size_t size)
{
  static void * (*func)();
  void * ret;

  if(!func)
    func = (void *(*)()) dlsym(RTLD_NEXT, "realloc");

  ret = func(ptr, size);
  bump_counter(&rdata, size);
  
  return(ret);

}
</PRE>
<P><A linkID="A-040393-004" href="lib_interposers.html#return2">Return</A></P>
<A NAME="XOpenDisplay_interpose.c"></A><H4>Source Code: XOpenDisplay_interpose.c</H4>
<PRE>
/*
 * Library interposer for XOpenDisplay() and XCloseDisplay.
 * cc -g -o XOpenDisplay_interpose.so -G -Kpic 
 * XOpenDisplay_interpose.c
 * setenv LD_PRELOAD $cwd/XOpenDisplay_interpose.so
 * run the app
 * unsetenv LD_PRELOAD
 */

#include <stdio.h>
#include <X11/Xlib.h>
#include <dlfcn.h>

Display *XOpenDisplay(char *display_name)
{
  static Display * (*func)(char *);
  Display *ret;
 
  if(!func)
    func = (Display *(*)(char *))dlsym(RTLD_NEXT, 
    "XOpenDisplay");

  if(display_name)
    printf("XOpenDisplay() is called with 
    display_name=%s\n", display_name);
  else
    printf("XOpenDisplay() is called with 
    display_name=NULL\n");
/*
  ret = func(display_name);
*/
  printf("  calling XOpenDisplay(NULL)\n");
  ret = func(0);
  printf("XOpenDisplay() returned %p\n", ret);

  return(ret);
}

int XCloseDisplay(Display *display_name)
{ 
  static int (*func)(Display *); 
  int ret; 
  
  if(!func)
    func = (int (*)(Display *))dlsym(RTLD_NEXT, 
    "XCloseDisplay"); 
 
  ret = func(display_name); 
 
  printf("called XCloseDisplay(%p)\n", display_name); 
 
  return(ret); 
}
</PRE>
<A linkID="A-040393-005" href="lib_interposers.html#return3">Return</A>
<P>
<A linkID="A-040393-006" href="/solaris/developer/support/driver/tools/SUNWtnftl/tnf-reg.html">Register and download the tools</A>.</P>
-->
<h4>Acknowledgements</h4>
<br>
<p>
I'd like to thank two of my colleagues at Sun Microsystems: Bart
Smaalders, who wrote the original version of the interposer to collect <code>malloc</code> statistics, and Morgan Herrington, who generously helped in many ways.
</p>
<a name="author"></a><h5>About the author</h5>
<br>
<p>
Greg Nakhimovsky is a member of technical staff at Sun Microsystems. He
works with independent software vendors, making sure their applications
run well on Sun systems. He has 20 years of industry experience,
developing, performance tuning, and supporting technical computer
applications on various computer systems.
</p>  
<!-- BEGIN RATE AND REVIEW G16 var1 -->
<script type="text/javascript">
<!-- Hide script from older browsers
// Popup window function
function onRateSubmitHandler()
{
var w = window.open("","rr","width=800,height=600,status=no,toolbar=no,scrollbars=yes"); 
w.setTimeout("window.close();", 30000 );
return true;
}
// End of javascript 
-->
</script>
<form name="form" method="post" action="https://www2.sun.de/dc/servlets/incoming" onsubmit="return onRateSubmitHandler()" target="rr">
<input name="errcount" value="1" type="hidden">
<input name="ref" value="http://www2.sun.de/dc/forms/reg_xh_2610_243.jsp" type="hidden">
<input name="" value="" type="hidden">
<table class="dkgrey" style="margin-top: 7px;" border="0" cellpadding="1" cellspacing="0" width="100%"><tbody><tr><td>
<table class="white" border="0" cellpadding="4" cellspacing="0" width="100%">
<tbody><tr><td class="dkgrey1"><b>Rate and Review</b></td></tr>
<tr><td>Tell us what you think of the content of this page.</td></tr>
<tr><td><b>
<input name="custom_3" value="Excellent" type="radio"> Excellent  
<input name="custom_3" value="Good" type="radio"> Good  
<input name="custom_3" value="Fair" type="radio"> Fair  
<input name="custom_3" value="Poor" type="radio"> Poor  
</b></td></tr>
<tr><td>
<b>Comments:</b><br><textarea name="custom_2" cols="60" rows="3" wrap="virtual"></textarea></td></tr>
<tr><td>
<b>Your email address (no reply is possible without an address):</b><br>
<a href="http://sun.com/privacy/" target="_new">Sun Privacy Policy</a><br>
<input name="custom_1" value="" size="35" maxlength="60" type="text"> <br>
Note: We are not able to respond to all submitted comments.</td></tr>
<tr><td>
<input class="buttonblue" value=" Submit » " onmouseover="this.style.color='#fbe249';" onmouseout="this.style.color='#FFF';" type="submit" border="0">
<input name="custom_0" value="Greg Nakhimovsky" type="hidden">
<input name="custom_4" value="Debugging and Performance Tuning with Library Interposers" type="hidden">
<input name="custom_5" value="http://developers.sun.com/solaris/articles/solaris/articles/lib_interposers.html" type="hidden">
<input name="cf_Form_Name" value="Rate and Review - article feedback" type="hidden">
<input name="cf_Form_Location" value="Registrations" type="hidden">
<input name="cf_iso2" value="XH" type="hidden">
<input name="charset" value="ISO-8859-1" type="hidden">
</td></tr></tbody></table></td></tr>
</tbody></table></form>
<!-- END RATE AND REVIEW G16 var1-->
<!-- =================== -->
<!-- END OF MAIN CONTENT -->
<!-- =================== -->
<!--stopindex-->
<!-- END CENTRAL COLUMN COMPONENTS -->
</td><td valign="top">
<!-- BEGIN RIGHT COLUMN COMPONENTS -->
<!-- END RIGHT COLUMN COMPONENTS -->
</td></tr>
<!-- BEGIN SPACER ROW -->
<tr><td><img src="lib_interposers%20Files/a.gif" alt=" " border="0" width="560" height="1"></td><td><img src="lib_interposers%20Files/a.gif" alt=" " border="0" width="170" height="1"></td></tr>
<!-- END SPACER ROW -->
</tbody></table>
<!-- END WRAPPER TABLE, 2 COLUMN, MAIN/RIGHT -->
<!-- BEGIN VNV5 FOOTER  -->
<table border="0" cellpadding="0" cellspacing="10" width="100%">
<tbody><tr>
<td>
<table class="vatop" border="0" cellpadding="0" cellspacing="0" width="100%">
<tbody><tr>
<td colspan="4" class="grey3" valign="top"><img src="lib_interposers%20Files/a.gif" alt="" border="0" width="1" height="2"></td></tr>
<tr>
<td><img src="lib_interposers%20Files/a.gif" alt="" border="0" width="190" height="1"><br>
<a href="http://www.sun.com/"><img src="lib_interposers%20Files/logo_sun_small_sdn.gif" alt="" border="0" vspace="5" width="61" height="29"></a></td>
<td valign="top" width="100%"><img src="lib_interposers%20Files/a.gif" alt="" border="0" width="350" height="1"><br>
<div class="footer">
<a href="http://developers.sun.com/global/aboutsun.html">About Sun</a>  | 
<a href="http://developers.sun.com/global/aboutsdn.html">About This Site</a>  | 
<a href="http://developers.sun.com/global/newsletters.html">Newsletters</a>  | 
<a href="http://developers.sun.com/global/contact.html">Contact Us</a>  | 
<a href="http://developers.sun.com/global/employment.html">Employment</a><br>
<a href="http://developers.sun.com/global/howtobuy.html">How to Buy</a>  | 
<a href="http://developers.sun.com/global/licensing.html">Licensing</a>  | 
<a href="http://developers.sun.com/global/termsofuse.html">Terms of Use</a>  | 
<a href="http://developers.sun.com/global/privacy.html">Privacy</a>  | 
<a href="http://developers.sun.com/global/trademarks.html">Trademarks</a>
<br><span class="sp10"> </span><br>
<br><span class="sp10"> </span><br>
Copyright <span id="copyDate" class="cssDate">1994-2008 </span> Sun Microsystems, Inc.
</div></td>
<td><img src="lib_interposers%20Files/a.gif" alt="" border="0" width="40" height="1"></td>
<td valign="top"><div class="footer"><b><a href="http://developers.sun.com/global/aboutsdn.html">A Sun Developer Network Site</a></b></div>
<div class="footer">
<img src="lib_interposers%20Files/a.gif" alt="" border="0" width="170" height="1"><br>
Unless otherwise licensed, code in all technical manuals herein (including articles, FAQs, samples) is provided under this <a href="http://developers.sun.com/global/berkeley_license.html">License</a>.
<br><span class="sp5"> </span><br>
<a href="http://developers.sun.com/global/rss_sdn.html"><img src="lib_interposers%20Files/ic_feed_16x.gif" alt="XML" align="top" border="0" width="16" height="16"></a> <a href="http://developers.sun.com/global/content_feeds.html">Sun Developer RSS Feeds</a>
</div></td></tr>
<tr><td colspan="4" class="grey3" valign="top"><img src="lib_interposers%20Files/a.gif" alt="" border="0" width="1" height="2"></td></tr>
</tbody></table>
</td></tr>
</tbody></table>
<!-- END VNV5 FOOTER -->
<script language="JavaScript" src="lib_interposers%20Files/s_code_remote.js"></script><script language="JavaScript" src="lib_interposers%20Files/metrics_group1.js"></script></body></html>